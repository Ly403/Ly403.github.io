<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en"><generator uri="https://jekyllrb.com/" version="4.4.1">Jekyll</generator><link href="https://ly403.github.io/feed.xml" rel="self" type="application/atom+xml"/><link href="https://ly403.github.io/" rel="alternate" type="text/html" hreflang="en"/><updated>2025-04-16T11:52:12+00:00</updated><id>https://ly403.github.io/feed.xml</id><title type="html">Yi Liuâ€™s Homepage. ğŸ˜€</title><subtitle>A simple, whitespace theme for academics. Based on [*folio](https://github.com/bogoli/-folio) design. </subtitle><entry><title type="html">ç¦»æ•£å‹æµåŒ¹é…æ¨¡å‹ï¼ˆ3ï¼‰</title><link href="https://ly403.github.io/blog/2025/%E7%A6%BB%E6%95%A3%E6%B5%81%E5%8C%B9%E9%85%8D%E6%A8%A1%E5%9E%8B-3/" rel="alternate" type="text/html" title="ç¦»æ•£å‹æµåŒ¹é…æ¨¡å‹ï¼ˆ3ï¼‰"/><published>2025-01-20T00:00:00+00:00</published><updated>2025-01-20T00:00:00+00:00</updated><id>https://ly403.github.io/blog/2025/%E7%A6%BB%E6%95%A3%E6%B5%81%E5%8C%B9%E9%85%8D%E6%A8%A1%E5%9E%8B%EF%BC%883%EF%BC%89</id><content type="html" xml:base="https://ly403.github.io/blog/2025/%E7%A6%BB%E6%95%A3%E6%B5%81%E5%8C%B9%E9%85%8D%E6%A8%A1%E5%9E%8B-3/"><![CDATA[<p>æ¥ç€ä¸Šæ¬¡è¯´çš„DFMçš„åˆ†è§£æŠ€å·§ï¼Œç»§ç»­å­¦ä¹ DFMçš„æœ€åä¸€éƒ¨åˆ†â€”â€”æ··åˆè·¯å¾„ï¼ˆMixture pathsï¼‰ã€‚</p> <h2 id="æ··åˆè·¯å¾„mixture-paths">æ··åˆè·¯å¾„ï¼ˆMixture pathsï¼‰</h2> <p>æˆ‘ä»¬åœ¨æ­¤å‰çš„æ–‡ç« é‡Œé¢å·²ç»è®²è§£äº†åˆ†è§£æŠ€å·§<sup id="fnref:1"><a href="#fn:1" class="footnote" rel="footnote" role="doc-noteref">1</a></sup>ï¼Œå¾—åˆ°äº†åˆ†è§£çš„ï¼ˆè¾¹ç¼˜/æ¡ä»¶ï¼‰æ¦‚ç‡è·¯å¾„ã€åˆ†è§£çš„ï¼ˆè¾¹ç¼˜/æ¡ä»¶ï¼‰é€Ÿç‡ï¼Œä»¥åŠçŸ¥é“äº†ä»–ä»¬ä¹‹é—´çš„å…³ç³»ï¼ˆ<sup id="fnref:1:1"><a href="#fn:1" class="footnote" rel="footnote" role="doc-noteref">1</a></sup>ä¸­çš„å‘½é¢˜2å’Œå®šç†16ï¼‰ã€‚ç°åœ¨æˆ‘ä»¬è¦ç€æ‰‹è®¾è®¡å‡ºä¸€ä¸ªå…·ä½“çš„DFMäº†ï¼Œç±»ä¼¼FM<sup id="fnref:2"><a href="#fn:2" class="footnote" rel="footnote" role="doc-noteref">2</a></sup>ä¸€æ ·ï¼Œ<strong>æˆ‘ä»¬å¯ä»¥ä»åˆ†è§£æ¡ä»¶æ¦‚ç‡è·¯å¾„ç€æ‰‹ï¼Œç„¶åå¾—åˆ°ç›®æ ‡åˆ†è§£æ¡ä»¶é€Ÿç‡ï¼Œä½¿ç”¨ç¥ç»ç½‘ç»œé¢„æµ‹åˆ†è§£æ¡ä»¶é€Ÿç‡ï¼Œæœ€åä½¿ç”¨åˆ†è§£CDFMæŸå¤±ï¼ˆ<sup id="fnref:1:2"><a href="#fn:1" class="footnote" rel="footnote" role="doc-noteref">1</a></sup>ä¸­å…¬å¼14ï¼‰æ¥è®­ç»ƒæ¨¡å‹ã€‚</strong></p> <p>æˆ‘ä»¬ä»¥$Z=(X_0,X_1) \sim \pi_{0,1}(X_0,X_1)$ä¸ºæ¡ä»¶ï¼ˆ$X_0$å’Œ$X_1$ä¸ºä»»æ„é…å¯¹ï¼‰ï¼Œé‚£ä¹ˆåˆ†è§£çš„æ¡ä»¶æ¦‚ç‡è·¯å¾„å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å½¢å¼ï¼š</p> \[p_{t\mid 0,1}^i (x^i\mid x_0,x_1)=\kappa_t\delta(x^i,x_1^i) + (1-\kappa_t)\delta(x^i,x_0^i) \tag{1}\] <p>è¿™ä¸ªåšæ³•ç±»ä¼¼Rectified Flowï¼ˆ<sup id="fnref:3"><a href="#fn:3" class="footnote" rel="footnote" role="doc-noteref">3</a></sup>ä¸­å…¬å¼1ï¼‰ï¼Œåªæ˜¯ä½¿ç”¨äº†æ›´generalçš„$\kappa_t$ä½œä¸ºç³»æ•°ï¼Œ$\kappa : [0,1] \to [0,1]$å°±ç±»ä¼¼æ‰©æ•£æ¨¡å‹é‡Œé¢çš„å™ªå£°è°ƒåº¦å™¨ï¼Œ$\kappa_t \in C^1([0,1])$ã€‚æ ¹æ®<sup id="fnref:1:3"><a href="#fn:1" class="footnote" rel="footnote" role="doc-noteref">1</a></sup>ä¸­å…¬å¼6ï¼Œæˆ‘ä»¬èƒ½å¾—åˆ°éåˆ†è§£çš„æ¡ä»¶æ¦‚ç‡è·¯å¾„ï¼š</p> \[p_{t\mid 0,1} (x\mid x_0,x_1)=\prod_i p_{t\mid 0,1}^i (x^i\mid x_0,x_1) \tag{2}\] <blockquote> <p>å…³äºå…¬å¼1çš„è¯¦ç»†è§£é‡Šï¼š</p> <p>åˆ†è§£æ¦‚ç‡è·¯å¾„ä¸Šçš„éšæœºå˜é‡$X_t^i \sim p_{t\mid 0,1}^i(\cdot\mid x_0,x_1) $æ»¡è¶³ï¼š</p> \[X_t^i = \begin{cases} x_1^i \quad æ¦‚ç‡ä¸º\kappa_t\\ x_0^i \quad æ¦‚ç‡ä¸º(1-\kappa_t) \end{cases} \tag{3}\] <p>ä¹Ÿå°±æ˜¯å¯¹$t$æ—¶åˆ»çš„ç¬¬$i$ä¸ªtoken $X_t^i$ï¼Œå®ƒè¦ä¹ˆå–æºçŠ¶æ€çš„å€¼$x_0^i$ï¼Œè¦ä¹ˆå–ç›®æ ‡çŠ¶æ€çš„å€¼$x_1^i$ï¼Œå–è¿™ä¸¤ä¸ªå€¼çš„æ¦‚ç‡ä¸æ—¶é—´$t$ç›¸å…³ã€‚</p> </blockquote> <p>ä»å…¬å¼1å’Œ2ç»™å‡ºçš„æ¡ä»¶æ¦‚ç‡è·¯å¾„å¯ä»¥ç®—å‡ºè¾¹ç¼˜æ¦‚ç‡è·¯å¾„ï¼Œå³ï¼š</p> \[p_t(x)=\sum_{x_0,x_1}p_{t\mid 0,1}(x\mid x_0,x_1) p_{0,1}(x_0,x_1) \tag{4}\] <p>éœ€è¦æŒ‡å‡ºçš„æ˜¯ï¼Œ<strong>$p_t(x)$éœ€è¦æ»¡è¶³è¾¹ç¼˜æ¡ä»¶ï¼Œå³$p_0(x) = \delta(x,x_0)$ï¼Œ$p_1(x) = \delta(x,x_1)$ã€‚ä¸ºå®ç°è¿™ä¸ªæ¡ä»¶ï¼Œéœ€è¦è®©$\kappa_0 = 0$ï¼Œ$\kappa_1 = 1$ã€‚</strong></p> <p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“å…¬å¼1æ‰€ç¤ºåˆ†è§£æ¡ä»¶æ¦‚ç‡è·¯å¾„å¯¹åº”çš„åˆ†è§£æ¡ä»¶é€Ÿç‡$u_t^i(y^i,x^i\mid x_0,x_1)$ã€‚ç”±Kolmogorovæ–¹ç¨‹å¯çŸ¥ï¼š</p> \[\cfrac{\mathrm{d}}{\mathrm{d}t}p_{t\mid 0,1}^i(y^i\mid x_0,x_1) = \sum_{x^i}u_t^i(y^i,x^i\mid x_0,x_1)p_{t\mid 0,1}^i(x^i\mid x_0,x_1) \tag{5}\] <p>ç»“åˆå…¬å¼1ç»™å‡ºçš„å…·ä½“åˆ†è§£æ¡ä»¶æ¦‚ç‡è·¯å¾„ï¼Œå¯ä»¥ç®—å‡ºï¼š</p> \[\begin{aligned} \cfrac{\mathrm{d}}{\mathrm{d}t}p_{t\mid 0,1}^i(y^i\mid x_0,x_1)&amp; \overset{å…¬å¼1}{=} \dot \kappa_t\left[\delta(y^i,x_1^i) - \delta(y^i,x_0^i)\right] \\ &amp;\overset{ç”¨å…¬å¼1æ¶ˆå»\delta(y^i,x_0^i)}{=} \dot \kappa_t\left[\delta(y^i,x_1^i) - \cfrac{p^i_{t\mid 0,1}(y^i\mid x_0,x_1)-\kappa_t\delta(y^i,x_1^i)}{1-\kappa_t}\right]\\ &amp;{=} \cfrac{\dot \kappa_t}{1 - \kappa_t}\left[({1-\kappa_t})\delta(y^i,x_1^i) - {p^i_{t\mid 0,1}(y^i\mid x_0,x_1)+\kappa_t\delta(y^i,x_1^i)}\right]\\ &amp;{=} \cfrac{\dot \kappa_t}{1 - \kappa_t} \left[ \delta(y^i,x_1^i) - p^i_{t\mid 0,1}(y^i\mid x_0,x_1) \right]\\ &amp;\overset{(*)}{=}\sum_{x^i} \cfrac{\dot \kappa_t}{1 - \kappa_t} \left[ \delta(y^i,x_1^i) - \delta(y^i,x^i) \right] p^i_{t\mid 0,1}(x^i\mid x_0,x_1)\\ \end{aligned}\tag{6}\] <blockquote> <p>å…³äºï¼ˆ*ï¼‰æ­¥çš„è§£é‡Šå¦‚ä¸‹ï¼š</p> <p>è¿™é‡Œå…¶å®å°±æ˜¯è¦è¯æ˜</p> \[\delta(y^i,x_1^i) - p^i_{t\mid 0,1}(y^i\mid x_0,x_1) = \sum_{x^i} \left[ \delta(y^i,x_1^i) - \delta(y^i,x^i) \right] p^i_{t\mid 0,1}(x^i\mid x_0,x_1) \tag{7}\] <p>æˆ‘ä»¬ä»å³è¾¹å¼€å§‹å˜æ¢ï¼š</p> \[\begin{aligned} \sum_{x^i} \left[ \delta(y^i,x_1^i) - \delta(y^i,x^i) \right] p^i_{t\mid 0,1}(x^i\mid x_0,x_1) &amp;= \sum_{x^i} \left[ \delta(y^i,x_1^i)p^i_{t\mid 0,1}(x^i\mid x_0,x_1) - \delta(y^i,x^i)p^i_{t\mid 0,1}(x^i\mid x_0,x_1) \right]\\ &amp;= \sum_{x^i} \delta(y^i,x_1^i)p^i_{t\mid 0,1}(x^i\mid x_0,x_1) - \sum_{x^i} \delta(y^i,x^i)p^i_{t\mid 0,1}(x^i\mid x_0,x_1) \\ &amp;\overset{(1)}{=} \sum_{x^i} \delta(y^i,x_1^i)p^i_{t\mid 0,1}(x^i\mid x_0,x_1) - p^i_{t\mid 0,1}(y^i\mid x_0,x_1) \\ &amp;\overset{(2)}{=} \delta(y^i,x_1^i) - p^i_{t\mid 0,1}(y^i\mid x_0,x_1) \\ \end{aligned} \tag{8}\] <p>ç¬¬ï¼ˆ1ï¼‰æ­¥æ˜¯deltaå‡½æ•°çš„æ€§è´¨ï¼Œ$\int_x\delta(y,x)f(x)\mathrm{d}x = f(y)$ï¼Œç¬¬ï¼ˆ2ï¼‰æ­¥æ˜¯å› ä¸º$\delta(y^i,x_1^i)$ä¸$x^i$æ— å…³ï¼Œ$\sum_{x^i} p^i_{t\mid 0,1}(x^i\mid x_0,x_1) = 1 $ã€‚</p> </blockquote> <p>å¯¹æ¯”å…¬å¼6çš„æœ€åç»“æœå’Œå…¬å¼5ï¼Œå°±çŸ¥é“ï¼š</p> \[u_t^i(y^i,x^i\mid x_0,x_1) = \cfrac{\dot \kappa_t}{1 - \kappa_t} \left[ \delta(y^i,x_1^i) - \delta(y^i,x^i) \right] \tag{9}\] <p>è¿™æ ·æˆ‘ä»¬å°±çŸ¥é“äº†å…¬å¼1æ‰€ç¤ºçš„åˆ†è§£æ¡ä»¶æ¦‚ç‡è·¯å¾„å¯¹åº”çš„åˆ†è§£æ¡ä»¶é€Ÿç‡$u_t^i(y^i,x^i\mid x_0,x_1)$çš„å…·ä½“å½¢å¼äº†ã€‚</p> <p>Code 9æ˜¯æ··åˆè·¯å¾„çš„å®ç°ä»£ç ã€‚</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/post/DFM31-480.webp 480w,/assets/img/post/DFM31-800.webp 800w,/assets/img/post/DFM31-1400.webp 1400w," type="image/webp" sizes="95vw"/> <img src="/assets/img/post/DFM31.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption"> æ··åˆè·¯å¾„çš„å®ç°ä»£ç  </div> <h3 id="é€Ÿç‡åéªŒå‚æ•°åŒ–">é€Ÿç‡åéªŒå‚æ•°åŒ–</h3> <p>ç±»æ¯”æˆ‘ä»¬åœ¨FM<sup id="fnref:2:1"><a href="#fn:2" class="footnote" rel="footnote" role="doc-noteref">2</a></sup>å’Œæ‰©æ•£æ¨¡å‹é‡Œé¢ä¹Ÿä¼šè®²çš„å¤šç§é¢„æµ‹æ–¹å¼ï¼Œä¾‹å¦‚velocity-predictionã€$x_0$-predictionã€$x_1$-predictionï¼Œæˆ‘ä»¬åœ¨DFMé‡Œé¢ä¹Ÿå¯ä»¥ä½¿ç”¨ç±»ä¼¼çš„é¢„æµ‹æ–¹å¼ã€‚</p> <p>æœ€ç®€å•çš„ä¸€ç§ï¼š<strong>ä½¿ç”¨ç¥ç»ç½‘ç»œé¢„æµ‹å…¬å¼9ç»™å‡ºçš„åˆ†è§£æ¡ä»¶é€Ÿç‡$u_t^i(y^i,x^i\mid x_0,x_1)$ï¼Œè¿™å°±æ˜¯velocity-predictionã€‚</strong></p> <p>æ¥ä¸‹æ¥ä»‹ç»DFMé‡Œé¢çš„$x_1$-predictionï¼Œè¿™ä¸ªä¼šç¨å¾®å¤æ‚ä¸€ç‚¹ã€‚</p> <p>æ ¹æ®æˆ‘ä»¬åœ¨<sup id="fnref:1:4"><a href="#fn:1" class="footnote" rel="footnote" role="doc-noteref">1</a></sup>ä¸­è¯æ˜å‡ºæ¥çš„å…¬å¼12ï¼Œå¯ä»¥å¾—åˆ°åœ¨$u_t^i(y^i,x^i\mid x_0,x_1)$å–å…¬å¼9çš„å½¢å¼æ—¶ï¼Œåˆ†è§£è¾¹ç¼˜é€Ÿç‡ä¸ºï¼š</p> \[\begin{aligned} u_t^i(y^i,x) &amp;=\sum_{x_0,x_1} u_t^i(y^i,x^i\mid x_0,x_1)p_{0,1\mid t}(x_0,x_1\mid x)\\ &amp;\overset{å…¬å¼(9)}{=} \sum_{x_0,x_1} \cfrac{\dot \kappa_t}{1 - \kappa_t} \left[ \delta(y^i,x_1^i) - \delta(y^i,x^i) \right] p_{0,1\mid t}(x_0,x_1\mid x)\\ &amp;\overset{å°†x_1^iåˆ†å‡ºæ¥}{=} \sum_{x_1^i}\sum_{x_0,x_1^{\bar i}} \cfrac{\dot \kappa_t}{1 - \kappa_t} \left[ \delta(y^i,x_1^i) - \delta(y^i,x^i) \right] p_{0,1\mid t}(x_0,x_1\mid x)\\ &amp;\overset{åˆ†é…å¾‹}{=} \sum_{x_1^i} \cfrac{\dot \kappa_t}{1 - \kappa_t} \left[ \delta(y^i,x_1^i) - \delta(y^i,x^i) \right]\sum_{x_0,x_1^{\bar i}} p_{0,1\mid t}(x_0,x_1\mid x)\\ \end{aligned} \tag{10}\] <p>å•ç‹¬æŠŠç¬¬äºŒä¸ªæ±‚å’Œå¼æ‹¿å‡ºæ¥ï¼Œè®°ä¸ºï¼š</p> \[p_{1\mid t}^i(x_1^i\mid x) = \sum_{x_0,x_1^{\bar i}} p_{0,1\mid t}(x_0,x_1\mid x) \overset{(*)}{=}\mathbb{E}\left[ \delta(x_1^i,X_1^i) \mid X_t = x \right] \tag{11}\] <blockquote> <p>å…³äºå…¬å¼11ä¸­ï¼ˆ*ï¼‰æ­¥éª¤çš„è¯¦ç»†è¯´æ˜ï¼š</p> \[\begin{aligned} p_{1\mid t}^i(x_1^i\mid x) &amp;= \sum_{x_0,x_1^{\bar i}} p_{0,1\mid t}(x_0,x_1\mid x)\\ &amp;\overset{æ‹†å¼€x_1}{=} \sum_{x_0,x_1^{\bar i}} p_{0,1\mid t}(x_0,x_1^{\bar i},x_1^i\mid x)\\ &amp;\overset{\deltaå‡½æ•°çš„æ€§è´¨}{=} \sum_{x_0,x_1^{\bar i}}\sum_{X_1^i}\delta(x_1^i,X_1^i) p_{0,1\mid t}(x_0,x_1^{\bar i},X_1^i\mid x)\\ &amp;=\mathbb{E}\left[ \delta(x_1^i,X_1^i) \mid X_t = x \right] \end{aligned} \tag{12}\] </blockquote> <p>æˆ‘ä»¬å¯ä»¥ç”¨ç¥ç»ç½‘ç»œå»å­¦ä¹ åéªŒåˆ†å¸ƒ$p_{1\mid t}^{\theta,i}(x_1^i\mid x)$ï¼Œ$\theta$ä¸ºç¥ç»ç½‘ç»œçš„å‚æ•°ã€‚è¿™å°±æ˜¯ç¦»æ•£ç‰ˆçš„$x_1$-predictionã€‚</p> <p>è¿™æ ·ç†è§£ï¼šä»¥æ–‡æœ¬ä¸ºä¾‹ï¼Œ<strong>$x$æ˜¯æ—¶é—´$t$æ—¶çš„â€œåŠ å™ªâ€æ–‡æœ¬ï¼ˆä½†å…¶å®è¯´â€œåŠ å™ªâ€œä¸å‡†ç¡®ï¼Œå› ä¸ºDFMçš„åˆå§‹çŠ¶æ€$x_0$æ˜¯ä¸€ä¸ªå…¨maskçš„æ–‡æœ¬ï¼Œ$x$æ›´ç±»ä¼¼ä¸€ä¸ªå¤„äºä¸­é—´çŠ¶æ€çš„æ–‡æœ¬ï¼‰ã€‚$x$ä½œä¸ºç¥ç»ç½‘ç»œçš„è¾“å…¥ï¼Œç¥ç»ç½‘ç»œé¢„æµ‹$x_1^i$ï¼Œ$i\in [d]$è¡¨ç¤ºè¿™æ˜¯$x_1$çš„ç¬¬$i$ä¸ªtokenï¼Œ$d$ä¸ºå¥é•¿ã€‚ç¥ç»ç½‘ç»œä¸€æ¬¡é¢„æµ‹æ‰€æœ‰tokençš„å•æ­¥å˜åŒ–æ¦‚ç‡ï¼Œæ¯ä¸ªtokenå…±æœ‰$K$ç§å˜åŒ–æƒ…å†µï¼ˆ$K$ä¸ºvocabularyçš„å¤§å°ï¼‰ï¼Œç¥ç»ç½‘ç»œçš„è¾“å‡ºå‘é‡çš„ç»´åº¦å°±æ˜¯$d\cdot K$ã€‚</strong></p> <h3 id="æ··åˆè·¯å¾„çš„cdfmæŸå¤±">æ··åˆè·¯å¾„çš„CDFMæŸå¤±</h3> <p>æˆ‘ä»¬åŸºäº$x_1$-predictionï¼Œå³é¢„æµ‹$p_{1\mid t}^{\theta,i}(x_1^i\mid x)$ï¼Œç»§ç»­è®¨è®ºå…¬å¼1æ‰€ç¤ºæ··åˆè·¯å¾„æƒ…å†µä¸‹çš„CDFMæŸå¤±ã€‚è¿™é‡Œä¼šæœ‰ä¸¤ç§åšæ³•ã€‚</p> <p>ç»“åˆå…¬å¼11ï¼Œå¦‚æœç›´æ¥å¯¹æ¯”åéªŒæ¦‚ç‡ï¼Œåˆ™CDFMæŸå¤±å¯ä»¥å†™ä¸ºï¼š</p> \[L_{CDFM}(\theta) = \mathbb{E}_{t,X_0,X_1,X_t} D_{X_t}\left( \delta(\cdot,X_1^i),p_{1\mid t}^{\theta,i}(\cdot\mid X_t) \right) \tag{13}\] <p>$\delta(\cdot,X_1^i)$ï¼Œ$p_{1\mid t}^{\theta,i}(\cdot\mid X_t)$éƒ½æ˜¯æ¦‚ç‡è´¨é‡å‡½æ•°ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨KLæ•£åº¦è¡¡é‡äºŒè€…ä¹‹é—´çš„è·ç¦»ï¼Œå³å–Bregmanæ•£åº¦ä¸ºKLæ•£åº¦ï¼Œå¾—åˆ°ï¼š</p> \[L_{CDFM}(\theta) = - \mathbb{E}_{t,X_0,X_1,X_t} \log p_{1\mid t}^{\theta,i}(X_1^i\mid X_t) + \text{const} \tag{14}\] <p>è¿™æ˜¯ç¬¬ä¸€ç§åšæ³•ã€‚</p> <blockquote> <p>å…³äºå…¬å¼14çš„è¯¦ç»†è¯´æ˜ï¼š</p> <p>KLæ•£åº¦çš„å…¬å¼æ˜¯ï¼š$D(p,q)=\sum_{\alpha \in \mathcal{T}}p(\alpha)\log\cfrac{p(\alpha)}{q(\alpha)}$ã€‚åœ¨é€‰æ‹©KLæ•£åº¦ä¸ºBregmanæ•£åº¦åï¼Œå…¬å¼13å¯ä»¥åŒ–ä¸ºï¼š</p> \[\begin{aligned} L_{CDFM}(\theta) &amp;= \mathbb{E}_{t,X_0,X_1,X_t} \sum_{X_1^i} \delta(x_1^i,X_1^i) \log\cfrac{\delta(x_1^i,X_1^i)}{p_{1\mid t}^{\theta,i}( X_1^i\mid X_t)}\\ &amp;=\mathbb{E}_{t,X_0,X_1,X_t} \sum_{X_1^i}\left[ \delta(x_1^i,X_1^i) \log{\delta(x_1^i,X_1^i)} - \delta(x_1^i,X_1^i) \log{p_{1\mid t}^{\theta,i}( X_1^i\mid X_t)}\right]\\ &amp;= \text{const} - \mathbb{E}_{t,X_0,X_1,X_t} \sum_{X_1^i}\delta(x_1^i,X_1^i) \log{p_{1\mid t}^{\theta,i}( X_1^i\mid X_t)}\\ &amp;\overset{\deltaå‡½æ•°çš„æ€§è´¨}{=} \text{const} - \mathbb{E}_{t,X_0,X_1,X_t} \log{p_{1\mid t}^{\theta,i}(x_1^i\mid X_t)} \end{aligned} \tag{15}\] </blockquote> <p>ç¬¬äºŒç§åšæ³•æ˜¯ä½¿ç”¨<sup id="fnref:1:5"><a href="#fn:1" class="footnote" rel="footnote" role="doc-noteref">1</a></sup>ä¸­å…¬å¼14æ‰€ç¤ºçš„åˆ†è§£CDFMæŸå¤±ï¼Œå¦‚ä¸‹ï¼š</p> \[L_{CDFM}(\theta) = \mathbb{E}_{t,Z,X_t\sim p_{t\mid Z}} \sum_i D_{X_t}^i \left( u_t^i(\cdot,X_t \mid Z), u_t^{\theta,i}(\cdot, X_t) \right) \tag{16}\] <p>å–$Z=(X_0,X_1)$ã€‚ä½¿ç”¨è¯¥å…¬å¼éœ€è¦çŸ¥é“$u_t^{\theta,i}$ï¼Œå› ä¸ºç¥ç»ç½‘ç»œé¢„æµ‹äº†$p_{1\mid t}^{\theta,i}$ï¼Œæ‰€ä»¥$u_t^{\theta,i}$æ˜¯èƒ½ç®—å‡ºæ¥çš„ã€‚</p> <p>å…¬å¼16ä¸­çš„Bregmanæ•£åº¦å¯ä»¥é€‰æ‹©å¹¿ä¹‰çš„KLæŸå¤±ï¼ˆå…¶è¾“å…¥ä¸ä¸€å®šè¦æ˜¯æ¦‚ç‡åˆ†å¸ƒï¼‰ã€‚å…·ä½“è€Œè¨€ï¼Œå¯¹äºå‘é‡$u,v\in \mathbb R_{\ge 0}^{m}$ï¼Œå¹¿ä¹‰KLæŸå¤±æ˜¯ï¼š</p> \[D(u,v) = \sum_j u^j \log \cfrac{u^j}{v^j} - \sum_j u_j + \sum_jv_j \tag{17}\] <p>è¿™ç§é€‰æ‹©ä¸‹å¯¹åº”çš„Bregmanæ•£åº¦ä¸ºï¼š</p> \[D\left(u_t^i(\cdot,x^i\mid x_0,x_1),u^{i,\theta}_t(\cdot,x)\right)= \cfrac{\dot \kappa_t}{1-\kappa_t}\left[ \left(\delta(x_1^i,x^i) - 1\right)\log p_{1\mid t}^{i,\theta}(x_1^i\mid x) + \delta(x_1^i,x^i)- p_{1\mid t}^{i,\theta}(x^i\mid x) \right] \tag{18}\] <h3 id="æ··åˆè½¨è¿¹é‡‡æ ·">æ··åˆè½¨è¿¹é‡‡æ ·</h3> <p>æˆ‘ä»¬åœ¨<sup id="fnref:1:6"><a href="#fn:1" class="footnote" rel="footnote" role="doc-noteref">1</a></sup>ä¸­çš„å…¬å¼5å·²ç»ç»™å‡ºper coordinateçš„é‡‡æ ·æ–¹å¼ï¼Œç»“åˆå‰é¢è®¨è®ºçš„æ··åˆè·¯å¾„ï¼Œé‡‡æ ·å…¬å¼å¯ä»¥å†™ä¸ºï¼š</p> \[\mathbb{P}(X^i_{t+h}=y^i\mid X_t = x) =\delta(y^i,x^i) + h u_t^i(y^i,x) +o(h) \tag{19}\] <p>åœ¨æ··åˆè·¯å¾„çš„ç‰¹å®šæƒ…å†µä¸‹ä¸ºï¼š</p> \[\begin{aligned} \mathbb{P}(X^i_{t+h}=y^i\mid X_t = x) &amp;\overset{å…¬å¼10}{=} \delta(y^i,x^i) + o(h) + h \sum_{x_1^i} \cfrac{\dot \kappa_t}{1 - \kappa_t} \left[ \delta(y^i,x_1^i) - \delta(y^i,x^i) \right]\sum_{x_0,x_1^{\bar i}} p_{0,1\mid t}(x_0,x_1\mid x)\\ &amp;\overset{å…¬å¼11}{=} \delta(y^i,x^i) + o(h) + h \sum_{x_1^i} \cfrac{\dot \kappa_t}{1 - \kappa_t} \left[ \delta(y^i,x_1^i) - \delta(y^i,x^i) \right] p_{1\mid t}^i(x_1^i\mid x)\\ &amp;\overset{\sum_{x_1^i}p_{1\mid t}^i(x_1^i\mid x)=1 }{=} \sum_{x_1^i}\left[ \delta(y^i,x^i) + h \cfrac{\dot \kappa_t}{1 - \kappa_t} \left[ \delta(y^i,x_1^i) - \delta(y^i,x^i) \right] + o(h) \right] p_{1\mid t}^i(x_1^i\mid x)\\ \end{aligned} \tag{20}\] <p>åœ¨å·²çŸ¥$X_t = x$çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨å…¬å¼20è¿›è¡Œé‡‡æ ·çš„å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š</p> <ol> <li>ä»$p_{1\mid t}^i(X_1^i\mid x)$é‡‡æ ·å‡º$X_1^i$ï¼Œ$X_1^i\sim p_{1\mid t}^i(X_1^i\mid x)$ã€‚$p_{1\mid t}^i(X_1^i\mid x)$æ˜¯ç”±æ¨¡å‹é¢„æµ‹å¾—åˆ°ã€‚</li> <li>åŸºäº$X_t^i$æ›´æ–°å‡º$X_{t+h}^i$ã€‚è¿™ä¸€æ­¥éœ€è¦ä½¿ç”¨<sup id="fnref:5"><a href="#fn:5" class="footnote" rel="footnote" role="doc-noteref">4</a></sup>ä¸­å…¬å¼9æ‰€ç¤ºçš„Euler stepï¼Œå¹¶å°†å…¶ä¸­çš„é€Ÿç‡è®¾ç½®ä¸º$\cfrac{\dot \kappa_t}{1 -\kappa_t}\left[\delta(y^i,X_1^i) - \delta(y^i,x^i)\right]$ã€‚<strong>è¿™ä¸€æ­¥å†³å®šäº†$X_{t+h}^i=X_t^i$è¿˜æ˜¯$X_{t+h}^i=X_1^i$</strong>ã€‚</li> </ol> <h3 id="å•è¾¹æ··åˆè·¯å¾„å’Œä¿æ¦‚ç‡é€Ÿç‡">å•è¾¹æ··åˆè·¯å¾„å’Œä¿æ¦‚ç‡é€Ÿç‡</h3> <p>æˆ‘ä»¬åœ¨ç¬¬ä¸€æ¬¡è®²CTMCçš„é‚£ç¯‡æ–‡ç« <sup id="fnref:5:1"><a href="#fn:5" class="footnote" rel="footnote" role="doc-noteref">4</a></sup>é‡Œé¢çš„æœ€åä¸€éƒ¨åˆ†è®²äº†ä¸€ä¸‹ä¿æ¦‚ç‡é€Ÿç‡ï¼Œåˆ°è¿™é‡Œç»ˆäºè¦ç”¨åˆ°äº†ã€‚</p> <p>ç®€å•å›é¡¾ä¸€ä¸‹åœ¨CTMCæ¨¡å‹é‡Œé¢è®²åˆ°çš„ä¿æ¦‚ç‡é€Ÿç‡ï¼Œå®ƒç®€å•çš„è¯´å°±æ˜¯<strong>åœ¨å·²æœ‰çš„é€Ÿç‡$u_t(y,x)$ä¸­åŠ å…¥å¦ä¸€ä¸ªé€Ÿç‡$v_t(y,x)$ï¼Œåªè¦$v_t(y,x)$æ˜¯divergence-freeçš„ï¼Œé‚£ä¹ˆ$u_t(y,x)$ç”Ÿæˆæ¦‚ç‡è·¯å¾„ä¸ä¼šæ”¹å˜</strong>ã€‚æ‰€è°“divergence-freeï¼ŒæŒ‡$\sum_x v_t(y,x)p_t(x) = 0$ã€‚</p> <p>å¯¹DFMé‡Œé¢çš„åˆ†è§£æ¡ä»¶æ¦‚ç‡è·¯å¾„$p_{t\mid Z}^i(x^i\mid z)$ï¼Œå…¶å¯¹åº”çš„ä¿æ¦‚ç‡æ¡ä»¶é€Ÿç‡$v_t^i(y^i,x^i\mid z)$æ»¡è¶³ï¼š</p> \[\sum_{x^i} v_t^i(y^i,x^i\mid z)p_{t\mid Z}^i(x^i\mid z) = 0 \tag{21}\] <p>ä¸€èˆ¬æ¥è¯´è¿™ä¸ªä¿æ¦‚ç‡æ¡ä»¶é€Ÿç‡$v_t^i(y^i,x^i\mid z)$ä¸æ˜¯ç‰¹åˆ«å¥½æ‰¾åˆ°ã€‚ä½†æ˜¯å¦‚æœæˆ‘ä»¬èƒ½æœ‰å¦‚ä¸‹ä¸¤ä¸ªå‡è®¾ï¼š</p> <ol> <li>iidçš„ç›®æ ‡åˆ†å¸ƒï¼š $p(x) = \prod_i p(x^i)$ã€‚</li> <li>æºåˆ†å¸ƒå’Œç›®æ ‡åˆ†å¸ƒçš„æ•°æ®ç‹¬ç«‹é…å¯¹ï¼š$\pi_{0,1}(x_0,x_1) = p(x_0)q(x_1)$ã€‚</li> </ol> <p>é‚£ä¹ˆä¿æ¦‚ç‡æ¡ä»¶é€Ÿç‡çš„è§£æå¼è¿˜æ˜¯æ¯”è¾ƒå¥½æ‰¾åˆ°çš„ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬æ¥æ„é€ è¿™ä¸ªä¿æ¦‚ç‡æ¡ä»¶é€Ÿç‡ã€‚</p> <p>æ ¹æ®å‰é¢çš„ä¸¤æ¡å‡è®¾ï¼Œèƒ½å†™å‡ºæ··åˆè·¯å¾„çš„å½¢å¼å¦‚ä¸‹ï¼š</p> \[p_t(x) = \sum_{x_1} p_{t\mid 1}(x\mid x_1)q(x_1) \text{ where } p_{t\mid 1} (x) = \prod_i p_{t\mid 1}^i(x^i \mid x_1)\\ p_{t\mid 1}^i(x^i \mid x_1) = \kappa_t \delta(x^i,x_1^i) + (1 - \kappa_t)p(x^i) \tag{22}\] <p>è¿™ä¸ªå†™æ³•å’Œæˆ‘ä»¬å‰é¢çš„æ··åˆæ¦‚ç‡è·¯å¾„çš„å†™æ³•çš„å·®å¼‚å°±æ˜¯åªç”¨$x_1$ä½œä¸ºæ¡ä»¶ï¼Œä½†å…¶å®å®ƒå’Œç”¨$x_0,x_1$éƒ½ä½œä¸ºæ¡ä»¶åº”è¯¥æ˜¯ç­‰ä»·çš„ã€‚</p> <p>ç±»æ¯”å…¬å¼6</p> \[\begin{aligned} \cfrac{\mathrm{d}}{\mathrm{d}t}p_{t\mid 1}^i(y^i\mid x_1) &amp; \overset{å…¬å¼22}{=} \dot \kappa_t\left[\delta(y^i,x_1^i) - p(x^i)\right] \\ &amp;\overset{ç”¨å…¬å¼22æ¶ˆå»p(x^i)}{=} \dot \kappa_t\left[\delta(y^i,x_1^i) - \cfrac{p^i_{t\mid 1}(y^i\mid x_1)-\kappa_t\delta(y^i,x_1^i)}{1-\kappa_t}\right]\\ &amp;{=} \cfrac{\dot \kappa_t}{1 - \kappa_t}\left[({1-\kappa_t})\delta(y^i,x_1^i) - {p^i_{t\mid 1}(y^i\mid x_1)+\kappa_t\delta(y^i,x_1^i)}\right]\\ &amp;{=} \cfrac{\dot \kappa_t}{1 - \kappa_t} \left[ \delta(y^i,x_1^i) - p^i_{t\mid 1}(y^i\mid x_1) \right]\\ &amp;{=}\sum_{x^i} \cfrac{\dot \kappa_t}{1 - \kappa_t} \left[ \delta(y^i,x_1^i) - \delta(y^i,x^i) \right] p^i_{t\mid 1}(x^i\mid x_1)\\ \end{aligned}\tag{23}\] <p>å¯¹æ¯”Kolmogorovæ–¹ç¨‹ï¼ŒçŸ¥é“ï¼š</p> \[u_t^i(y^i,x^i\mid x_1)=\cfrac{\dot \kappa_t}{1 - \kappa_t} \left[ \delta(y^i,x_1^i) - \delta(y^i,x^i) \right] \tag{24}\] <p>å¯è§$u_t^i(y^i,x^i\mid x_1)$ç”Ÿæˆ$p^i_{t\mid 1}(x^i\mid x_1)$ã€‚å¦‚æœè¦æ‰¾åˆ°å¯¹$p^i_{t\mid 1}(x^i\mid x_1)$è€Œè¨€divergence-freeçš„æ¡ä»¶é€Ÿç‡ï¼Œä¸€ä¸ªç®€å•çš„æŠ€å·§æ˜¯<strong>æ‰¾åˆ°ä¸€ä¸ªå’Œ$u_t^i(y^i,x^i\mid x_1)$æ–¹å‘ç›¸åçš„æ¡ä»¶é€Ÿç‡<sup id="fnref:6"><a href="#fn:6" class="footnote" rel="footnote" role="doc-noteref">5</a></sup>ï¼Œè¿™æ ·åœ¨æ€»æ—¶é—´èŒƒå›´å†…æŠ˜ä¸¤ä¸ªé€Ÿç‡å·®çš„æ•£åº¦å’Œå°±æ˜¯0ï¼Œæ‰€ä»¥è¿™ä¸¤é€Ÿç‡çš„å·®å°±æ˜¯æˆ‘ä»¬è¦æ‰¾çš„divergence-freeçš„æ¡ä»¶é€Ÿç‡ï¼Œä¹Ÿå°±æ˜¯ä¿æ¦‚ç‡æ¡ä»¶é€Ÿç‡ã€‚</strong>è®°è¿™ä¸ªåå‘çš„æ¡ä»¶é€Ÿç‡ä¸º$\tilde u_t^i(y^i,x^i\mid x_1)$ï¼Œå®ƒçš„å½¢å¼åº”è¯¥æ˜¯ï¼š</p> \[\tilde u_t^i(y^i,x^i\mid x_1) = \cfrac{\dot \kappa_t}{\kappa_t} \left[ \delta(y^i,x^i) - p(x^i) \right] \tag{25}\] <p>è¯æ˜åœ¨<sup id="fnref:6:1"><a href="#fn:6" class="footnote" rel="footnote" role="doc-noteref">5</a></sup>çš„E.5å’ŒE.6ä¸­ã€‚</p> <p>æ‰€ä»¥divergence-freeçš„é€Ÿç‡æ˜¯ï¼š</p> \[v_t^i(y^i,x^i \mid x_1) =u_t^i(y^i,x^i\mid x_1) -\tilde u_t^i(y^i,x^i\mid x_1)\tag{26}\] <p><strong>å› ä¸º$v_t^i(y^i,x^i \mid x_1)$æ˜¯divergence-freeçš„ï¼Œæ‰€ä»¥æŠŠå®ƒä»¥ä»»æ„æ¯”ä¾‹åŠ åˆ°åŸæ¥çš„é€Ÿç‡é‡Œé¢éƒ½ä¸ä¼šå½±å“ç”Ÿæˆçš„æ¦‚ç‡è·¯å¾„</strong>ã€‚æ‰€ä»¥å…¬å¼10æ‰€ç¤ºåˆ†è§£è¾¹ç¼˜é€Ÿç‡å¦‚æœæ”¹å†™æˆä¸‹é¢çš„å½¢å¼ï¼š</p> \[\begin{aligned} u_t^i(y^i,x) &amp;=\sum_{x_1} \left[ u_t^i(y^i,x^i\mid x_1) + c_t v_t^i(y^i,x^i\mid x_1) \right]p_{1\mid t}(x_1 \mid x)\\ &amp;=\sum_{x_1^i} \left[ u_t^i(y^i,x^i\mid x_1^i) + c_t v_t^i(y^i,x^i\mid x_1^i) \right]p^i_{1\mid t}(x^i_1 \mid x)\\ \end{aligned} \tag{27}\\\] <p>ä¸å½±å“æ‰€ç”Ÿæˆçš„è¾¹ç¼˜æ¦‚ç‡è·¯å¾„ã€‚ç¬¬äºŒä¸ªç­‰å¼æ˜¯å› ä¸º$u_t^i(y^i,x^i\mid x_1) =u_t^i(y^i,x^i\mid x_1^i)$ï¼Œ$v_t^i(y^i,x^i\mid x_1) =v_t^i(y^i,x^i\mid x_1^i)$ã€‚</p> <p>é‚£ä¹ˆï¼Œç”¨å…¬å¼27æ‰€ç¤ºçš„é€Ÿç‡è¿›è¡Œé‡‡æ ·çš„æ­¥éª¤æ˜¯ï¼š</p> <ol> <li> <p>ä»$p_{1\mid t}^i(X_1^i\mid x)$é‡‡æ ·å‡º$X_1^i$ï¼Œ$X_1^i\sim p_{1\mid t}^i(X_1^i\mid x)$ã€‚$p_{1\mid t}^i(X_1^i\mid x)$æ˜¯ç”±æ¨¡å‹é¢„æµ‹å¾—åˆ°ã€‚</p> </li> <li> <p>åŸºäº$X_t^i$æ›´æ–°å‡º$X_{t+h}^i$ã€‚è¿™ä¸€æ­¥éœ€è¦ä½¿ç”¨<sup id="fnref:5:2"><a href="#fn:5" class="footnote" rel="footnote" role="doc-noteref">4</a></sup>ä¸­å…¬å¼9æ‰€ç¤ºçš„Euler stepï¼Œå¹¶å°†å…¶ä¸­çš„é€Ÿç‡è®¾ç½®ä¸º</p> \[u_t^i(y^i,x^i\mid x_1) = \cfrac{\dot \kappa_t}{1-\kappa_t}\left[\delta(y^i,X_1^i) - \delta(y^i,x^i)\right] +c_t\left[ \cfrac{\dot \kappa_t}{1-\kappa_t}\left[\delta(y^i,x_1^i) - \delta(y^i,x^i)\right] - \cfrac{\dot \kappa_t}{\kappa_t} \left[\delta(y^i,x^i) - p(x^i)\right] \right] \tag{28}\] <p>å…¶ä¸­$c_t&gt;0$æ˜¯ä¸æ—¶é—´ç›¸å…³çš„å¸¸æ•°ã€‚</p> </li> </ol> <p>åœ¨<a href="https://github.com/facebookresearch/flow_matching">https://github.com/facebookresearch/flow_matching</a>åº“é‡Œé¢å®ç°çš„DFMçš„ä»£ç å¦‚ä¸‹ï¼š</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">torch</span>  

<span class="kn">from</span> <span class="n">flow_matching.path</span> <span class="kn">import</span> <span class="n">MixtureDiscreteProbPath</span><span class="p">,</span> <span class="n">DiscretePathSample</span>  
<span class="kn">from</span> <span class="n">flow_matching.path.scheduler</span> <span class="kn">import</span> <span class="n">PolynomialConvexScheduler</span>  
<span class="kn">from</span> <span class="n">flow_matching.loss</span> <span class="kn">import</span> <span class="n">MixturePathGeneralizedKL</span>  
<span class="kn">from</span> <span class="n">flow_matching.solver</span> <span class="kn">import</span> <span class="n">MixtureDiscreteEulerSolver</span>  
<span class="kn">from</span> <span class="n">flow_matching.utils</span> <span class="kn">import</span> <span class="n">ModelWrapper</span>  

<span class="c1"># Define a trainable velocity model  
</span><span class="n">model</span> <span class="o">=</span> <span class="p">...</span>   

<span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">optim</span><span class="p">.</span><span class="nc">Adam</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="nf">parameters</span><span class="p">())</span>  

<span class="n">scheduler</span> <span class="o">=</span> <span class="nc">PolynomialConvexScheduler</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>  
<span class="n">path</span> <span class="o">=</span> <span class="nc">MixtureDiscreteProbPath</span><span class="p">(</span><span class="n">scheduler</span><span class="o">=</span><span class="n">scheduler</span><span class="p">)</span>  
<span class="n">loss_fn</span> <span class="o">=</span> <span class="nc">MixturePathGeneralizedKL</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">)</span>  <span class="c1"># Generalized KL Bregman divergence  
</span>
<span class="k">for</span> <span class="n">x_0</span><span class="p">,</span> <span class="n">x_1</span> <span class="ow">in</span> <span class="n">dataloader</span><span class="p">:</span>  <span class="c1"># Samples from Ï€0,1 of shape [batch_size, *data_dim]  
</span>    <span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">rand</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="mf">1e-3</span><span class="p">)</span>  <span class="c1"># Randomize time t âˆ¼ U [0, 1 âˆ’ 10âˆ’3]  
</span>    <span class="n">sample</span><span class="p">:</span> <span class="n">DiscretePathSample</span> <span class="o">=</span> <span class="n">path</span><span class="p">.</span><span class="nf">sample</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">x_0</span><span class="o">=</span><span class="n">x_0</span><span class="p">,</span> <span class="n">x_1</span><span class="o">=</span><span class="n">x_1</span><span class="p">)</span>  <span class="c1"># Sample the conditional path  
</span>    <span class="n">model_output</span> <span class="o">=</span> <span class="nf">model</span><span class="p">(</span><span class="n">sample</span><span class="p">.</span><span class="n">x_t</span><span class="p">,</span> <span class="n">sample</span><span class="p">.</span><span class="n">t</span><span class="p">)</span>  

    <span class="n">loss</span> <span class="o">=</span> <span class="nf">loss_fn</span><span class="p">(</span><span class="n">logits</span><span class="o">=</span><span class="n">model_output</span><span class="p">,</span> <span class="n">x_1</span><span class="o">=</span><span class="n">sample</span><span class="p">.</span><span class="n">x_1</span><span class="p">,</span> <span class="n">x_t</span><span class="o">=</span><span class="n">sample</span><span class="p">.</span><span class="n">x_t</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">sample</span><span class="p">.</span><span class="n">t</span><span class="p">)</span>  <span class="c1"># CDFM loss  
</span>
    <span class="n">optimizer</span><span class="p">.</span><span class="nf">zero_grad</span><span class="p">()</span>  
    <span class="n">loss</span><span class="p">.</span><span class="nf">backward</span><span class="p">()</span>  
    <span class="n">optimizer</span><span class="p">.</span><span class="nf">step</span><span class="p">()</span>  

<span class="k">class</span> <span class="nc">ProbabilityDenoiser</span><span class="p">(</span><span class="n">ModelWrapper</span><span class="p">):</span>  
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">torch</span><span class="p">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">torch</span><span class="p">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="o">**</span><span class="n">extras</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="p">.</span><span class="n">Tensor</span><span class="p">:</span>  
        <span class="n">logits</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="o">**</span><span class="n">extras</span><span class="p">)</span>  
        <span class="k">return</span> <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">functional</span><span class="p">.</span><span class="nf">softmax</span><span class="p">(</span><span class="n">logits</span><span class="p">.</span><span class="nf">float</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  

<span class="c1"># Sample X1  
</span><span class="n">probability_denoiser</span> <span class="o">=</span> <span class="nc">ProbabilityDenoiser</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>  
<span class="n">x_0</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">randint</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="n">batch_size</span><span class="p">,</span> <span class="o">*</span><span class="n">data_dim</span><span class="p">])</span>  <span class="c1"># Specify the initial condition  
</span><span class="n">solver</span> <span class="o">=</span> <span class="nc">MixtureDiscreteEulerSolver</span><span class="p">(</span>  
    <span class="n">model</span><span class="o">=</span><span class="n">probability_denoiser</span><span class="p">,</span>  
    <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>  
    <span class="n">vocabulary_size</span><span class="o">=</span><span class="n">vocabulary_size</span>  
<span class="p">)</span>  

<span class="n">step_size</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">100</span>  
<span class="n">x_1</span> <span class="o">=</span> <span class="n">solver</span><span class="p">.</span><span class="nf">sample</span><span class="p">(</span><span class="n">x_init</span><span class="o">=</span><span class="n">x_0</span><span class="p">,</span> <span class="n">step_size</span><span class="o">=</span><span class="n">step_size</span><span class="p">,</span> <span class="n">time_grid</span><span class="o">=</span><span class="n">torch</span><span class="p">.</span><span class="nf">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="mf">1e-3</span><span class="p">]))</span>
</code></pre></div></div> <p>ä¸€ä¸ªç‹¬ç«‹çš„DFMçš„ä»£ç æ¡ˆä¾‹å¦‚ä¸‹ï¼š</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">torch</span>  
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>  
<span class="kn">from</span> <span class="n">torch</span> <span class="kn">import</span> <span class="n">nn</span><span class="p">,</span> <span class="n">Tensor</span>  
<span class="kn">from</span> <span class="n">sklearn.datasets</span> <span class="kn">import</span> <span class="n">make_moons</span>  

<span class="k">class</span> <span class="nc">DiscreteFlow</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>  
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">dim</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">h</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">128</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">128</span><span class="p">):</span>  
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">()</span>  
        <span class="n">self</span><span class="p">.</span><span class="n">v</span> <span class="o">=</span> <span class="n">v</span>  
        <span class="n">self</span><span class="p">.</span><span class="n">embed</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Embedding</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>  
        <span class="n">self</span><span class="p">.</span><span class="n">net</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Sequential</span><span class="p">(</span>  
            <span class="n">nn</span><span class="p">.</span><span class="nc">Linear</span><span class="p">(</span><span class="n">dim</span> <span class="o">*</span> <span class="n">h</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">h</span><span class="p">),</span> <span class="n">nn</span><span class="p">.</span><span class="nc">ELU</span><span class="p">(),</span>  
            <span class="n">nn</span><span class="p">.</span><span class="nc">Linear</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">h</span><span class="p">),</span> <span class="n">nn</span><span class="p">.</span><span class="nc">ELU</span><span class="p">(),</span>  
            <span class="n">nn</span><span class="p">.</span><span class="nc">Linear</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">h</span><span class="p">),</span> <span class="n">nn</span><span class="p">.</span><span class="nc">ELU</span><span class="p">(),</span>  
            <span class="n">nn</span><span class="p">.</span><span class="nc">Linear</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">dim</span> <span class="o">*</span> <span class="n">v</span><span class="p">)</span>  
        <span class="p">)</span>  

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">x_t</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>  
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">net</span><span class="p">(</span>  
            <span class="n">torch</span><span class="p">.</span><span class="nf">cat</span><span class="p">(</span>  
                <span class="p">(</span><span class="n">t</span><span class="p">[:,</span> <span class="bp">None</span><span class="p">],</span> <span class="n">self</span><span class="p">.</span><span class="nf">embed</span><span class="p">(</span><span class="n">x_t</span><span class="p">).</span><span class="nf">flatten</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span> <span class="o">-</span><span class="mi">1</span>  
            <span class="p">)</span>  
        <span class="p">).</span><span class="nf">reshape</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">x_t</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">v</span><span class="p">])</span>  

<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">256</span>  
<span class="n">vocab_size</span> <span class="o">=</span> <span class="mi">128</span>  

<span class="n">model</span> <span class="o">=</span> <span class="nc">DiscreteFlow</span><span class="p">(</span><span class="n">v</span><span class="o">=</span><span class="n">vocab_size</span><span class="p">)</span>  
<span class="n">optim</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">optim</span><span class="p">.</span><span class="nc">Adam</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="nf">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)</span>  

<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">):</span>  
    <span class="n">x_1</span> <span class="o">=</span> <span class="nc">Tensor</span><span class="p">(</span><span class="nf">make_moons</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">noise</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>  
    <span class="n">x_1</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">round</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="nf">clip</span><span class="p">(</span><span class="n">x_1</span> <span class="o">*</span> <span class="mi">35</span> <span class="o">+</span> <span class="mi">50</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">vocab_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)).</span><span class="nf">long</span><span class="p">()</span>  
    <span class="n">x_0</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">randint</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">vocab_size</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>  

    <span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">rand</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>  
    <span class="n">x_t</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="nf">rand</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">t</span><span class="p">[:,</span> <span class="bp">None</span><span class="p">],</span> <span class="n">x_1</span><span class="p">,</span> <span class="n">x_0</span><span class="p">)</span>  

    <span class="n">logits</span> <span class="o">=</span> <span class="nf">model</span><span class="p">(</span><span class="n">x_t</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>  
    <span class="n">loss</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">functional</span><span class="p">.</span><span class="nf">cross_entropy</span><span class="p">(</span><span class="n">logits</span><span class="p">.</span><span class="nf">flatten</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">x_1</span><span class="p">.</span><span class="nf">flatten</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)).</span><span class="nf">mean</span><span class="p">()</span>  
    <span class="n">optim</span><span class="p">.</span><span class="nf">zero_grad</span><span class="p">()</span>  
    <span class="n">loss</span><span class="p">.</span><span class="nf">backward</span><span class="p">()</span>  
    <span class="n">optim</span><span class="p">.</span><span class="nf">step</span><span class="p">()</span>  

<span class="n">x_t</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">randint</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">vocab_size</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>  
<span class="n">t</span> <span class="o">=</span> <span class="mf">0.0</span>  
<span class="n">results</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x_t</span><span class="p">,</span> <span class="n">t</span><span class="p">)]</span>  
<span class="k">while</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="mf">1e-3</span><span class="p">:</span>  
    <span class="n">p1</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">softmax</span><span class="p">(</span><span class="nf">model</span><span class="p">(</span><span class="n">x_t</span><span class="p">,</span> <span class="n">torch</span><span class="p">.</span><span class="nf">ones</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span> <span class="o">*</span> <span class="n">t</span><span class="p">),</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  
    <span class="n">h</span> <span class="o">=</span> <span class="nf">min</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span>  
    <span class="n">one_hot_x_t</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">functional</span><span class="p">.</span><span class="nf">one_hot</span><span class="p">(</span><span class="n">x_t</span><span class="p">,</span> <span class="n">vocab_size</span><span class="p">).</span><span class="nf">float</span><span class="p">()</span>  
    <span class="n">u</span> <span class="o">=</span> <span class="p">(</span><span class="n">p1</span> <span class="o">-</span> <span class="n">one_hot_x_t</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span>  
    <span class="n">x_t</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">distributions</span><span class="p">.</span><span class="nc">Categorical</span><span class="p">(</span><span class="n">probs</span><span class="o">=</span><span class="n">one_hot_x_t</span> <span class="o">+</span> <span class="n">h</span> <span class="o">*</span> <span class="n">u</span><span class="p">).</span><span class="nf">sample</span><span class="p">()</span>  
    <span class="n">t</span> <span class="o">+=</span> <span class="n">h</span>  
    <span class="n">results</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">x_t</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span>  

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">results</span><span class="p">),</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>  
<span class="nf">for </span><span class="p">(</span><span class="n">x_t</span><span class="p">,</span> <span class="n">t</span><span class="p">),</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nf">zip</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">axes</span><span class="p">):</span>  
    <span class="n">ax</span><span class="p">.</span><span class="nf">scatter</span><span class="p">(</span><span class="n">x_t</span><span class="p">.</span><span class="nf">detach</span><span class="p">()[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">x_t</span><span class="p">.</span><span class="nf">detach</span><span class="p">()[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>  
    <span class="n">ax</span><span class="p">.</span><span class="nf">set_title</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">t=</span><span class="si">{</span><span class="n">t</span><span class="si">:</span><span class="p">.</span><span class="mi">1</span><span class="n">f</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">()</span>  
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div> <p>DFMç”Ÿæˆæ•ˆæœå¦‚ä¸‹ï¼š</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/post/DFM33-480.webp 480w,/assets/img/post/DFM33-800.webp 800w,/assets/img/post/DFM33-1400.webp 1400w," type="image/webp" sizes="95vw"/> <img src="/assets/img/post/DFM33.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption"> DFMç”Ÿæˆæ•ˆæœ </div> <div class="footnotes" role="doc-endnotes"> <ol> <li id="fn:1"> <p><a href="https://zhuanlan.zhihu.com/p/18450992825">https://zhuanlan.zhihu.com/p/18450992825</a>Â <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a>Â <a href="#fnref:1:1" class="reversefootnote" role="doc-backlink">&#8617;<sup>2</sup></a>Â <a href="#fnref:1:2" class="reversefootnote" role="doc-backlink">&#8617;<sup>3</sup></a>Â <a href="#fnref:1:3" class="reversefootnote" role="doc-backlink">&#8617;<sup>4</sup></a>Â <a href="#fnref:1:4" class="reversefootnote" role="doc-backlink">&#8617;<sup>5</sup></a>Â <a href="#fnref:1:5" class="reversefootnote" role="doc-backlink">&#8617;<sup>6</sup></a>Â <a href="#fnref:1:6" class="reversefootnote" role="doc-backlink">&#8617;<sup>7</sup></a></p> </li> <li id="fn:2"> <p>Lipman Y, Chen R T Q, Ben-Hamu H, et al. Flow matching for generative modeling[J]. arXiv preprint arXiv:2210.02747, 2022.Â <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a>Â <a href="#fnref:2:1" class="reversefootnote" role="doc-backlink">&#8617;<sup>2</sup></a></p> </li> <li id="fn:3"> <p>Liu X, Gong C, Liu Q. Flow straight and fast: Learning to generate and transfer data with rectified flow[J]. arXiv preprint arXiv:2209.03003, 2022.Â <a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:5"> <p><a href="https://zhuanlan.zhihu.com/p/16026053810">https://zhuanlan.zhihu.com/p/16026053810</a>Â <a href="#fnref:5" class="reversefootnote" role="doc-backlink">&#8617;</a>Â <a href="#fnref:5:1" class="reversefootnote" role="doc-backlink">&#8617;<sup>2</sup></a>Â <a href="#fnref:5:2" class="reversefootnote" role="doc-backlink">&#8617;<sup>3</sup></a></p> </li> <li id="fn:6"> <p>Gat I, Remez T, Shaul N, et al. Discrete flow matching[J]. arXiv preprint arXiv:2407.15595, 2024.Â <a href="#fnref:6" class="reversefootnote" role="doc-backlink">&#8617;</a>Â <a href="#fnref:6:1" class="reversefootnote" role="doc-backlink">&#8617;<sup>2</sup></a></p> </li> </ol> </div>]]></content><author><name></name></author><category term="Flow_Matching"/><category term="Discrete_Flow_Matching"/><category term="formatting"/><category term="math"/><summary type="html"><![CDATA[æ¥ç€ä¸Šæ¬¡è¯´çš„DFMçš„åˆ†è§£æŠ€å·§ï¼Œç»§ç»­å­¦ä¹ DFMçš„æœ€åä¸€éƒ¨åˆ†â€”â€”æ··åˆè·¯å¾„ï¼ˆMixture pathsï¼‰ã€‚ æ··åˆè·¯å¾„ï¼ˆMixture pathsï¼‰ æˆ‘ä»¬åœ¨æ­¤å‰çš„æ–‡ç« é‡Œé¢å·²ç»è®²è§£äº†åˆ†è§£æŠ€å·§1ï¼Œå¾—åˆ°äº†åˆ†è§£çš„ï¼ˆè¾¹ç¼˜/æ¡ä»¶ï¼‰æ¦‚ç‡è·¯å¾„ã€åˆ†è§£çš„ï¼ˆè¾¹ç¼˜/æ¡ä»¶ï¼‰é€Ÿç‡ï¼Œä»¥åŠçŸ¥é“äº†ä»–ä»¬ä¹‹é—´çš„å…³ç³»ï¼ˆ1ä¸­çš„å‘½é¢˜2å’Œå®šç†16ï¼‰ã€‚ç°åœ¨æˆ‘ä»¬è¦ç€æ‰‹è®¾è®¡å‡ºä¸€ä¸ªå…·ä½“çš„DFMäº†ï¼Œç±»ä¼¼FM2ä¸€æ ·ï¼Œæˆ‘ä»¬å¯ä»¥ä»åˆ†è§£æ¡ä»¶æ¦‚ç‡è·¯å¾„ç€æ‰‹ï¼Œç„¶åå¾—åˆ°ç›®æ ‡åˆ†è§£æ¡ä»¶é€Ÿç‡ï¼Œä½¿ç”¨ç¥ç»ç½‘ç»œé¢„æµ‹åˆ†è§£æ¡ä»¶é€Ÿç‡ï¼Œæœ€åä½¿ç”¨åˆ†è§£CDFMæŸå¤±ï¼ˆ1ä¸­å…¬å¼14ï¼‰æ¥è®­ç»ƒæ¨¡å‹ã€‚ æˆ‘ä»¬ä»¥$Z=(X_0,X_1) \sim \pi_{0,1}(X_0,X_1)$ä¸ºæ¡ä»¶ï¼ˆ$X_0$å’Œ$X_1$ä¸ºä»»æ„é…å¯¹ï¼‰ï¼Œé‚£ä¹ˆåˆ†è§£çš„æ¡ä»¶æ¦‚ç‡è·¯å¾„å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å½¢å¼ï¼š \[p_{t\mid 0,1}^i (x^i\mid x_0,x_1)=\kappa_t\delta(x^i,x_1^i) + (1-\kappa_t)\delta(x^i,x_0^i) \tag{1}\] è¿™ä¸ªåšæ³•ç±»ä¼¼Rectified Flowï¼ˆ3ä¸­å…¬å¼1ï¼‰ï¼Œåªæ˜¯ä½¿ç”¨äº†æ›´generalçš„$\kappa_t$ä½œä¸ºç³»æ•°ï¼Œ$\kappa : [0,1] \to [0,1]$å°±ç±»ä¼¼æ‰©æ•£æ¨¡å‹é‡Œé¢çš„å™ªå£°è°ƒåº¦å™¨ï¼Œ$\kappa_t \in C^1([0,1])$ã€‚æ ¹æ®1ä¸­å…¬å¼6ï¼Œæˆ‘ä»¬èƒ½å¾—åˆ°éåˆ†è§£çš„æ¡ä»¶æ¦‚ç‡è·¯å¾„ï¼š \[p_{t\mid 0,1} (x\mid x_0,x_1)=\prod_i p_{t\mid 0,1}^i (x^i\mid x_0,x_1) \tag{2}\] å…³äºå…¬å¼1çš„è¯¦ç»†è§£é‡Šï¼š åˆ†è§£æ¦‚ç‡è·¯å¾„ä¸Šçš„éšæœºå˜é‡$X_t^i \sim p_{t\mid 0,1}^i(\cdot\mid x_0,x_1) $æ»¡è¶³ï¼š \[X_t^i = \begin{cases} x_1^i \quad æ¦‚ç‡ä¸º\kappa_t\\ x_0^i \quad æ¦‚ç‡ä¸º(1-\kappa_t) \end{cases} \tag{3}\] ä¹Ÿå°±æ˜¯å¯¹$t$æ—¶åˆ»çš„ç¬¬$i$ä¸ªtoken $X_t^i$ï¼Œå®ƒè¦ä¹ˆå–æºçŠ¶æ€çš„å€¼$x_0^i$ï¼Œè¦ä¹ˆå–ç›®æ ‡çŠ¶æ€çš„å€¼$x_1^i$ï¼Œå–è¿™ä¸¤ä¸ªå€¼çš„æ¦‚ç‡ä¸æ—¶é—´$t$ç›¸å…³ã€‚ ä»å…¬å¼1å’Œ2ç»™å‡ºçš„æ¡ä»¶æ¦‚ç‡è·¯å¾„å¯ä»¥ç®—å‡ºè¾¹ç¼˜æ¦‚ç‡è·¯å¾„ï¼Œå³ï¼š \[p_t(x)=\sum_{x_0,x_1}p_{t\mid 0,1}(x\mid x_0,x_1) p_{0,1}(x_0,x_1) \tag{4}\] éœ€è¦æŒ‡å‡ºçš„æ˜¯ï¼Œ$p_t(x)$éœ€è¦æ»¡è¶³è¾¹ç¼˜æ¡ä»¶ï¼Œå³$p_0(x) = \delta(x,x_0)$ï¼Œ$p_1(x) = \delta(x,x_1)$ã€‚ä¸ºå®ç°è¿™ä¸ªæ¡ä»¶ï¼Œéœ€è¦è®©$\kappa_0 = 0$ï¼Œ$\kappa_1 = 1$ã€‚ æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“å…¬å¼1æ‰€ç¤ºåˆ†è§£æ¡ä»¶æ¦‚ç‡è·¯å¾„å¯¹åº”çš„åˆ†è§£æ¡ä»¶é€Ÿç‡$u_t^i(y^i,x^i\mid x_0,x_1)$ã€‚ç”±Kolmogorovæ–¹ç¨‹å¯çŸ¥ï¼š \[\cfrac{\mathrm{d}}{\mathrm{d}t}p_{t\mid 0,1}^i(y^i\mid x_0,x_1) = \sum_{x^i}u_t^i(y^i,x^i\mid x_0,x_1)p_{t\mid 0,1}^i(x^i\mid x_0,x_1) \tag{5}\] ç»“åˆå…¬å¼1ç»™å‡ºçš„å…·ä½“åˆ†è§£æ¡ä»¶æ¦‚ç‡è·¯å¾„ï¼Œå¯ä»¥ç®—å‡ºï¼š \[\begin{aligned} \cfrac{\mathrm{d}}{\mathrm{d}t}p_{t\mid 0,1}^i(y^i\mid x_0,x_1)&amp; \overset{å…¬å¼1}{=} \dot \kappa_t\left[\delta(y^i,x_1^i) - \delta(y^i,x_0^i)\right] \\ &amp;\overset{ç”¨å…¬å¼1æ¶ˆå»\delta(y^i,x_0^i)}{=} \dot \kappa_t\left[\delta(y^i,x_1^i) - \cfrac{p^i_{t\mid 0,1}(y^i\mid x_0,x_1)-\kappa_t\delta(y^i,x_1^i)}{1-\kappa_t}\right]\\ &amp;{=} \cfrac{\dot \kappa_t}{1 - \kappa_t}\left[({1-\kappa_t})\delta(y^i,x_1^i) - {p^i_{t\mid 0,1}(y^i\mid x_0,x_1)+\kappa_t\delta(y^i,x_1^i)}\right]\\ &amp;{=} \cfrac{\dot \kappa_t}{1 - \kappa_t} \left[ \delta(y^i,x_1^i) - p^i_{t\mid 0,1}(y^i\mid x_0,x_1) \right]\\ &amp;\overset{(*)}{=}\sum_{x^i} \cfrac{\dot \kappa_t}{1 - \kappa_t} \left[ \delta(y^i,x_1^i) - \delta(y^i,x^i) \right] p^i_{t\mid 0,1}(x^i\mid x_0,x_1)\\ \end{aligned}\tag{6}\] å…³äºï¼ˆ*ï¼‰æ­¥çš„è§£é‡Šå¦‚ä¸‹ï¼š è¿™é‡Œå…¶å®å°±æ˜¯è¦è¯æ˜ \[\delta(y^i,x_1^i) - p^i_{t\mid 0,1}(y^i\mid x_0,x_1) = \sum_{x^i} \left[ \delta(y^i,x_1^i) - \delta(y^i,x^i) \right] p^i_{t\mid 0,1}(x^i\mid x_0,x_1) \tag{7}\] æˆ‘ä»¬ä»å³è¾¹å¼€å§‹å˜æ¢ï¼š \[\begin{aligned} \sum_{x^i} \left[ \delta(y^i,x_1^i) - \delta(y^i,x^i) \right] p^i_{t\mid 0,1}(x^i\mid x_0,x_1) &amp;= \sum_{x^i} \left[ \delta(y^i,x_1^i)p^i_{t\mid 0,1}(x^i\mid x_0,x_1) - \delta(y^i,x^i)p^i_{t\mid 0,1}(x^i\mid x_0,x_1) \right]\\ &amp;= \sum_{x^i} \delta(y^i,x_1^i)p^i_{t\mid 0,1}(x^i\mid x_0,x_1) - \sum_{x^i} \delta(y^i,x^i)p^i_{t\mid 0,1}(x^i\mid x_0,x_1) \\ &amp;\overset{(1)}{=} \sum_{x^i} \delta(y^i,x_1^i)p^i_{t\mid 0,1}(x^i\mid x_0,x_1) - p^i_{t\mid 0,1}(y^i\mid x_0,x_1) \\ &amp;\overset{(2)}{=} \delta(y^i,x_1^i) - p^i_{t\mid 0,1}(y^i\mid x_0,x_1) \\ \end{aligned} \tag{8}\] ç¬¬ï¼ˆ1ï¼‰æ­¥æ˜¯deltaå‡½æ•°çš„æ€§è´¨ï¼Œ$\int_x\delta(y,x)f(x)\mathrm{d}x = f(y)$ï¼Œç¬¬ï¼ˆ2ï¼‰æ­¥æ˜¯å› ä¸º$\delta(y^i,x_1^i)$ä¸$x^i$æ— å…³ï¼Œ$\sum_{x^i} p^i_{t\mid 0,1}(x^i\mid x_0,x_1) = 1 $ã€‚ å¯¹æ¯”å…¬å¼6çš„æœ€åç»“æœå’Œå…¬å¼5ï¼Œå°±çŸ¥é“ï¼š \[u_t^i(y^i,x^i\mid x_0,x_1) = \cfrac{\dot \kappa_t}{1 - \kappa_t} \left[ \delta(y^i,x_1^i) - \delta(y^i,x^i) \right] \tag{9}\] è¿™æ ·æˆ‘ä»¬å°±çŸ¥é“äº†å…¬å¼1æ‰€ç¤ºçš„åˆ†è§£æ¡ä»¶æ¦‚ç‡è·¯å¾„å¯¹åº”çš„åˆ†è§£æ¡ä»¶é€Ÿç‡$u_t^i(y^i,x^i\mid x_0,x_1)$çš„å…·ä½“å½¢å¼äº†ã€‚ Code 9æ˜¯æ··åˆè·¯å¾„çš„å®ç°ä»£ç ã€‚ æ··åˆè·¯å¾„çš„å®ç°ä»£ç  é€Ÿç‡åéªŒå‚æ•°åŒ– ç±»æ¯”æˆ‘ä»¬åœ¨FM2å’Œæ‰©æ•£æ¨¡å‹é‡Œé¢ä¹Ÿä¼šè®²çš„å¤šç§é¢„æµ‹æ–¹å¼ï¼Œä¾‹å¦‚velocity-predictionã€$x_0$-predictionã€$x_1$-predictionï¼Œæˆ‘ä»¬åœ¨DFMé‡Œé¢ä¹Ÿå¯ä»¥ä½¿ç”¨ç±»ä¼¼çš„é¢„æµ‹æ–¹å¼ã€‚ æœ€ç®€å•çš„ä¸€ç§ï¼šä½¿ç”¨ç¥ç»ç½‘ç»œé¢„æµ‹å…¬å¼9ç»™å‡ºçš„åˆ†è§£æ¡ä»¶é€Ÿç‡$u_t^i(y^i,x^i\mid x_0,x_1)$ï¼Œè¿™å°±æ˜¯velocity-predictionã€‚ æ¥ä¸‹æ¥ä»‹ç»DFMé‡Œé¢çš„$x_1$-predictionï¼Œè¿™ä¸ªä¼šç¨å¾®å¤æ‚ä¸€ç‚¹ã€‚ æ ¹æ®æˆ‘ä»¬åœ¨1ä¸­è¯æ˜å‡ºæ¥çš„å…¬å¼12ï¼Œå¯ä»¥å¾—åˆ°åœ¨$u_t^i(y^i,x^i\mid x_0,x_1)$å–å…¬å¼9çš„å½¢å¼æ—¶ï¼Œåˆ†è§£è¾¹ç¼˜é€Ÿç‡ä¸ºï¼š \[\begin{aligned} u_t^i(y^i,x) &amp;=\sum_{x_0,x_1} u_t^i(y^i,x^i\mid x_0,x_1)p_{0,1\mid t}(x_0,x_1\mid x)\\ &amp;\overset{å…¬å¼(9)}{=} \sum_{x_0,x_1} \cfrac{\dot \kappa_t}{1 - \kappa_t} \left[ \delta(y^i,x_1^i) - \delta(y^i,x^i) \right] p_{0,1\mid t}(x_0,x_1\mid x)\\ &amp;\overset{å°†x_1^iåˆ†å‡ºæ¥}{=} \sum_{x_1^i}\sum_{x_0,x_1^{\bar i}} \cfrac{\dot \kappa_t}{1 - \kappa_t} \left[ \delta(y^i,x_1^i) - \delta(y^i,x^i) \right] p_{0,1\mid t}(x_0,x_1\mid x)\\ &amp;\overset{åˆ†é…å¾‹}{=} \sum_{x_1^i} \cfrac{\dot \kappa_t}{1 - \kappa_t} \left[ \delta(y^i,x_1^i) - \delta(y^i,x^i) \right]\sum_{x_0,x_1^{\bar i}} p_{0,1\mid t}(x_0,x_1\mid x)\\ \end{aligned} \tag{10}\] å•ç‹¬æŠŠç¬¬äºŒä¸ªæ±‚å’Œå¼æ‹¿å‡ºæ¥ï¼Œè®°ä¸ºï¼š \[p_{1\mid t}^i(x_1^i\mid x) = \sum_{x_0,x_1^{\bar i}} p_{0,1\mid t}(x_0,x_1\mid x) \overset{(*)}{=}\mathbb{E}\left[ \delta(x_1^i,X_1^i) \mid X_t=x \right] \tag{11}\] å…³äºå…¬å¼11ä¸­ï¼ˆ*ï¼‰æ­¥éª¤çš„è¯¦ç»†è¯´æ˜ï¼š \[\begin{aligned} p_{1\mid t}^i(x_1^i\mid x) &amp;= \sum_{x_0,x_1^{\bar i}} p_{0,1\mid t}(x_0,x_1\mid x)\\ &amp;\overset{æ‹†å¼€x_1}{=} \sum_{x_0,x_1^{\bar i}} p_{0,1\mid t}(x_0,x_1^{\bar i},x_1^i\mid x)\\ &amp;\overset{\deltaå‡½æ•°çš„æ€§è´¨}{=} \sum_{x_0,x_1^{\bar i}}\sum_{X_1^i}\delta(x_1^i,X_1^i) p_{0,1\mid t}(x_0,x_1^{\bar i},X_1^i\mid x)\\ &amp;=\mathbb{E}\left[ \delta(x_1^i,X_1^i) \mid X_t=x \right] \end{aligned} \tag{12}\] æˆ‘ä»¬å¯ä»¥ç”¨ç¥ç»ç½‘ç»œå»å­¦ä¹ åéªŒåˆ†å¸ƒ$p_{1\mid t}^{\theta,i}(x_1^i\mid x)$ï¼Œ$\theta$ä¸ºç¥ç»ç½‘ç»œçš„å‚æ•°ã€‚è¿™å°±æ˜¯ç¦»æ•£ç‰ˆçš„$x_1$-predictionã€‚ è¿™æ ·ç†è§£ï¼šä»¥æ–‡æœ¬ä¸ºä¾‹ï¼Œ$x$æ˜¯æ—¶é—´$t$æ—¶çš„â€œåŠ å™ªâ€æ–‡æœ¬ï¼ˆä½†å…¶å®è¯´â€œåŠ å™ªâ€œä¸å‡†ç¡®ï¼Œå› ä¸ºDFMçš„åˆå§‹çŠ¶æ€$x_0$æ˜¯ä¸€ä¸ªå…¨maskçš„æ–‡æœ¬ï¼Œ$x$æ›´ç±»ä¼¼ä¸€ä¸ªå¤„äºä¸­é—´çŠ¶æ€çš„æ–‡æœ¬ï¼‰ã€‚$x$ä½œä¸ºç¥ç»ç½‘ç»œçš„è¾“å…¥ï¼Œç¥ç»ç½‘ç»œé¢„æµ‹$x_1^i$ï¼Œ$i\in [d]$è¡¨ç¤ºè¿™æ˜¯$x_1$çš„ç¬¬$i$ä¸ªtokenï¼Œ$d$ä¸ºå¥é•¿ã€‚ç¥ç»ç½‘ç»œä¸€æ¬¡é¢„æµ‹æ‰€æœ‰tokençš„å•æ­¥å˜åŒ–æ¦‚ç‡ï¼Œæ¯ä¸ªtokenå…±æœ‰$K$ç§å˜åŒ–æƒ…å†µï¼ˆ$K$ä¸ºvocabularyçš„å¤§å°ï¼‰ï¼Œç¥ç»ç½‘ç»œçš„è¾“å‡ºå‘é‡çš„ç»´åº¦å°±æ˜¯$d\cdot K$ã€‚ æ··åˆè·¯å¾„çš„CDFMæŸå¤± æˆ‘ä»¬åŸºäº$x_1$-predictionï¼Œå³é¢„æµ‹$p_{1\mid t}^{\theta,i}(x_1^i\mid x)$ï¼Œç»§ç»­è®¨è®ºå…¬å¼1æ‰€ç¤ºæ··åˆè·¯å¾„æƒ…å†µä¸‹çš„CDFMæŸå¤±ã€‚è¿™é‡Œä¼šæœ‰ä¸¤ç§åšæ³•ã€‚ ç»“åˆå…¬å¼11ï¼Œå¦‚æœç›´æ¥å¯¹æ¯”åéªŒæ¦‚ç‡ï¼Œåˆ™CDFMæŸå¤±å¯ä»¥å†™ä¸ºï¼š \[L_{CDFM}(\theta) = \mathbb{E}_{t,X_0,X_1,X_t} D_{X_t}\left( \delta(\cdot,X_1^i),p_{1\mid t}^{\theta,i}(\cdot\mid X_t) \right) \tag{13}\] $\delta(\cdot,X_1^i)$ï¼Œ$p_{1\mid t}^{\theta,i}(\cdot\mid X_t)$éƒ½æ˜¯æ¦‚ç‡è´¨é‡å‡½æ•°ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨KLæ•£åº¦è¡¡é‡äºŒè€…ä¹‹é—´çš„è·ç¦»ï¼Œå³å–Bregmanæ•£åº¦ä¸ºKLæ•£åº¦ï¼Œå¾—åˆ°ï¼š \[L_{CDFM}(\theta) = - \mathbb{E}_{t,X_0,X_1,X_t} \log p_{1\mid t}^{\theta,i}(X_1^i\mid X_t) + \text{const} \tag{14}\] è¿™æ˜¯ç¬¬ä¸€ç§åšæ³•ã€‚ å…³äºå…¬å¼14çš„è¯¦ç»†è¯´æ˜ï¼š KLæ•£åº¦çš„å…¬å¼æ˜¯ï¼š$D(p,q)=\sum_{\alpha \in \mathcal{T}}p(\alpha)\log\cfrac{p(\alpha)}{q(\alpha)}$ã€‚åœ¨é€‰æ‹©KLæ•£åº¦ä¸ºBregmanæ•£åº¦åï¼Œå…¬å¼13å¯ä»¥åŒ–ä¸ºï¼š \[\begin{aligned} L_{CDFM}(\theta) &amp;= \mathbb{E}_{t,X_0,X_1,X_t} \sum_{X_1^i} \delta(x_1^i,X_1^i) \log\cfrac{\delta(x_1^i,X_1^i)}{p_{1\mid t}^{\theta,i}( X_1^i\mid X_t)}\\ &amp;=\mathbb{E}_{t,X_0,X_1,X_t} \sum_{X_1^i}\left[ \delta(x_1^i,X_1^i) \log{\delta(x_1^i,X_1^i)} - \delta(x_1^i,X_1^i) \log{p_{1\mid t}^{\theta,i}( X_1^i\mid X_t)}\right]\\ &amp;= \text{const} - \mathbb{E}_{t,X_0,X_1,X_t} \sum_{X_1^i}\delta(x_1^i,X_1^i) \log{p_{1\mid t}^{\theta,i}( X_1^i\mid X_t)}\\ &amp;\overset{\deltaå‡½æ•°çš„æ€§è´¨}{=} \text{const} - \mathbb{E}_{t,X_0,X_1,X_t} \log{p_{1\mid t}^{\theta,i}(x_1^i\mid X_t)} \end{aligned} \tag{15}\] ç¬¬äºŒç§åšæ³•æ˜¯ä½¿ç”¨1ä¸­å…¬å¼14æ‰€ç¤ºçš„åˆ†è§£CDFMæŸå¤±ï¼Œå¦‚ä¸‹ï¼š \[L_{CDFM}(\theta) = \mathbb{E}_{t,Z,X_t\sim p_{t\mid Z}} \sum_i D_{X_t}^i \left( u_t^i(\cdot,X_t \mid Z), u_t^{\theta,i}(\cdot, X_t) \right) \tag{16}\] å–$Z=(X_0,X_1)$ã€‚ä½¿ç”¨è¯¥å…¬å¼éœ€è¦çŸ¥é“$u_t^{\theta,i}$ï¼Œå› ä¸ºç¥ç»ç½‘ç»œé¢„æµ‹äº†$p_{1\mid t}^{\theta,i}$ï¼Œæ‰€ä»¥$u_t^{\theta,i}$æ˜¯èƒ½ç®—å‡ºæ¥çš„ã€‚ å…¬å¼16ä¸­çš„Bregmanæ•£åº¦å¯ä»¥é€‰æ‹©å¹¿ä¹‰çš„KLæŸå¤±ï¼ˆå…¶è¾“å…¥ä¸ä¸€å®šè¦æ˜¯æ¦‚ç‡åˆ†å¸ƒï¼‰ã€‚å…·ä½“è€Œè¨€ï¼Œå¯¹äºå‘é‡$u,v\in \mathbb R_{\ge 0}^{m}$ï¼Œå¹¿ä¹‰KLæŸå¤±æ˜¯ï¼š \[D(u,v) = \sum_j u^j \log \cfrac{u^j}{v^j} - \sum_j u_j + \sum_jv_j \tag{17}\] è¿™ç§é€‰æ‹©ä¸‹å¯¹åº”çš„Bregmanæ•£åº¦ä¸ºï¼š \[D\left(u_t^i(\cdot,x^i\mid x_0,x_1),u^{i,\theta}_t(\cdot,x)\right)= \cfrac{\dot \kappa_t}{1-\kappa_t}\left[ \left(\delta(x_1^i,x^i) - 1\right)\log p_{1\mid t}^{i,\theta}(x_1^i\mid x) + \delta(x_1^i,x^i)- p_{1\mid t}^{i,\theta}(x^i\mid x) \right] \tag{18}\] æ··åˆè½¨è¿¹é‡‡æ · æˆ‘ä»¬åœ¨1ä¸­çš„å…¬å¼5å·²ç»ç»™å‡ºper coordinateçš„é‡‡æ ·æ–¹å¼ï¼Œç»“åˆå‰é¢è®¨è®ºçš„æ··åˆè·¯å¾„ï¼Œé‡‡æ ·å…¬å¼å¯ä»¥å†™ä¸ºï¼š \[\mathbb{P}(X^i_{t+h}=y^i\mid X_t=x) =\delta(y^i,x^i) + h u_t^i(y^i,x) +o(h) \tag{19}\] åœ¨æ··åˆè·¯å¾„çš„ç‰¹å®šæƒ…å†µä¸‹ä¸ºï¼š \[\begin{aligned} \mathbb{P}(X^i_{t+h}=y^i\mid X_t=x) &amp;\overset{å…¬å¼10}{=} \delta(y^i,x^i) + o(h) + h \sum_{x_1^i} \cfrac{\dot \kappa_t}{1 - \kappa_t} \left[ \delta(y^i,x_1^i) - \delta(y^i,x^i) \right]\sum_{x_0,x_1^{\bar i}} p_{0,1\mid t}(x_0,x_1\mid x)\\ &amp;\overset{å…¬å¼11}{=} \delta(y^i,x^i) + o(h) + h \sum_{x_1^i} \cfrac{\dot \kappa_t}{1 - \kappa_t} \left[ \delta(y^i,x_1^i) - \delta(y^i,x^i) \right] p_{1\mid t}^i(x_1^i\mid x)\\ &amp;\overset{\sum_{x_1^i}p_{1\mid t}^i(x_1^i\mid x)=1 }{=} \sum_{x_1^i}\left[ \delta(y^i,x^i) + h \cfrac{\dot \kappa_t}{1 - \kappa_t} \left[ \delta(y^i,x_1^i) - \delta(y^i,x^i) \right] + o(h) \right] p_{1\mid t}^i(x_1^i\mid x)\\ \end{aligned} \tag{20}\] åœ¨å·²çŸ¥$X_t = x$çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨å…¬å¼20è¿›è¡Œé‡‡æ ·çš„å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š ä»$p_{1\mid t}^i(X_1^i\mid x)$é‡‡æ ·å‡º$X_1^i$ï¼Œ$X_1^i\sim p_{1\mid t}^i(X_1^i\mid x)$ã€‚$p_{1\mid t}^i(X_1^i\mid x)$æ˜¯ç”±æ¨¡å‹é¢„æµ‹å¾—åˆ°ã€‚ åŸºäº$X_t^i$æ›´æ–°å‡º$X_{t+h}^i$ã€‚è¿™ä¸€æ­¥éœ€è¦ä½¿ç”¨4ä¸­å…¬å¼9æ‰€ç¤ºçš„Euler stepï¼Œå¹¶å°†å…¶ä¸­çš„é€Ÿç‡è®¾ç½®ä¸º$\cfrac{\dot \kappa_t}{1 -\kappa_t}\left[\delta(y^i,X_1^i) - \delta(y^i,x^i)\right]$ã€‚è¿™ä¸€æ­¥å†³å®šäº†$X_{t+h}^i=X_t^i$è¿˜æ˜¯$X_{t+h}^i=X_1^i$ã€‚ å•è¾¹æ··åˆè·¯å¾„å’Œä¿æ¦‚ç‡é€Ÿç‡ æˆ‘ä»¬åœ¨ç¬¬ä¸€æ¬¡è®²CTMCçš„é‚£ç¯‡æ–‡ç« 4é‡Œé¢çš„æœ€åä¸€éƒ¨åˆ†è®²äº†ä¸€ä¸‹ä¿æ¦‚ç‡é€Ÿç‡ï¼Œåˆ°è¿™é‡Œç»ˆäºè¦ç”¨åˆ°äº†ã€‚ ç®€å•å›é¡¾ä¸€ä¸‹åœ¨CTMCæ¨¡å‹é‡Œé¢è®²åˆ°çš„ä¿æ¦‚ç‡é€Ÿç‡ï¼Œå®ƒç®€å•çš„è¯´å°±æ˜¯åœ¨å·²æœ‰çš„é€Ÿç‡$u_t(y,x)$ä¸­åŠ å…¥å¦ä¸€ä¸ªé€Ÿç‡$v_t(y,x)$ï¼Œåªè¦$v_t(y,x)$æ˜¯divergence-freeçš„ï¼Œé‚£ä¹ˆ$u_t(y,x)$ç”Ÿæˆæ¦‚ç‡è·¯å¾„ä¸ä¼šæ”¹å˜ã€‚æ‰€è°“divergence-freeï¼ŒæŒ‡$\sum_x v_t(y,x)p_t(x) = 0$ã€‚ å¯¹DFMé‡Œé¢çš„åˆ†è§£æ¡ä»¶æ¦‚ç‡è·¯å¾„$p_{t\mid Z}^i(x^i\mid z)$ï¼Œå…¶å¯¹åº”çš„ä¿æ¦‚ç‡æ¡ä»¶é€Ÿç‡$v_t^i(y^i,x^i\mid z)$æ»¡è¶³ï¼š \[\sum_{x^i} v_t^i(y^i,x^i\mid z)p_{t\mid Z}^i(x^i\mid z) = 0 \tag{21}\] ä¸€èˆ¬æ¥è¯´è¿™ä¸ªä¿æ¦‚ç‡æ¡ä»¶é€Ÿç‡$v_t^i(y^i,x^i\mid z)$ä¸æ˜¯ç‰¹åˆ«å¥½æ‰¾åˆ°ã€‚ä½†æ˜¯å¦‚æœæˆ‘ä»¬èƒ½æœ‰å¦‚ä¸‹ä¸¤ä¸ªå‡è®¾ï¼š iidçš„ç›®æ ‡åˆ†å¸ƒï¼š $p(x) = \prod_i p(x^i)$ã€‚ æºåˆ†å¸ƒå’Œç›®æ ‡åˆ†å¸ƒçš„æ•°æ®ç‹¬ç«‹é…å¯¹ï¼š$\pi_{0,1}(x_0,x_1) = p(x_0)q(x_1)$ã€‚ é‚£ä¹ˆä¿æ¦‚ç‡æ¡ä»¶é€Ÿç‡çš„è§£æå¼è¿˜æ˜¯æ¯”è¾ƒå¥½æ‰¾åˆ°çš„ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬æ¥æ„é€ è¿™ä¸ªä¿æ¦‚ç‡æ¡ä»¶é€Ÿç‡ã€‚ æ ¹æ®å‰é¢çš„ä¸¤æ¡å‡è®¾ï¼Œèƒ½å†™å‡ºæ··åˆè·¯å¾„çš„å½¢å¼å¦‚ä¸‹ï¼š \[p_t(x) = \sum_{x_1} p_{t\mid 1}(x\mid x_1)q(x_1) \text{ where } p_{t\mid 1} (x) = \prod_i p_{t\mid 1}^i(x^i \mid x_1)\\ p_{t\mid 1}^i(x^i \mid x_1) = \kappa_t \delta(x^i,x_1^i) + (1 - \kappa_t)p(x^i) \tag{22}\] è¿™ä¸ªå†™æ³•å’Œæˆ‘ä»¬å‰é¢çš„æ··åˆæ¦‚ç‡è·¯å¾„çš„å†™æ³•çš„å·®å¼‚å°±æ˜¯åªç”¨$x_1$ä½œä¸ºæ¡ä»¶ï¼Œä½†å…¶å®å®ƒå’Œç”¨$x_0,x_1$éƒ½ä½œä¸ºæ¡ä»¶åº”è¯¥æ˜¯ç­‰ä»·çš„ã€‚ ç±»æ¯”å…¬å¼6 \[\begin{aligned} \cfrac{\mathrm{d}}{\mathrm{d}t}p_{t\mid 1}^i(y^i\mid x_1) &amp; \overset{å…¬å¼22}{=} \dot \kappa_t\left[\delta(y^i,x_1^i) - p(x^i)\right] \\ &amp;\overset{ç”¨å…¬å¼22æ¶ˆå»p(x^i)}{=} \dot \kappa_t\left[\delta(y^i,x_1^i) - \cfrac{p^i_{t\mid 1}(y^i\mid x_1)-\kappa_t\delta(y^i,x_1^i)}{1-\kappa_t}\right]\\ &amp;{=} \cfrac{\dot \kappa_t}{1 - \kappa_t}\left[({1-\kappa_t})\delta(y^i,x_1^i) - {p^i_{t\mid 1}(y^i\mid x_1)+\kappa_t\delta(y^i,x_1^i)}\right]\\ &amp;{=} \cfrac{\dot \kappa_t}{1 - \kappa_t} \left[ \delta(y^i,x_1^i) - p^i_{t\mid 1}(y^i\mid x_1) \right]\\ &amp;{=}\sum_{x^i} \cfrac{\dot \kappa_t}{1 - \kappa_t} \left[ \delta(y^i,x_1^i) - \delta(y^i,x^i) \right] p^i_{t\mid 1}(x^i\mid x_1)\\ \end{aligned}\tag{23}\] å¯¹æ¯”Kolmogorovæ–¹ç¨‹ï¼ŒçŸ¥é“ï¼š \[u_t^i(y^i,x^i\mid x_1)=\cfrac{\dot \kappa_t}{1 - \kappa_t} \left[ \delta(y^i,x_1^i) - \delta(y^i,x^i) \right] \tag{24}\] å¯è§$u_t^i(y^i,x^i\mid x_1)$ç”Ÿæˆ$p^i_{t\mid 1}(x^i\mid x_1)$ã€‚å¦‚æœè¦æ‰¾åˆ°å¯¹$p^i_{t\mid 1}(x^i\mid x_1)$è€Œè¨€divergence-freeçš„æ¡ä»¶é€Ÿç‡ï¼Œä¸€ä¸ªç®€å•çš„æŠ€å·§æ˜¯æ‰¾åˆ°ä¸€ä¸ªå’Œ$u_t^i(y^i,x^i\mid x_1)$æ–¹å‘ç›¸åçš„æ¡ä»¶é€Ÿç‡5ï¼Œè¿™æ ·åœ¨æ€»æ—¶é—´èŒƒå›´å†…æŠ˜ä¸¤ä¸ªé€Ÿç‡å·®çš„æ•£åº¦å’Œå°±æ˜¯0ï¼Œæ‰€ä»¥è¿™ä¸¤é€Ÿç‡çš„å·®å°±æ˜¯æˆ‘ä»¬è¦æ‰¾çš„divergence-freeçš„æ¡ä»¶é€Ÿç‡ï¼Œä¹Ÿå°±æ˜¯ä¿æ¦‚ç‡æ¡ä»¶é€Ÿç‡ã€‚è®°è¿™ä¸ªåå‘çš„æ¡ä»¶é€Ÿç‡ä¸º$\tilde u_t^i(y^i,x^i\mid x_1)$ï¼Œå®ƒçš„å½¢å¼åº”è¯¥æ˜¯ï¼š \[\tilde u_t^i(y^i,x^i\mid x_1) = \cfrac{\dot \kappa_t}{\kappa_t} \left[ \delta(y^i,x^i) - p(x^i) \right] \tag{25}\] è¯æ˜åœ¨5çš„E.5å’ŒE.6ä¸­ã€‚ æ‰€ä»¥divergence-freeçš„é€Ÿç‡æ˜¯ï¼š \[v_t^i(y^i,x^i \mid x_1) =u_t^i(y^i,x^i\mid x_1) -\tilde u_t^i(y^i,x^i\mid x_1)\tag{26}\] å› ä¸º$v_t^i(y^i,x^i \mid x_1)$æ˜¯divergence-freeçš„ï¼Œæ‰€ä»¥æŠŠå®ƒä»¥ä»»æ„æ¯”ä¾‹åŠ åˆ°åŸæ¥çš„é€Ÿç‡é‡Œé¢éƒ½ä¸ä¼šå½±å“ç”Ÿæˆçš„æ¦‚ç‡è·¯å¾„ã€‚æ‰€ä»¥å…¬å¼10æ‰€ç¤ºåˆ†è§£è¾¹ç¼˜é€Ÿç‡å¦‚æœæ”¹å†™æˆä¸‹é¢çš„å½¢å¼ï¼š \[\begin{aligned} u_t^i(y^i,x) &amp;=\sum_{x_1} \left[ u_t^i(y^i,x^i\mid x_1) + c_t v_t^i(y^i,x^i\mid x_1) \right]p_{1\mid t}(x_1 \mid x)\\ &amp;=\sum_{x_1^i} \left[ u_t^i(y^i,x^i\mid x_1^i) + c_t v_t^i(y^i,x^i\mid x_1^i) \right]p^i_{1\mid t}(x^i_1 \mid x)\\ \end{aligned} \tag{27}\\\] ä¸å½±å“æ‰€ç”Ÿæˆçš„è¾¹ç¼˜æ¦‚ç‡è·¯å¾„ã€‚ç¬¬äºŒä¸ªç­‰å¼æ˜¯å› ä¸º$u_t^i(y^i,x^i\mid x_1) =u_t^i(y^i,x^i\mid x_1^i)$ï¼Œ$v_t^i(y^i,x^i\mid x_1) =v_t^i(y^i,x^i\mid x_1^i)$ã€‚ é‚£ä¹ˆï¼Œç”¨å…¬å¼27æ‰€ç¤ºçš„é€Ÿç‡è¿›è¡Œé‡‡æ ·çš„æ­¥éª¤æ˜¯ï¼š ä»$p_{1\mid t}^i(X_1^i\mid x)$é‡‡æ ·å‡º$X_1^i$ï¼Œ$X_1^i\sim p_{1\mid t}^i(X_1^i\mid x)$ã€‚$p_{1\mid t}^i(X_1^i\mid x)$æ˜¯ç”±æ¨¡å‹é¢„æµ‹å¾—åˆ°ã€‚ åŸºäº$X_t^i$æ›´æ–°å‡º$X_{t+h}^i$ã€‚è¿™ä¸€æ­¥éœ€è¦ä½¿ç”¨4ä¸­å…¬å¼9æ‰€ç¤ºçš„Euler stepï¼Œå¹¶å°†å…¶ä¸­çš„é€Ÿç‡è®¾ç½®ä¸º \[u_t^i(y^i,x^i\mid x_1) = \cfrac{\dot \kappa_t}{1-\kappa_t}\left[\delta(y^i,X_1^i) - \delta(y^i,x^i)\right] +c_t\left[ \cfrac{\dot \kappa_t}{1-\kappa_t}\left[\delta(y^i,x_1^i) - \delta(y^i,x^i)\right] - \cfrac{\dot \kappa_t}{\kappa_t} \left[\delta(y^i,x^i) - p(x^i)\right] \right] \tag{28}\] å…¶ä¸­$c_t&gt;0$æ˜¯ä¸æ—¶é—´ç›¸å…³çš„å¸¸æ•°ã€‚ åœ¨https://github.com/facebookresearch/flow_matchingåº“é‡Œé¢å®ç°çš„DFMçš„ä»£ç å¦‚ä¸‹ï¼š import torch from flow_matching.path import MixtureDiscreteProbPath, DiscretePathSample from flow_matching.path.scheduler import PolynomialConvexScheduler from flow_matching.loss import MixturePathGeneralizedKL from flow_matching.solver import MixtureDiscreteEulerSolver from flow_matching.utils import ModelWrapper # Define a trainable velocity model model=... optimizer=torch.optim.Adam(model.parameters()) scheduler=PolynomialConvexScheduler(n=1.0) path=MixtureDiscreteProbPath(scheduler=scheduler) loss_fn=MixturePathGeneralizedKL(path=path) # Generalized KL Bregman divergence for x_0, x_1 in dataloader: # Samples from Ï€0,1 of shape [batch_size, *data_dim] t=torch.rand(batch_size) * (1.0 - 1e-3) # Randomize time t âˆ¼ U [0, 1 âˆ’ 10âˆ’3] sample: DiscretePathSample=path.sample(t=t, x_0=x_0, x_1=x_1) # Sample the conditional path model_output=model(sample.x_t, sample.t) loss=loss_fn(logits=model_output, x_1=sample.x_1, x_t=sample.x_t, t=sample.t) # CDFM loss optimizer.zero_grad() loss.backward() optimizer.step() class ProbabilityDenoiser(ModelWrapper): def forward(self, x: torch.Tensor, t: torch.Tensor, **extras) -&gt; torch.Tensor: logits=self.model(x, t, **extras) return torch.nn.functional.softmax(logits.float(), dim=-1) # Sample X1 probability_denoiser=ProbabilityDenoiser(model=model) x_0=torch.randint(size=[batch_size, *data_dim]) # Specify the initial condition solver=MixtureDiscreteEulerSolver( model=probability_denoiser, path=path, vocabulary_size=vocabulary_size ) step_size=1 / 100 x_1=solver.sample(x_init=x_0, step_size=step_size, time_grid=torch.tensor([0.0, 1.0 - 1e-3])) ä¸€ä¸ªç‹¬ç«‹çš„DFMçš„ä»£ç æ¡ˆä¾‹å¦‚ä¸‹ï¼š import torch import matplotlib.pyplot as plt from torch import nn, Tensor from sklearn.datasets import make_moons class DiscreteFlow(nn.Module): def __init__(self, dim: int=2, h: int=128, v: int=128): super().__init__() self.v = v self.embed = nn.Embedding(v, h) self.net = nn.Sequential( nn.Linear(dim * h + 1, h), nn.ELU(), nn.Linear(h, h), nn.ELU(), nn.Linear(h, h), nn.ELU(), nn.Linear(h, dim * v) ) def forward(self, x_t: Tensor, t: Tensor) -&gt; Tensor: return self.net( torch.cat( (t[:, None], self.embed(x_t).flatten(1, 2)), -1 ) ).reshape(list(x_t.shape) + [self.v]) batch_size=256 vocab_size=128 model=DiscreteFlow(v=vocab_size) optim=torch.optim.Adam(model.parameters(), lr=0.001) for _ in range(10000): x_1=Tensor(make_moons(batch_size, noise=0.05)[0]) x_1=torch.round(torch.clip(x_1 * 35 + 50, min=0.0, max=vocab_size - 1)).long() x_0=torch.randint(low=0, high=vocab_size, size=(batch_size, 2)) t=torch.rand(batch_size) x_t=torch.where(torch.rand(batch_size, 2) &lt; t[:, None], x_1, x_0) logits=model(x_t, t) loss=nn.functional.cross_entropy(logits.flatten(0, 1), x_1.flatten(0, 1)).mean() optim.zero_grad() loss.backward() optim.step() x_t=torch.randint(low=0, high=vocab_size, size=(200, 2)) t=0.0 results=[(x_t, t)] while t &lt; 1.0 - 1e-3: p1=torch.softmax(model(x_t, torch.ones(200) * t), dim=-1) h=min(0.1, 1.0 - t) one_hot_x_t=nn.functional.one_hot(x_t, vocab_size).float() u=(p1 - one_hot_x_t) / (1.0 - t) x_t=torch.distributions.Categorical(probs=one_hot_x_t + h * u).sample() t += h results.append((x_t, t)) fig, axes=plt.subplots(1, len(results), figsize=(15, 2), sharex=True, sharey=True) for (x_t, t), ax in zip(results, axes): ax.scatter(x_t.detach()[:, 0], x_t.detach()[:, 1], s=10) ax.set_title(f't={t:.1f}') plt.tight_layout() plt.show() DFMç”Ÿæˆæ•ˆæœå¦‚ä¸‹ï¼š DFMç”Ÿæˆæ•ˆæœ https://zhuanlan.zhihu.com/p/18450992825Â &#8617;Â &#8617;2Â &#8617;3Â &#8617;4Â &#8617;5Â &#8617;6Â &#8617;7 Lipman Y, Chen R T Q, Ben-Hamu H, et al. Flow matching for generative modeling[J]. arXiv preprint arXiv:2210.02747, 2022.Â &#8617;Â &#8617;2 Liu X, Gong C, Liu Q. Flow straight and fast: Learning to generate and transfer data with rectified flow[J]. arXiv preprint arXiv:2209.03003, 2022.Â &#8617; https://zhuanlan.zhihu.com/p/16026053810Â &#8617;Â &#8617;2Â &#8617;3 Gat I, Remez T, Shaul N, et al. Discrete flow matching[J]. arXiv preprint arXiv:2407.15595, 2024.Â &#8617;Â &#8617;2]]></summary></entry><entry><title type="html">ç¦»æ•£å‹æµåŒ¹é…æ¨¡å‹ï¼ˆ2ï¼‰</title><link href="https://ly403.github.io/blog/2025/%E7%A6%BB%E6%95%A3%E6%B5%81%E5%8C%B9%E9%85%8D%E6%A8%A1%E5%9E%8B-2/" rel="alternate" type="text/html" title="ç¦»æ•£å‹æµåŒ¹é…æ¨¡å‹ï¼ˆ2ï¼‰"/><published>2025-01-19T00:00:00+00:00</published><updated>2025-01-19T00:00:00+00:00</updated><id>https://ly403.github.io/blog/2025/%E7%A6%BB%E6%95%A3%E6%B5%81%E5%8C%B9%E9%85%8D%E6%A8%A1%E5%9E%8B%EF%BC%882%EF%BC%89</id><content type="html" xml:base="https://ly403.github.io/blog/2025/%E7%A6%BB%E6%95%A3%E6%B5%81%E5%8C%B9%E9%85%8D%E6%A8%A1%E5%9E%8B-2/"><![CDATA[<p>æ¥ç€ä¸Šä¸€æ¬¡å­¦ä¹ çš„DFMçš„ä¸ŠåŠéƒ¨åˆ†ï¼Œè¿™æ¬¡å­¦ä¹ DFMçš„ä¸‹åŠéƒ¨åˆ†ã€‚ä¸»è¦è¿˜æ˜¯åŸºäºFlow Matching Guide and Code<sup id="fnref:1"><a href="#fn:1" class="footnote" rel="footnote" role="doc-noteref">1</a></sup>ã€‚</p> <h2 id="åˆ†è§£è·¯å¾„é€Ÿåº¦å’ŒæŸå¤±">åˆ†è§£è·¯å¾„ã€é€Ÿåº¦å’ŒæŸå¤±</h2> <p>åœ¨å®é™…å®ç°DFMçš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šæƒ³è¦åƒFM<sup id="fnref:2"><a href="#fn:2" class="footnote" rel="footnote" role="doc-noteref">2</a></sup>ä¸€æ ·ç”¨ç¥ç»ç½‘ç»œé¢„æµ‹ä¸Šä¸€èŠ‚è¯´çš„æ¡ä»¶é€Ÿåº¦åœºï¼Œå³$u^{\theta}_t(y,x) = \mathbb{E}[u_t(y,X_t\mid Z )\mid X_t =x )]$ã€‚ä½†æ˜¯ï¼Œå¦‚æœè¿™æ ·åšï¼Œé‚£ä¹ˆç¥ç»ç½‘ç»œéœ€è¦å¤„ç†éå¸¸å¤šç§æƒ…å†µã€‚å…·ä½“è€Œè¨€ï¼Œå› ä¸º$y\in \mathcal{S}=\mathcal{T}^d$ï¼Œå…¶ä¸­$\mathcal{T} = {1,\cdots, K}$æ˜¯vocabularyï¼Œ$d$æ˜¯å¥å­é•¿åº¦ï¼Œæ‰€ä»¥ç¥ç»ç½‘ç»œè¾“å‡ºçš„å¤§å°ä¸º$K^d$ï¼ˆå¯¹ç¬¬ä¸€ä¸ªè¯è¦è€ƒè™‘$K$ä¸ªçŠ¶æ€ï¼Œå¯¹ç¬¬äºŒä¸ªã€ç¬¬ä¸‰ä¸ªç›´åˆ°ç¬¬$d$ä¸ªè¯éƒ½è¦è€ƒè™‘$K$ä¸ªçŠ¶æ€ï¼Œæ‰€ä»¥æ˜¯$K^d$ï¼‰ã€‚è¿™ä¹ˆå¤§çš„è¾“å‡ºå¤§å°æ˜¯ä¸å¯å®ç°çš„ã€‚ä¸ºè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨<strong>åˆ†è§£ï¼ˆfactorizedï¼‰<sup id="fnref:3"><a href="#fn:3" class="footnote" rel="footnote" role="doc-noteref">3</a></sup>æ–¹æ³•</strong>ã€‚</p> <p>ä¸‹é¢è¦é€ä¸ªä½¿ç”¨è¿™ç§æ–¹æ³•æ¥åˆ†è§£ï¼ˆè¾¹ç¼˜/æ¡ä»¶ï¼‰è·¯å¾„ã€ï¼ˆè¾¹ç¼˜/æ¡ä»¶ï¼‰é€Ÿåº¦å’Œæ¡ä»¶æŸå¤±ã€‚</p> <h3 id="åˆ†è§£è¾¹ç¼˜é€Ÿåº¦">åˆ†è§£è¾¹ç¼˜é€Ÿåº¦</h3> <p>åˆ†è§£æ–¹æ³•çš„æ ¸å¿ƒæ€æƒ³åœ¨äºï¼š<strong>åªè€ƒè™‘æœ€å¤šä¸€ä¸ªtokençš„æ”¹å˜</strong>ã€‚å› ä¸ºå¤šä¸ªtokençš„æ”¹å˜å¯ä»¥è§†ä¸ºé€ä¸ªtokençš„å•æ­¥å˜åŒ–çš„å åŠ ã€‚æ¢è®¨ä¸€ä¸ªtokençš„æ”¹å˜å°±åƒæ¢è®¨åŸºå˜æ¢ä¸€æ ·ã€‚</p> <p>åˆ†è§£è¾¹ç¼˜é€Ÿåº¦çš„å…·ä½“å½¢å¼æ˜¯ï¼š</p> \[u_t(y,x) = \sum_i \delta(y^{\bar{i}},x^{\bar{i}})u_t^i(y^i,x)\tag{1}\] <p>$\bar i = {1,\cdots, i-1,i+1,\cdots,d}$ï¼Œå°±æ˜¯æŠŠ$i$å»æ‰ï¼Œç›¸å½“äºåªè€ƒè™‘ç¬¬$i$ä¸ªtokençš„å˜åŒ–ã€‚åˆ†è§£è¾¹ç¼˜é€Ÿåº¦å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/post/DFM2-480.webp 480w,/assets/img/post/DFM2-800.webp 800w,/assets/img/post/DFM2-1400.webp 1400w," type="image/webp" sizes="95vw"/> <img src="/assets/img/post/DFM2.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption"> åˆ†è§£è¾¹ç¼˜é€Ÿåº¦å›¾ç¤º </div> <p>ç°åœ¨æˆ‘ä»¬åªéœ€è¦ä½¿ç”¨æ¨¡å‹é¢„æµ‹$u_t^{i}(y^i,x)$äº†ã€‚å…¶ä¸­ï¼Œ$i\in [d] = {1,\cdots,d}$ï¼Œ$y^i \in \mathcal{T}$æ˜¯ç¬¬$i$ä¸ªtokençŠ¶æ€æ”¹å˜åæ‰€åœ¨çš„çŠ¶æ€ï¼Œ$x\in \mathcal{S}$ä¸ºçŠ¶æ€è½¬ç§»ä¹‹å‰çš„å…¨éƒ¨tokençš„çŠ¶æ€ï¼Œ$u_t^i(y^i,x) \in \mathbb R$æ˜¯ä¸€ä¸ªæ ‡é‡é€Ÿç‡ã€‚æ‰€ä»¥ï¼Œ<strong>æ¨¡å‹è¦è¾“å‡ºçš„ç»“æœçš„ç»´åº¦æ˜¯$d\cdot K$ï¼ˆæ€»å…±$d$ä¸ªtokenï¼Œæ¯ä¸ªtokenæœ‰$K$ç§å¯ä»¥æ”¹å˜åˆ°çš„çŠ¶æ€ï¼Œå¯¹åº”$d\cdot K$ç§é€Ÿç‡ï¼‰ï¼Œç›¸æ¯”ä¹‹å‰çš„$K^d$å¤§å¤§å‡å°</strong>ã€‚</p> <p>åˆ†è§£çš„è¾¹ç¼˜é€Ÿç‡è¿˜æ˜¯è¦æ»¡è¶³é€Ÿç‡æ¡ä»¶ï¼Œä¸è¿‡æ˜¯è¦æŒ‰ç…§æ¯ä¸ªtokençš„å±‚çº§è¿›è¡Œæè¿°ï¼Œå¦‚ä¸‹ï¼š</p> \[u_t^i(y^i,x)\ge 0 \text{ for all } y^i \neq x^i \text{, and } \sum_{y^i \in \mathcal{T}}{u^i_t(y^i,x)} = 0 \quad \text{for all }x \in \mathcal{S} \tag{2}\] <p>$\forall i\in [d]$ï¼Œå…¬å¼ï¼ˆ2ï¼‰éƒ½è¦æ»¡è¶³ã€‚</p> <p>æ—¢ç„¶æˆ‘ä»¬æœ‰äº†åˆ†è§£è¾¹ç¼˜æ¦‚ç‡ï¼Œé‚£ä¹ˆé‡‡æ ·è¿‡ç¨‹ä¹Ÿå¯ä»¥coordinate-wiseï¼ˆé€ç»´ï¼‰åœ°è¿›è¡Œï¼Œä»£å…¥å…¬å¼ï¼ˆ1ï¼‰åˆ°CTMCæ¨¡å‹çš„è½¬ç§»æ ¸ä¹‹ä¸­ï¼Œå³ï¼š</p> \[\begin{aligned} \mathbb{P}(X_{t+h}=y\mid X_t = x)&amp;=\delta(y,x)+hu_t(y,x)+o(h)\\ &amp;\overset{ä»£å…¥å…¬å¼(1)}{=} \delta(y,x)+h\sum_i \delta(y^{\bar{i}},x^{\bar{i}})u_t^i(y^i,x)+o(h)\\ &amp;\overset{å…¬å¼(4)}{=} \prod_{i}\left[ \delta(y^i,x^i) + h u_t^i(y^i,x) +o(h) \right] \end{aligned} \tag{3}\] <blockquote> <p>å…¬å¼ï¼ˆ3ï¼‰ç¬¬äºŒä¸ªç­‰å·åŸºäºå¦‚ä¸‹ç­‰å¼ï¼š</p> \[\prod_i\left[ a^i + h b^i \right] = \prod_i a^i + h\sum_{i}\left(\prod_{j\neq i}a^j\right) b^i + o(h) \tag{4}\] <p>å–$a^i = \delta(y^i,x^i)$ï¼Œ$b^i = u_t^i(y^i,x)$ï¼ŒåŒæ—¶æ³¨æ„åˆ°$\prod_i \delta(y^i,x^i) = \delta(y,x)$ï¼Œå°±å¾—å‡ºäº†å…¬å¼ï¼ˆ3ï¼‰ä¸­ç¬¬äºŒä¸ªç­‰å·è¡¨ç¤ºçš„å…³ç³»ã€‚</p> </blockquote> <p>æ‰€ä»¥æˆ‘ä»¬è¿˜å¯ä»¥ç”¨åˆ†è§£è¾¹ç¼˜é€Ÿç‡å®šä¹‰ä¸€ä¸ªåˆ†è§£è½¬ç§»æ ¸ç”¨ä»¥é‡‡æ ·ï¼š</p> \[\begin{aligned} \mathbb{P}(X^i_{t+h}=y^i\mid X_t = x) &amp;=\delta(y^i,x^i) + h u_t^i(y^i,x) +o(h) \\ \mathbb{P}(X_{t+h}=y\mid X_t = x) &amp;=\prod_i\mathbb{P}(X^i_{t+h}=y^i\mid X_t = x) \end{aligned}\tag{5}\] <p>é‡‡æ ·æ–¹æ³•è¿˜æ˜¯å¯ä»¥ç”¨CTMCæ¨¡å‹é‡Œé¢è¯´è¿‡çš„Euleræ³•ï¼Œä½†æ˜¯è¿™é‡Œæ˜¯per coordinateçš„é‡‡æ ·ï¼Œå³æ¯ä¸€ç»´å•ç‹¬è¿›è¡Œé‡‡æ ·ã€‚</p> <p>å…¶å®FMçš„é‡‡æ ·ä¹Ÿå¯ä»¥å†™æˆç±»ä¼¼çš„åˆ†è§£çš„å½¢å¼ï¼Œä½†ä¸€èˆ¬ä¸è¿™ä¹ˆç”¨ã€‚å€¼å¾—ä¸€æçš„æ˜¯ï¼š<strong>FMçš„é‡‡æ ·æ˜¯ç¡®å®šæ€§çš„ï¼Œè€ŒDFMçš„é‡‡æ ·å…·æœ‰éšæœºæ€§</strong>ã€‚</p> <h3 id="åˆ†è§£è¾¹ç¼˜æ¦‚ç‡è·¯å¾„">åˆ†è§£è¾¹ç¼˜æ¦‚ç‡è·¯å¾„</h3> <p>ä¸Šé¢æˆ‘ä»¬å·²ç»å®ç°äº†åˆ†è§£è¾¹ç¼˜é€Ÿåº¦ï¼Œç°åœ¨è€ƒè™‘ç”¨ä¸€æ ·çš„æ–¹æ³•åˆ†è§£è¾¹ç¼˜æ¦‚ç‡è·¯å¾„$q_t(x)$ï¼š</p> \[q_t(x) = \prod_{i}q_t^i(x^i)\tag{6}\] <p>å…¶ä¸­ï¼Œ$q_t^i(x^i)$å°±æ˜¯åˆ†è§£åçš„è¾¹ç¼˜æ¦‚ç‡è·¯å¾„ã€‚</p> <p>æ¥ä¸‹æ¥æˆ‘ä»¬æƒ³è¯´æ˜ï¼š<strong>åˆ†è§£è¾¹ç¼˜é€Ÿç‡ç”Ÿæˆåˆ†è§£è¾¹ç¼˜æ¦‚ç‡è·¯å¾„æ—¶ï¼Œéåˆ†è§£çš„è¾¹ç¼˜é€Ÿç‡ä¹Ÿèƒ½ç”Ÿæˆéåˆ†è§£çš„è¾¹ç¼˜æ¦‚ç‡è·¯å¾„</strong>ï¼Œä¹Ÿå°±æ˜¯å¸Œæœ›è¾¹ç¼˜é€Ÿç‡å’Œè¾¹ç¼˜æ¦‚ç‡è·¯å¾„çš„å…³ç³»åœ¨åˆ†è§£å’Œéåˆ†è§£å½¢å¼ä¸‹éƒ½ä¿ç•™ã€‚å…·ä½“è€Œè¨€å°±æ˜¯å¦‚ä¸‹å‘½é¢˜ï¼š</p> <p><strong>å‘½é¢˜2</strong> ä»¤$q_t(x)$ç”±å…¬å¼ï¼ˆ6ï¼‰æ‰€ç¤ºçš„åˆ†è§£å½¢å¼å®šä¹‰ï¼Œå½“$u_t^i(y^i,x^i)\in C([0,1))$èƒ½å¤Ÿç”Ÿæˆ$q_t^i(x^i)$æ—¶ï¼Œé‚£ä¹ˆ$q_t$ç”±å¦‚ä¸‹åˆ†è§£å½¢å¼çš„è¾¹ç¼˜é€Ÿç‡ç”Ÿæˆï¼š</p> \[u_t(y,x)=\sum_i\delta(y^{\bar i},x^{\bar i})u_t^i(y^i,x^i) \tag{7}\] <blockquote> <p>å‘½é¢˜2çš„è¯æ˜å¦‚ä¸‹ï¼š</p> <p>é¦–å…ˆæ ¹æ®è¾¹ç¼˜æ¦‚ç‡çš„å®šä¹‰ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°$x^i$å’Œ$x^{\bar i}$çš„è¾¹ç¼˜æ¦‚ç‡å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼è®¡ç®—ï¼ˆå°±æ˜¯æŠŠæ— å…³çš„å˜é‡æ±‚å’Œæ‰ï¼‰ï¼š</p> \[q^i(x^i) := \sum_{x^{\bar i}}q(x) \quad q^{\bar i }(x^{\bar i }) :=\sum_{x^i} q(x) \tag{8}\] <p>æ¨å¯¼å¦‚ä¸‹ï¼š</p> \[\begin{aligned} \cfrac{\mathrm{d}}{\mathrm{d}t}q_t(y) &amp;\overset{ä»£å…¥å…¬å¼(6)}{=} \cfrac{\mathrm{d}}{\mathrm{d}t}\prod_i q_t^i(y^i)\\ &amp;\overset{ä¹˜æ³•æ±‚å¯¼æ³•åˆ™}{=} \sum_i q^{\bar i}_t(y^{\bar i}) \cfrac{\mathrm{d}}{\mathrm{d}t}q_t^i(y^i)\\ &amp;\overset{\text{Kolmogorov}æ–¹ç¨‹}{=} \sum_i q^{\bar i}_t(y^{\bar i}) \left[ \sum_{x^i} u_t^i(y^i,x^i)q_t^i(x^i) \right]\\ &amp;\overset{(*)}{=} \sum_i \left[ \sum_{x^{\bar i}}\delta(y^{\bar i}, x^{\bar i} ) q_t^{\bar i}(x^{\bar i}) \right] \left[ \sum_{x^i} u_t^i(y^i,x^i)q_t^i(x^i) \right]\\ &amp;\overset{åˆ†é…å¾‹}{=} \sum_i \sum_{x^{\bar i}}\sum_{x^i} \left[ \delta(y^{\bar i}, x^{\bar i} ) q_t^{\bar i}(x^{\bar i}) u_t^i(y^i,x^i)q_t^i(x^i) \right]\\ &amp;\overset{åˆå¹¶x^iå’Œx^{\bar i}}{=} \sum_i \sum_{x} \left[ \delta(y^{\bar i}, x^{\bar i} ) u_t^i(y^i,x^i)q_t(x) \right]\\ &amp;\overset{äº¤æ¢æ±‚å’Œé¡ºåº}{=} \sum_{x}\left[\sum_i \left[ \delta(y^{\bar i}, x^{\bar i} ) u_t^i(y^i,x^i) \right]q_t(x)\right]\\ \end{aligned} \tag{9}\] <p>ï¼ˆ*ï¼‰å¼åŸºäº$q_t^{\bar i }(y^{\bar i}) = \sum_{x^{\bar i}}\delta(y^{\bar i}, x^{\bar i})q_t^{\bar i}(x^{\bar i})$ã€‚æ ¹æ®æœ€åç»“æœï¼Œå¯¹æ¯”Kolmogorovæ–¹ç¨‹ï¼Œå°±çŸ¥é“$u_t(y,x)=\sum_i\delta(y^{\bar i},x^{\bar i})u_t^i(y^i,x^i)$äº†ã€‚</p> </blockquote> <h3 id="åˆ†è§£æ¡ä»¶é€Ÿç‡å’Œæ¡ä»¶æ¦‚ç‡è·¯å¾„">åˆ†è§£æ¡ä»¶é€Ÿç‡å’Œæ¡ä»¶æ¦‚ç‡è·¯å¾„</h3> <p>æ¥ä¸‹æ¥æˆ‘ä»¬è¿˜éœ€è¦åˆ†è§£æ¡ä»¶é€Ÿç‡å’Œæ¡ä»¶æ¦‚ç‡è·¯å¾„ã€‚æ¢å¥è¯è¯´ï¼Œæˆ‘ä»¬å¸Œæœ›å¾—åˆ°åˆ†è§£ç‰ˆçš„ç¦»æ•£è¾¹ç¼˜åŒ–æŠ€å·§ï¼ˆDiscrete Factorized Marginalization Trickï¼‰ã€‚</p> <p><strong>å®šç†16</strong>ï¼ˆDiscrete Factorized Marginalization Trickï¼‰è€ƒè™‘ä¸€ä¸ªè¾¹ç¼˜æ¦‚ç‡è·¯å¾„é€šè¿‡å¦‚ä¸‹æ–¹å¼æ„é€ ï¼š</p> \[p_t(x) =\sum_z p_{t\mid Z}(x \mid z) p_Z(z)\text{, with }p_{t\mid Z}(x\mid z)= \prod_ip_{t\mid Z}^i(x^i\mid z)\tag{10}\] <p>å…¶ä¸­ï¼Œ$p_{t\mid Z}^i(x^i\mid z)$æ˜¯åˆ†è§£æ¡ä»¶æ¦‚ç‡è·¯å¾„ï¼Œå°±åƒå…¬å¼ï¼ˆ6ï¼‰ä¸­çš„åˆ†è§£è¾¹ç¼˜æ¦‚ç‡è·¯å¾„ä¸€æ ·ã€‚</p> <p>å‡è®¾ï¼š$\forall x \in \mathcal{S}, \forall t\in[0,1)$ï¼Œ $p_t(x) &gt; 0$ã€‚<strong>åˆ†è§£æ¡ä»¶é€Ÿç‡$u_t^{i}(y^i, x^i \mid z) \in C([0,1))$<font color="red">ç”Ÿæˆ</font>åˆ†è§£æ¡ä»¶æ¦‚ç‡è·¯å¾„$p_{t\mid Z}^i(x^i\mid z) \in C^1([0,1))$ã€‚</strong></p> <p><strong>å‡è®¾æ»¡è¶³æ—¶ï¼Œè¾¹ç¼˜é€Ÿç‡</strong></p> \[u_t(y,x) =\sum_i\delta(y^{\bar i},x^{\bar i})u_t^i(y^i,x)\tag{11}\] <p><strong><font color="red">ç”Ÿæˆ</font>è¾¹ç¼˜æ¦‚ç‡è·¯å¾„$p_t(x)$ã€‚</strong></p> <p>å…¶ä¸­</p> \[u_t^i(y^i,x)=\sum_z u_t^i(y^i,x^i\mid z)p_{Z\mid t}(z\mid x) = \mathbb{E} \left[ u_t^i(y^i,X_t^i\mid Z) \mid X_t = x \right]\tag{12}\] <blockquote> <p>å®šç†16çš„è¯æ˜å¦‚ä¸‹</p> \[\begin{aligned} u_t(y,x) &amp;\overset{(*)}{=}\sum_z u_t(y,x\mid z)p_{Z\mid t}(z\mid x)\\ &amp;\overset{å…¬å¼(7)}{=}\sum_z \left[ \sum_i\delta(y^{\bar i},x^{\bar i})u_t^i(y^i,x^i\mid z) \right] p_{Z\mid t}(z\mid x)\\ &amp;\overset{äº¤æ¢æ±‚å’Œé¡ºåº}{=}\sum_i \delta(y^{\bar i},x^{\bar i}) \underbrace{\left[ \sum_z u_t^i(y^i,x^i\mid z) p_{Z\mid t}(z\mid x) \right]}_{u_t^i(y^i,x)} \\ \end{aligned} \tag{13}\] <p>ï¼ˆ*ï¼‰æ­¥æ˜¯æˆ‘ä»¬åœ¨DFMä¸Šä¸€èŠ‚<sup id="fnref:4"><a href="#fn:4" class="footnote" rel="footnote" role="doc-noteref">4</a></sup>ä¸­å·²ç»å¾—åˆ°çš„ç»“è®ºã€‚</p> <p>é‚£ä¹ˆæ ¹æ®ï¼ˆ13ï¼‰å¼ï¼Œå°±çŸ¥é“å…¬å¼ï¼ˆ11ï¼‰å’Œï¼ˆ12ï¼‰äº†ã€‚</p> <p>æ¥ä¸‹æ¥æˆ‘ä»¬è¿˜è¦è¯´æ˜<strong>å…¬å¼ï¼ˆ11ï¼‰è¡¨ç¤ºçš„è¾¹ç¼˜é€Ÿç‡èƒ½å¤Ÿ<font color="red">ç”Ÿæˆ</font>è¾¹ç¼˜æ¦‚ç‡è·¯å¾„$p_t(x)$</strong>ï¼Œè¿™éœ€è¦ç”¨åˆ°æˆ‘ä»¬ä¸Šä¸€èŠ‚<sup id="fnref:4:1"><a href="#fn:4" class="footnote" rel="footnote" role="doc-noteref">4</a></sup>è®²çš„ç¦»æ•£è¾¹ç¼˜åŒ–æŠ€å·§ï¼Œç¦»æ•£è¾¹ç¼˜åŒ–æŠ€å·§æœ‰ä½¿ç”¨çš„å‡è®¾ï¼Œå³ $p_{t\mid Z}(x\mid z)\in C^{1}([0,1))$ï¼Œ$u_t(y,x\mid z)\in C([0,1))$ã€‚æˆ‘ä»¬æ¥ä¸‹æ¥è¯´æ˜è¿™ä¸ªå‡è®¾èƒ½æ»¡è¶³ã€‚</p> <p>æ ¹æ®å®šç†16çš„å‡è®¾å¯çŸ¥$p_{t\mid Z}^i(x^i\mid z) \in C^1([0,1))$ï¼Œ$\forall t \in C([0,1)), p_t(x) &gt; 0$ï¼Œæ‰€ä»¥æ ¹æ®$p_{t\mid Z}(x\mid z)=\prod_ip_{t\mid Z}^i(x^i\mid z)$å¯çŸ¥$p_{t\mid Z}(x\mid z)\in C^1([0,1))$ã€‚æ ¹æ®å®šç†16çš„å‡è®¾å¯çŸ¥$u_t^{i}(y^i, x^i \mid z) \in C([0,1))$ï¼Œæ ¹æ®å…¬å¼7æˆ‘ä»¬çŸ¥é“$u_t(y,x\mid z)=\sum_i\delta(y^{\bar i},x^{\bar i})u_t^i(y^i,x^i\mid z)$ï¼Œæ‰€ä»¥å¯ä»¥çŸ¥é“$u_t(y,x\mid z)\in C([0,1))$ã€‚</p> <p>æ‰€ä»¥ç¦»æ•£è¾¹ç¼˜åŒ–æŠ€å·§å‡è®¾æ»¡è¶³ï¼Œå¯ä»¥åº”ç”¨è¯¥æŠ€å·§ï¼Œå¾—å‡º</p> <p><strong>å…¬å¼ï¼ˆ11ï¼‰è¡¨ç¤ºçš„è¾¹ç¼˜é€Ÿç‡$u_t(y,x)$èƒ½å¤Ÿ<font color="red">ç”Ÿæˆ</font>è¾¹ç¼˜æ¦‚ç‡è·¯å¾„$p_t(x)$</strong>ã€‚</p> <p>æ‰€ä»¥ï¼Œå®šç†16å¾—åˆ°è¯æ˜ã€‚</p> </blockquote> <h3 id="åˆ†è§£æ¡ä»¶æŸå¤±å‡½æ•°">åˆ†è§£æ¡ä»¶æŸå¤±å‡½æ•°</h3> <p>æˆ‘ä»¬å¯ä»¥è®©æ¨¡å‹é¢„æµ‹åˆ†è§£å½¢å¼çš„é€Ÿç‡$u_t^{\theta,i}$ï¼Œæ›¿ä»£åŸå…ˆé¢„æµ‹éåˆ†è§£å½¢å¼é€Ÿç‡$u_t^{\theta}$çš„å½¢å¼ï¼Œé‚£ä¹ˆæ¡ä»¶æŸå¤±å‡½æ•°çš„å½¢å¼å¯ä»¥æ”¹å†™ä¸ºï¼š</p> \[L_{CDFM}(\theta) = \mathbb{E}_{t,Z,X_t\sim p_{t\mid Z}} \sum_i D_{X_t}^i \left( u_t^i(\cdot,X_t \mid Z), u_t^{\theta,i}(\cdot, X_t) \right) \tag{14}\] <p>å…¶ä¸­ï¼Œ$t\in U[0,1]$ï¼Œ$u_t^{i}(\cdot,x\mid z), u_t^{\theta,i}(\cdot,x) \in \mathbb{R}^{\mathcal{T}}$ã€‚$u_t^{i}(\cdot,x\mid z),u_t^{\theta,i}(\cdot,x)$éœ€è¦æ»¡è¶³é€Ÿç‡æ¡ä»¶ã€‚$D_{x}^i(u,v)$æ˜¯åˆ†è§£åçš„Bregmanæ•£åº¦ã€‚</p> <blockquote> <p>å…³äº$u_t^{i}(\cdot,x\mid z),u_t^{\theta,i}(\cdot,x)$æ»¡è¶³é€Ÿç‡æ¡ä»¶ï¼Œå¯ä»¥ç”¨æ›´å½¢å¼åŒ–çš„æ–¹å¼è¡¨è¾¾ï¼š</p> <p>å®šä¹‰ï¼š å¯¹äº$\alpha \in \mathcal{T}$ï¼Œ</p> \[\Omega_{\alpha} = \left\{ v \in \mathbb{R}^{\mathcal{T}}\mid v(\beta)\ge 0 \text{ }\forall\beta \in \mathcal{T}\backslash \{\alpha\}\text{, and } v(\alpha) = -\sum_{\beta\neq \alpha} v(\beta) \right\} \subset \mathbb{R}^{\mathcal{T}}\tag{15}\] <p>$\Omega_{\alpha}$æ˜¾ç„¶æ˜¯ä¸ªå‡¸é›†åˆã€‚</p> <p>å½¢å¼åŒ–çš„è¯´ï¼Œ$u_t^{i}(\cdot,x\mid z),u_t^{\theta,i}(\cdot,x)$æ»¡è¶³é€Ÿç‡æ¡ä»¶ï¼Œå°±æ˜¯$u_t^{i}(\cdot,x\mid z),u_t^{\theta,i}(\cdot,x)\in \Omega_{x^i}$ã€‚</p> <p>å…³äº$D_{x}^i(u,v)$ï¼Œåœ¨<sup id="fnref:4:2"><a href="#fn:4" class="footnote" rel="footnote" role="doc-noteref">4</a></sup>ä¸­è¯´è¿‡ï¼Œå®ƒéœ€è¦ä¸€ä¸ªå‡¸å‡½æ•°æ¥å®šä¹‰ã€‚ä¸è¿‡ç›¸æ¯”äºéåˆ†è§£çš„$D_x(u,v)$ï¼Œ$D_{x}^i(u,v)$éœ€è¦çš„ä¹Ÿæ˜¯ä¸€ä¸ªåˆ†è§£çš„å‡¸å‡½æ•°ï¼Œå¯ä»¥è®°ä¸º$\Phi_x^i : \Omega_{x^i} \to \mathbb R$ã€‚</p> </blockquote> <hr/> <div class="footnotes" role="doc-endnotes"> <ol> <li id="fn:1"> <p>Lipman Y, Havasi M, Holderrieth P, et al. Flow Matching Guide and Code[J]. arXiv preprint arXiv:2412.06264, 2024.Â <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:2"> <p>Lipman Y, Chen R T Q, Ben-Hamu H, et al. Flow matching for generative modeling[J]. arXiv preprint arXiv:2210.02747, 2022.Â <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:3"> <p>Campbell A, Benton J, De Bortoli V, et al. A continuous time framework for discrete denoising models[J]. Advances in Neural Information Processing Systems, 2022, 35: 28266-28279.Â <a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:4"> <p><a href="https://zhuanlan.zhihu.com/p/16493879333">https://zhuanlan.zhihu.com/p/16493879333</a>Â <a href="#fnref:4" class="reversefootnote" role="doc-backlink">&#8617;</a>Â <a href="#fnref:4:1" class="reversefootnote" role="doc-backlink">&#8617;<sup>2</sup></a>Â <a href="#fnref:4:2" class="reversefootnote" role="doc-backlink">&#8617;<sup>3</sup></a></p> </li> </ol> </div>]]></content><author><name></name></author><category term="Flow_Matching"/><category term="Discrete_Flow_Matching"/><category term="formatting"/><category term="math"/><summary type="html"><![CDATA[æ¥ç€ä¸Šä¸€æ¬¡å­¦ä¹ çš„DFMçš„ä¸ŠåŠéƒ¨åˆ†ï¼Œè¿™æ¬¡å­¦ä¹ DFMçš„ä¸‹åŠéƒ¨åˆ†ã€‚ä¸»è¦è¿˜æ˜¯åŸºäºFlow Matching Guide and Code1ã€‚ åˆ†è§£è·¯å¾„ã€é€Ÿåº¦å’ŒæŸå¤± åœ¨å®é™…å®ç°DFMçš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¼šæƒ³è¦åƒFM2ä¸€æ ·ç”¨ç¥ç»ç½‘ç»œé¢„æµ‹ä¸Šä¸€èŠ‚è¯´çš„æ¡ä»¶é€Ÿåº¦åœºï¼Œå³$u^{\theta}_t(y,x) = \mathbb{E}[u_t(y,X_t\mid Z )\mid X_t=x )]$ã€‚ä½†æ˜¯ï¼Œå¦‚æœè¿™æ ·åšï¼Œé‚£ä¹ˆç¥ç»ç½‘ç»œéœ€è¦å¤„ç†éå¸¸å¤šç§æƒ…å†µã€‚å…·ä½“è€Œè¨€ï¼Œå› ä¸º$y\in \mathcal{S}=\mathcal{T}^d$ï¼Œå…¶ä¸­$\mathcal{T} = {1,\cdots, K}$æ˜¯vocabularyï¼Œ$d$æ˜¯å¥å­é•¿åº¦ï¼Œæ‰€ä»¥ç¥ç»ç½‘ç»œè¾“å‡ºçš„å¤§å°ä¸º$K^d$ï¼ˆå¯¹ç¬¬ä¸€ä¸ªè¯è¦è€ƒè™‘$K$ä¸ªçŠ¶æ€ï¼Œå¯¹ç¬¬äºŒä¸ªã€ç¬¬ä¸‰ä¸ªç›´åˆ°ç¬¬$d$ä¸ªè¯éƒ½è¦è€ƒè™‘$K$ä¸ªçŠ¶æ€ï¼Œæ‰€ä»¥æ˜¯$K^d$ï¼‰ã€‚è¿™ä¹ˆå¤§çš„è¾“å‡ºå¤§å°æ˜¯ä¸å¯å®ç°çš„ã€‚ä¸ºè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨åˆ†è§£ï¼ˆfactorizedï¼‰3æ–¹æ³•ã€‚ ä¸‹é¢è¦é€ä¸ªä½¿ç”¨è¿™ç§æ–¹æ³•æ¥åˆ†è§£ï¼ˆè¾¹ç¼˜/æ¡ä»¶ï¼‰è·¯å¾„ã€ï¼ˆè¾¹ç¼˜/æ¡ä»¶ï¼‰é€Ÿåº¦å’Œæ¡ä»¶æŸå¤±ã€‚ åˆ†è§£è¾¹ç¼˜é€Ÿåº¦ åˆ†è§£æ–¹æ³•çš„æ ¸å¿ƒæ€æƒ³åœ¨äºï¼šåªè€ƒè™‘æœ€å¤šä¸€ä¸ªtokençš„æ”¹å˜ã€‚å› ä¸ºå¤šä¸ªtokençš„æ”¹å˜å¯ä»¥è§†ä¸ºé€ä¸ªtokençš„å•æ­¥å˜åŒ–çš„å åŠ ã€‚æ¢è®¨ä¸€ä¸ªtokençš„æ”¹å˜å°±åƒæ¢è®¨åŸºå˜æ¢ä¸€æ ·ã€‚ åˆ†è§£è¾¹ç¼˜é€Ÿåº¦çš„å…·ä½“å½¢å¼æ˜¯ï¼š \[u_t(y,x) = \sum_i \delta(y^{\bar{i}},x^{\bar{i}})u_t^i(y^i,x)\tag{1}\] $\bar i={1,\cdots, i-1,i+1,\cdots,d}$ï¼Œå°±æ˜¯æŠŠ$i$å»æ‰ï¼Œç›¸å½“äºåªè€ƒè™‘ç¬¬$i$ä¸ªtokençš„å˜åŒ–ã€‚åˆ†è§£è¾¹ç¼˜é€Ÿåº¦å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š åˆ†è§£è¾¹ç¼˜é€Ÿåº¦å›¾ç¤º ç°åœ¨æˆ‘ä»¬åªéœ€è¦ä½¿ç”¨æ¨¡å‹é¢„æµ‹$u_t^{i}(y^i,x)$äº†ã€‚å…¶ä¸­ï¼Œ$i\in [d] = {1,\cdots,d}$ï¼Œ$y^i \in \mathcal{T}$æ˜¯ç¬¬$i$ä¸ªtokençŠ¶æ€æ”¹å˜åæ‰€åœ¨çš„çŠ¶æ€ï¼Œ$x\in \mathcal{S}$ä¸ºçŠ¶æ€è½¬ç§»ä¹‹å‰çš„å…¨éƒ¨tokençš„çŠ¶æ€ï¼Œ$u_t^i(y^i,x) \in \mathbb R$æ˜¯ä¸€ä¸ªæ ‡é‡é€Ÿç‡ã€‚æ‰€ä»¥ï¼Œæ¨¡å‹è¦è¾“å‡ºçš„ç»“æœçš„ç»´åº¦æ˜¯$d\cdot K$ï¼ˆæ€»å…±$d$ä¸ªtokenï¼Œæ¯ä¸ªtokenæœ‰$K$ç§å¯ä»¥æ”¹å˜åˆ°çš„çŠ¶æ€ï¼Œå¯¹åº”$d\cdot K$ç§é€Ÿç‡ï¼‰ï¼Œç›¸æ¯”ä¹‹å‰çš„$K^d$å¤§å¤§å‡å°ã€‚ åˆ†è§£çš„è¾¹ç¼˜é€Ÿç‡è¿˜æ˜¯è¦æ»¡è¶³é€Ÿç‡æ¡ä»¶ï¼Œä¸è¿‡æ˜¯è¦æŒ‰ç…§æ¯ä¸ªtokençš„å±‚çº§è¿›è¡Œæè¿°ï¼Œå¦‚ä¸‹ï¼š \[u_t^i(y^i,x)\ge 0 \text{ for all } y^i \neq x^i \text{, and } \sum_{y^i \in \mathcal{T}}{u^i_t(y^i,x)} = 0 \quad \text{for all }x \in \mathcal{S} \tag{2}\] $\forall i\in [d]$ï¼Œå…¬å¼ï¼ˆ2ï¼‰éƒ½è¦æ»¡è¶³ã€‚ æ—¢ç„¶æˆ‘ä»¬æœ‰äº†åˆ†è§£è¾¹ç¼˜æ¦‚ç‡ï¼Œé‚£ä¹ˆé‡‡æ ·è¿‡ç¨‹ä¹Ÿå¯ä»¥coordinate-wiseï¼ˆé€ç»´ï¼‰åœ°è¿›è¡Œï¼Œä»£å…¥å…¬å¼ï¼ˆ1ï¼‰åˆ°CTMCæ¨¡å‹çš„è½¬ç§»æ ¸ä¹‹ä¸­ï¼Œå³ï¼š \[\begin{aligned} \mathbb{P}(X_{t+h}=y\mid X_t=x)&amp;=\delta(y,x)+hu_t(y,x)+o(h)\\ &amp;\overset{ä»£å…¥å…¬å¼(1)}{=} \delta(y,x)+h\sum_i \delta(y^{\bar{i}},x^{\bar{i}})u_t^i(y^i,x)+o(h)\\ &amp;\overset{å…¬å¼(4)}{=} \prod_{i}\left[ \delta(y^i,x^i) + h u_t^i(y^i,x) +o(h) \right] \end{aligned} \tag{3}\] å…¬å¼ï¼ˆ3ï¼‰ç¬¬äºŒä¸ªç­‰å·åŸºäºå¦‚ä¸‹ç­‰å¼ï¼š \[\prod_i\left[ a^i + h b^i \right] = \prod_i a^i + h\sum_{i}\left(\prod_{j\neq i}a^j\right) b^i + o(h) \tag{4}\] å–$a^i = \delta(y^i,x^i)$ï¼Œ$b^i = u_t^i(y^i,x)$ï¼ŒåŒæ—¶æ³¨æ„åˆ°$\prod_i \delta(y^i,x^i) = \delta(y,x)$ï¼Œå°±å¾—å‡ºäº†å…¬å¼ï¼ˆ3ï¼‰ä¸­ç¬¬äºŒä¸ªç­‰å·è¡¨ç¤ºçš„å…³ç³»ã€‚ æ‰€ä»¥æˆ‘ä»¬è¿˜å¯ä»¥ç”¨åˆ†è§£è¾¹ç¼˜é€Ÿç‡å®šä¹‰ä¸€ä¸ªåˆ†è§£è½¬ç§»æ ¸ç”¨ä»¥é‡‡æ ·ï¼š \[\begin{aligned} \mathbb{P}(X^i_{t+h}=y^i\mid X_t=x) &amp;=\delta(y^i,x^i) + h u_t^i(y^i,x) +o(h) \\ \mathbb{P}(X_{t+h}=y\mid X_t=x) &amp;=\prod_i\mathbb{P}(X^i_{t+h}=y^i\mid X_t=x) \end{aligned}\tag{5}\] é‡‡æ ·æ–¹æ³•è¿˜æ˜¯å¯ä»¥ç”¨CTMCæ¨¡å‹é‡Œé¢è¯´è¿‡çš„Euleræ³•ï¼Œä½†æ˜¯è¿™é‡Œæ˜¯per coordinateçš„é‡‡æ ·ï¼Œå³æ¯ä¸€ç»´å•ç‹¬è¿›è¡Œé‡‡æ ·ã€‚ å…¶å®FMçš„é‡‡æ ·ä¹Ÿå¯ä»¥å†™æˆç±»ä¼¼çš„åˆ†è§£çš„å½¢å¼ï¼Œä½†ä¸€èˆ¬ä¸è¿™ä¹ˆç”¨ã€‚å€¼å¾—ä¸€æçš„æ˜¯ï¼šFMçš„é‡‡æ ·æ˜¯ç¡®å®šæ€§çš„ï¼Œè€ŒDFMçš„é‡‡æ ·å…·æœ‰éšæœºæ€§ã€‚ åˆ†è§£è¾¹ç¼˜æ¦‚ç‡è·¯å¾„ ä¸Šé¢æˆ‘ä»¬å·²ç»å®ç°äº†åˆ†è§£è¾¹ç¼˜é€Ÿåº¦ï¼Œç°åœ¨è€ƒè™‘ç”¨ä¸€æ ·çš„æ–¹æ³•åˆ†è§£è¾¹ç¼˜æ¦‚ç‡è·¯å¾„$q_t(x)$ï¼š \[q_t(x) = \prod_{i}q_t^i(x^i)\tag{6}\] å…¶ä¸­ï¼Œ$q_t^i(x^i)$å°±æ˜¯åˆ†è§£åçš„è¾¹ç¼˜æ¦‚ç‡è·¯å¾„ã€‚ æ¥ä¸‹æ¥æˆ‘ä»¬æƒ³è¯´æ˜ï¼šåˆ†è§£è¾¹ç¼˜é€Ÿç‡ç”Ÿæˆåˆ†è§£è¾¹ç¼˜æ¦‚ç‡è·¯å¾„æ—¶ï¼Œéåˆ†è§£çš„è¾¹ç¼˜é€Ÿç‡ä¹Ÿèƒ½ç”Ÿæˆéåˆ†è§£çš„è¾¹ç¼˜æ¦‚ç‡è·¯å¾„ï¼Œä¹Ÿå°±æ˜¯å¸Œæœ›è¾¹ç¼˜é€Ÿç‡å’Œè¾¹ç¼˜æ¦‚ç‡è·¯å¾„çš„å…³ç³»åœ¨åˆ†è§£å’Œéåˆ†è§£å½¢å¼ä¸‹éƒ½ä¿ç•™ã€‚å…·ä½“è€Œè¨€å°±æ˜¯å¦‚ä¸‹å‘½é¢˜ï¼š å‘½é¢˜2 ä»¤$q_t(x)$ç”±å…¬å¼ï¼ˆ6ï¼‰æ‰€ç¤ºçš„åˆ†è§£å½¢å¼å®šä¹‰ï¼Œå½“$u_t^i(y^i,x^i)\in C([0,1))$èƒ½å¤Ÿç”Ÿæˆ$q_t^i(x^i)$æ—¶ï¼Œé‚£ä¹ˆ$q_t$ç”±å¦‚ä¸‹åˆ†è§£å½¢å¼çš„è¾¹ç¼˜é€Ÿç‡ç”Ÿæˆï¼š \[u_t(y,x)=\sum_i\delta(y^{\bar i},x^{\bar i})u_t^i(y^i,x^i) \tag{7}\] å‘½é¢˜2çš„è¯æ˜å¦‚ä¸‹ï¼š é¦–å…ˆæ ¹æ®è¾¹ç¼˜æ¦‚ç‡çš„å®šä¹‰ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°$x^i$å’Œ$x^{\bar i}$çš„è¾¹ç¼˜æ¦‚ç‡å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼è®¡ç®—ï¼ˆå°±æ˜¯æŠŠæ— å…³çš„å˜é‡æ±‚å’Œæ‰ï¼‰ï¼š \[q^i(x^i) := \sum_{x^{\bar i}}q(x) \quad q^{\bar i }(x^{\bar i }) :=\sum_{x^i} q(x) \tag{8}\] æ¨å¯¼å¦‚ä¸‹ï¼š \[\begin{aligned} \cfrac{\mathrm{d}}{\mathrm{d}t}q_t(y) &amp;\overset{ä»£å…¥å…¬å¼(6)}{=} \cfrac{\mathrm{d}}{\mathrm{d}t}\prod_i q_t^i(y^i)\\ &amp;\overset{ä¹˜æ³•æ±‚å¯¼æ³•åˆ™}{=} \sum_i q^{\bar i}_t(y^{\bar i}) \cfrac{\mathrm{d}}{\mathrm{d}t}q_t^i(y^i)\\ &amp;\overset{\text{Kolmogorov}æ–¹ç¨‹}{=} \sum_i q^{\bar i}_t(y^{\bar i}) \left[ \sum_{x^i} u_t^i(y^i,x^i)q_t^i(x^i) \right]\\ &amp;\overset{(*)}{=} \sum_i \left[ \sum_{x^{\bar i}}\delta(y^{\bar i}, x^{\bar i} ) q_t^{\bar i}(x^{\bar i}) \right] \left[ \sum_{x^i} u_t^i(y^i,x^i)q_t^i(x^i) \right]\\ &amp;\overset{åˆ†é…å¾‹}{=} \sum_i \sum_{x^{\bar i}}\sum_{x^i} \left[ \delta(y^{\bar i}, x^{\bar i} ) q_t^{\bar i}(x^{\bar i}) u_t^i(y^i,x^i)q_t^i(x^i) \right]\\ &amp;\overset{åˆå¹¶x^iå’Œx^{\bar i}}{=} \sum_i \sum_{x} \left[ \delta(y^{\bar i}, x^{\bar i} ) u_t^i(y^i,x^i)q_t(x) \right]\\ &amp;\overset{äº¤æ¢æ±‚å’Œé¡ºåº}{=} \sum_{x}\left[\sum_i \left[ \delta(y^{\bar i}, x^{\bar i} ) u_t^i(y^i,x^i) \right]q_t(x)\right]\\ \end{aligned} \tag{9}\] ï¼ˆ*ï¼‰å¼åŸºäº$q_t^{\bar i }(y^{\bar i}) = \sum_{x^{\bar i}}\delta(y^{\bar i}, x^{\bar i})q_t^{\bar i}(x^{\bar i})$ã€‚æ ¹æ®æœ€åç»“æœï¼Œå¯¹æ¯”Kolmogorovæ–¹ç¨‹ï¼Œå°±çŸ¥é“$u_t(y,x)=\sum_i\delta(y^{\bar i},x^{\bar i})u_t^i(y^i,x^i)$äº†ã€‚ åˆ†è§£æ¡ä»¶é€Ÿç‡å’Œæ¡ä»¶æ¦‚ç‡è·¯å¾„ æ¥ä¸‹æ¥æˆ‘ä»¬è¿˜éœ€è¦åˆ†è§£æ¡ä»¶é€Ÿç‡å’Œæ¡ä»¶æ¦‚ç‡è·¯å¾„ã€‚æ¢å¥è¯è¯´ï¼Œæˆ‘ä»¬å¸Œæœ›å¾—åˆ°åˆ†è§£ç‰ˆçš„ç¦»æ•£è¾¹ç¼˜åŒ–æŠ€å·§ï¼ˆDiscrete Factorized Marginalization Trickï¼‰ã€‚ å®šç†16ï¼ˆDiscrete Factorized Marginalization Trickï¼‰è€ƒè™‘ä¸€ä¸ªè¾¹ç¼˜æ¦‚ç‡è·¯å¾„é€šè¿‡å¦‚ä¸‹æ–¹å¼æ„é€ ï¼š \[p_t(x) =\sum_z p_{t\mid Z}(x \mid z) p_Z(z)\text{, with }p_{t\mid Z}(x\mid z)= \prod_ip_{t\mid Z}^i(x^i\mid z)\tag{10}\] å…¶ä¸­ï¼Œ$p_{t\mid Z}^i(x^i\mid z)$æ˜¯åˆ†è§£æ¡ä»¶æ¦‚ç‡è·¯å¾„ï¼Œå°±åƒå…¬å¼ï¼ˆ6ï¼‰ä¸­çš„åˆ†è§£è¾¹ç¼˜æ¦‚ç‡è·¯å¾„ä¸€æ ·ã€‚ å‡è®¾ï¼š$\forall x \in \mathcal{S}, \forall t\in[0,1)$ï¼Œ $p_t(x) &gt; 0$ã€‚åˆ†è§£æ¡ä»¶é€Ÿç‡$u_t^{i}(y^i, x^i \mid z) \in C([0,1))$ç”Ÿæˆåˆ†è§£æ¡ä»¶æ¦‚ç‡è·¯å¾„$p_{t\mid Z}^i(x^i\mid z) \in C^1([0,1))$ã€‚ å‡è®¾æ»¡è¶³æ—¶ï¼Œè¾¹ç¼˜é€Ÿç‡ \[u_t(y,x) =\sum_i\delta(y^{\bar i},x^{\bar i})u_t^i(y^i,x)\tag{11}\] ç”Ÿæˆè¾¹ç¼˜æ¦‚ç‡è·¯å¾„$p_t(x)$ã€‚ å…¶ä¸­ \[u_t^i(y^i,x)=\sum_z u_t^i(y^i,x^i\mid z)p_{Z\mid t}(z\mid x) = \mathbb{E} \left[ u_t^i(y^i,X_t^i\mid Z) \mid X_t=x \right]\tag{12}\] å®šç†16çš„è¯æ˜å¦‚ä¸‹ \[\begin{aligned} u_t(y,x) &amp;\overset{(*)}{=}\sum_z u_t(y,x\mid z)p_{Z\mid t}(z\mid x)\\ &amp;\overset{å…¬å¼(7)}{=}\sum_z \left[ \sum_i\delta(y^{\bar i},x^{\bar i})u_t^i(y^i,x^i\mid z) \right] p_{Z\mid t}(z\mid x)\\ &amp;\overset{äº¤æ¢æ±‚å’Œé¡ºåº}{=}\sum_i \delta(y^{\bar i},x^{\bar i}) \underbrace{\left[ \sum_z u_t^i(y^i,x^i\mid z) p_{Z\mid t}(z\mid x) \right]}_{u_t^i(y^i,x)} \\ \end{aligned} \tag{13}\] ï¼ˆ*ï¼‰æ­¥æ˜¯æˆ‘ä»¬åœ¨DFMä¸Šä¸€èŠ‚4ä¸­å·²ç»å¾—åˆ°çš„ç»“è®ºã€‚ é‚£ä¹ˆæ ¹æ®ï¼ˆ13ï¼‰å¼ï¼Œå°±çŸ¥é“å…¬å¼ï¼ˆ11ï¼‰å’Œï¼ˆ12ï¼‰äº†ã€‚ æ¥ä¸‹æ¥æˆ‘ä»¬è¿˜è¦è¯´æ˜å…¬å¼ï¼ˆ11ï¼‰è¡¨ç¤ºçš„è¾¹ç¼˜é€Ÿç‡èƒ½å¤Ÿç”Ÿæˆè¾¹ç¼˜æ¦‚ç‡è·¯å¾„$p_t(x)$ï¼Œè¿™éœ€è¦ç”¨åˆ°æˆ‘ä»¬ä¸Šä¸€èŠ‚4è®²çš„ç¦»æ•£è¾¹ç¼˜åŒ–æŠ€å·§ï¼Œç¦»æ•£è¾¹ç¼˜åŒ–æŠ€å·§æœ‰ä½¿ç”¨çš„å‡è®¾ï¼Œå³ $p_{t\mid Z}(x\mid z)\in C^{1}([0,1))$ï¼Œ$u_t(y,x\mid z)\in C([0,1))$ã€‚æˆ‘ä»¬æ¥ä¸‹æ¥è¯´æ˜è¿™ä¸ªå‡è®¾èƒ½æ»¡è¶³ã€‚ æ ¹æ®å®šç†16çš„å‡è®¾å¯çŸ¥$p_{t\mid Z}^i(x^i\mid z) \in C^1([0,1))$ï¼Œ$\forall t \in C([0,1)), p_t(x) &gt; 0$ï¼Œæ‰€ä»¥æ ¹æ®$p_{t\mid Z}(x\mid z)=\prod_ip_{t\mid Z}^i(x^i\mid z)$å¯çŸ¥$p_{t\mid Z}(x\mid z)\in C^1([0,1))$ã€‚æ ¹æ®å®šç†16çš„å‡è®¾å¯çŸ¥$u_t^{i}(y^i, x^i \mid z) \in C([0,1))$ï¼Œæ ¹æ®å…¬å¼7æˆ‘ä»¬çŸ¥é“$u_t(y,x\mid z)=\sum_i\delta(y^{\bar i},x^{\bar i})u_t^i(y^i,x^i\mid z)$ï¼Œæ‰€ä»¥å¯ä»¥çŸ¥é“$u_t(y,x\mid z)\in C([0,1))$ã€‚ æ‰€ä»¥ç¦»æ•£è¾¹ç¼˜åŒ–æŠ€å·§å‡è®¾æ»¡è¶³ï¼Œå¯ä»¥åº”ç”¨è¯¥æŠ€å·§ï¼Œå¾—å‡º å…¬å¼ï¼ˆ11ï¼‰è¡¨ç¤ºçš„è¾¹ç¼˜é€Ÿç‡$u_t(y,x)$èƒ½å¤Ÿç”Ÿæˆè¾¹ç¼˜æ¦‚ç‡è·¯å¾„$p_t(x)$ã€‚ æ‰€ä»¥ï¼Œå®šç†16å¾—åˆ°è¯æ˜ã€‚ åˆ†è§£æ¡ä»¶æŸå¤±å‡½æ•° æˆ‘ä»¬å¯ä»¥è®©æ¨¡å‹é¢„æµ‹åˆ†è§£å½¢å¼çš„é€Ÿç‡$u_t^{\theta,i}$ï¼Œæ›¿ä»£åŸå…ˆé¢„æµ‹éåˆ†è§£å½¢å¼é€Ÿç‡$u_t^{\theta}$çš„å½¢å¼ï¼Œé‚£ä¹ˆæ¡ä»¶æŸå¤±å‡½æ•°çš„å½¢å¼å¯ä»¥æ”¹å†™ä¸ºï¼š \[L_{CDFM}(\theta) = \mathbb{E}_{t,Z,X_t\sim p_{t\mid Z}} \sum_i D_{X_t}^i \left( u_t^i(\cdot,X_t \mid Z), u_t^{\theta,i}(\cdot, X_t) \right) \tag{14}\] å…¶ä¸­ï¼Œ$t\in U[0,1]$ï¼Œ$u_t^{i}(\cdot,x\mid z), u_t^{\theta,i}(\cdot,x) \in \mathbb{R}^{\mathcal{T}}$ã€‚$u_t^{i}(\cdot,x\mid z),u_t^{\theta,i}(\cdot,x)$éœ€è¦æ»¡è¶³é€Ÿç‡æ¡ä»¶ã€‚$D_{x}^i(u,v)$æ˜¯åˆ†è§£åçš„Bregmanæ•£åº¦ã€‚ å…³äº$u_t^{i}(\cdot,x\mid z),u_t^{\theta,i}(\cdot,x)$æ»¡è¶³é€Ÿç‡æ¡ä»¶ï¼Œå¯ä»¥ç”¨æ›´å½¢å¼åŒ–çš„æ–¹å¼è¡¨è¾¾ï¼š å®šä¹‰ï¼š å¯¹äº$\alpha \in \mathcal{T}$ï¼Œ \[\Omega_{\alpha} = \left\{ v \in \mathbb{R}^{\mathcal{T}}\mid v(\beta)\ge 0 \text{ }\forall\beta \in \mathcal{T}\backslash \{\alpha\}\text{, and } v(\alpha) = -\sum_{\beta\neq \alpha} v(\beta) \right\} \subset \mathbb{R}^{\mathcal{T}}\tag{15}\] $\Omega_{\alpha}$æ˜¾ç„¶æ˜¯ä¸ªå‡¸é›†åˆã€‚ å½¢å¼åŒ–çš„è¯´ï¼Œ$u_t^{i}(\cdot,x\mid z),u_t^{\theta,i}(\cdot,x)$æ»¡è¶³é€Ÿç‡æ¡ä»¶ï¼Œå°±æ˜¯$u_t^{i}(\cdot,x\mid z),u_t^{\theta,i}(\cdot,x)\in \Omega_{x^i}$ã€‚ å…³äº$D_{x}^i(u,v)$ï¼Œåœ¨4ä¸­è¯´è¿‡ï¼Œå®ƒéœ€è¦ä¸€ä¸ªå‡¸å‡½æ•°æ¥å®šä¹‰ã€‚ä¸è¿‡ç›¸æ¯”äºéåˆ†è§£çš„$D_x(u,v)$ï¼Œ$D_{x}^i(u,v)$éœ€è¦çš„ä¹Ÿæ˜¯ä¸€ä¸ªåˆ†è§£çš„å‡¸å‡½æ•°ï¼Œå¯ä»¥è®°ä¸º$\Phi_x^i : \Omega_{x^i} \to \mathbb R$ã€‚ Lipman Y, Havasi M, Holderrieth P, et al. Flow Matching Guide and Code[J]. arXiv preprint arXiv:2412.06264, 2024.Â &#8617; Lipman Y, Chen R T Q, Ben-Hamu H, et al. Flow matching for generative modeling[J]. arXiv preprint arXiv:2210.02747, 2022.Â &#8617; Campbell A, Benton J, De Bortoli V, et al. A continuous time framework for discrete denoising models[J]. Advances in Neural Information Processing Systems, 2022, 35: 28266-28279.Â &#8617; https://zhuanlan.zhihu.com/p/16493879333Â &#8617;Â &#8617;2Â &#8617;3]]></summary></entry><entry><title type="html">ç¦»æ•£å‹æµåŒ¹é…æ¨¡å‹ï¼ˆ1ï¼‰</title><link href="https://ly403.github.io/blog/2025/%E7%A6%BB%E6%95%A3%E6%B5%81%E5%8C%B9%E9%85%8D%E6%A8%A1%E5%9E%8B-1/" rel="alternate" type="text/html" title="ç¦»æ•£å‹æµåŒ¹é…æ¨¡å‹ï¼ˆ1ï¼‰"/><published>2025-01-05T00:00:00+00:00</published><updated>2025-01-05T00:00:00+00:00</updated><id>https://ly403.github.io/blog/2025/%E7%A6%BB%E6%95%A3%E6%B5%81%E5%8C%B9%E9%85%8D%E6%A8%A1%E5%9E%8B%EF%BC%881%EF%BC%89</id><content type="html" xml:base="https://ly403.github.io/blog/2025/%E7%A6%BB%E6%95%A3%E6%B5%81%E5%8C%B9%E9%85%8D%E6%A8%A1%E5%9E%8B-1/"><![CDATA[<p>æœ¬æ–‡æ˜¯æ¥ç€ä¸Šä¸€æ¬¡å­¦ä¹ çš„CTMCæ¨¡å‹ç»§ç»­å­¦ä¹ ç¦»æ•£å‹æµåŒ¹é…æ¨¡å‹ï¼Œä¸»è¦æ˜¯è¯»Flow Matching Guide and Code<sup id="fnref:1"><a href="#fn:1" class="footnote" rel="footnote" role="doc-noteref">1</a></sup>ç¬¬7ç« çš„ç¬”è®°ã€‚å¹¶éå®Œå…¨Flow Matching Guide and Codeçš„ç¿»è¯‘ï¼ŒæŒ‘äº†ä¸€äº›é‡è¦çš„å†…å®¹å¹¶ä¸”åŠ å…¥äº†æˆ‘è‡ªå·±çš„çš„ç†è§£ã€‚</p> <p>è¦æ„å»ºä¸€ä¸ªç¦»æ•£å‹æµåŒ¹é…æ¨¡å‹ï¼ˆDiscrete Flow Matchingï¼ŒDFMï¼‰ï¼Œåˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼š</p> <ol> <li>ç±»æ¯”è¿ç»­å‹FMï¼Œå®šä¹‰ä¸€ä¸ªæ¦‚ç‡è·¯å¾„$p_t$ï¼Œè¿æ¥åŸå§‹åˆ†å¸ƒçš„pmfå’Œç›®æ ‡åˆ†å¸ƒçš„pmfã€‚pmfå°±æ˜¯æ¦‚ç‡è´¨é‡å‡½æ•°ã€‚</li> <li>æ„å»ºä¸€ä¸ªCTMCæ¨¡å‹ï¼Œ\({(X_{t})}_{0 \le t \le 1}\)ï¼Œè¯¥CTMCçš„é€Ÿåº¦åœº\(u_{t}^{\theta}\)ç”Ÿæˆå‡ºç¬¬1æ­¥ä¸­çš„æ¦‚ç‡è·¯å¾„\(p_t\)ï¼Œ\(\theta\)æ˜¯å¯å­¦ä¹ çš„å‚æ•°ã€‚</li> <li>è®­ç»ƒ\(u_{t}^{\theta}\)ï¼Œä½¿ä¹‹æœ€å°åŒ–Bregmanæ•£åº¦ï¼ŒBregmanæ•£åº¦å°±æ˜¯DFMçš„æŸå¤±å‡½æ•°ã€‚</li> </ol> <p>åé¢æˆ‘å°±æŠŠç¦»æ•£å‹æµåŒ¹é…æ¨¡å‹ç®€ç§°ä¸ºDFMï¼Œè¿ç»­å‹æµåŒ¹é…æ¨¡å‹ç®€ç§°ä¸ºFMã€‚</p> <h2 id="æ•°æ®å’Œæ•°æ®çš„æˆå¯¹">æ•°æ®å’Œæ•°æ®çš„æˆå¯¹</h2> <p>åƒFMé‡Œé¢ä¸€æ ·ï¼Œå®šä¹‰æºåˆ†å¸ƒçš„pmfä¸º$p$ï¼Œç›®æ ‡åˆ†å¸ƒçš„pmfä¸º$q$ã€‚æºåˆ†å¸ƒçš„éšæœºå˜é‡ï¼ˆRandom Variableï¼ŒRVï¼‰è®°ä¸º$X_0$ï¼Œç›®æ ‡åˆ†å¸ƒçš„éšæœºå˜é‡è®°ä¸º$X_1$ã€‚$X_0,X_1 \in \mathcal{S}$ï¼Œ$\mathcal{S}$å°±æ˜¯CTMCæ¨¡å‹é‡Œé¢æåˆ°çš„çŠ¶æ€ç©ºé—´ã€‚</p> <p>è€ƒè™‘åˆ°æˆ‘ä»¬ä¸€èˆ¬æŠŠ$X_0$å’Œ$X_1$æ”¾åœ¨ä¸€èµ·è®¨è®ºï¼Œæ‰€ä»¥éœ€è¦æ‰¾ä¸ªæ–¹å¼è¡¨ç¤º$X_0$å’Œ$X_1$çš„æˆå¯¹åˆ†å¸ƒï¼š$(X_0,X_1)\sim p(X_0)q(X_1)$ï¼Œå°±æ˜¯å½“æˆä¸¤ä¸ªç‹¬ç«‹çš„RVï¼Œç”¨äºŒè€…çš„pmfçš„ä¹˜ç§¯è¡¨ç¤º$(X_0,X_1)$çš„è”åˆåˆ†å¸ƒã€‚ä¹Ÿå¯ä»¥ç”¨å•ç‹¬çš„ç¬¦å·$\pi_{0,1}(x_0,x_1)$è¡¨ç¤º$p(x_0)$å’Œ$q(x_1)$çš„è”åˆåˆ†å¸ƒã€‚</p> <p>ä¸¾ä¸ªä¾‹å­ç†è§£ï¼Œå¦‚æœå¯¹æ–‡æœ¬ç”Ÿæˆä»»åŠ¡ï¼Œæºåˆ†å¸ƒ$p(x_0)$å°±æ˜¯å…ˆéªŒåˆ†å¸ƒï¼Œä¸€èˆ¬å–ï¼š</p> <ol> <li> <p>$\mathcal{S}$ä¸Šçš„å‡åŒ€åˆ†å¸ƒ</p> </li> <li> <p>åŠ å…¥ä¸€ä¸ªmaskçš„ç‰¹æ®Štoken $\mathtt{m}$åˆ°vocabulary $\mathcal{T}$é‡Œé¢ï¼Œå³$\mathcal{T}\cup {\mathtt{m}}$ã€‚</p> </li> </ol> <p>æŒ‰ç¬¬2ç§æ–¹æ³•ï¼Œæ­¤æ—¶å¾—åˆ°$\pi_{0,1}(x_0,x_1)=\delta(x_0,\mathtt{m})q(x_1)$ï¼Œå…ˆéªŒåˆ†å¸ƒå°±æ˜¯$\delta(x_0,\mathtt{m})$ã€‚è‹¥$X_0 \sim \delta(X_0,\mathtt{m})$ï¼Œåˆ™$X_0=(\mathtt{m},\cdots,\mathtt{m})$ã€‚</p> <h2 id="ç¦»æ•£æ¦‚ç‡è·¯å¾„">ç¦»æ•£æ¦‚ç‡è·¯å¾„</h2> <p>FM<sup id="fnref:2"><a href="#fn:2" class="footnote" rel="footnote" role="doc-noteref">2</a></sup>åœ¨ç ”ç©¶è¾¹ç¼˜æ¦‚ç‡è·¯å¾„$p_t(x)$å’Œç”Ÿæˆ$p_t(x)$çš„è¾¹ç¼˜å‘é‡åœºæ—¶$u_t(x)$é‡åˆ°å›°éš¾ï¼ˆå›¾åƒåœ¨é«˜ç»´ç©ºé—´ä¸­é€ æˆ<sup id="fnref:2:1"><a href="#fn:2" class="footnote" rel="footnote" role="doc-noteref">2</a></sup>ä¸­çš„å…¬å¼6å’Œ8çš„ç§¯åˆ†ä¸å¯è§£ï¼Œå› æ­¤æ²¡åŠæ³•å¾—åˆ°$p_t(x)$å’Œ$u_t(x)$çš„è§£æå¼ï¼‰ï¼Œæ‰€ä»¥è½¬è€Œæ±‚è§£æ¡ä»¶å‘é‡åœº$u_t(x\mid z)$å’Œæ¡ä»¶æ¦‚ç‡è·¯å¾„$p_t(x\mid z)$ã€‚ä»¿ç…§è¿™ä¸ªåŠæ³•ï¼ŒDFMä¹Ÿå¯ä»¥æŒ‰å¦‚ä¸‹æ–¹å¼ç®—è¾¹ç¼˜æ¦‚ç‡è·¯å¾„ï¼ˆmarginal probability pathï¼‰ï¼š</p> \[p_t(x) = \sum_{z\in \mathcal{Z}}{p_{t\mid Z}(x\mid z)p_{Z}(z)}\tag{1}\] <p>å…¶ä¸­$Z\in \mathcal{Z}$æ˜¯ä½œä¸ºæ¡ä»¶çš„éšæœºå˜é‡ï¼Œ$\mathcal{Z}$æ˜¯ä»»æ„ç©ºé—´ã€‚ä¸Šå¼æ˜¯ç¦»æ•£ç‰ˆçš„å…¨æ¦‚ç‡å…¬å¼ã€‚éœ€è¦æŒ‡å‡ºçš„æ˜¯ï¼Œ<strong>æ¡ä»¶æ¦‚ç‡è·¯å¾„$p_{t\mid Z}(x\mid z)$å¿…é¡»æ»¡è¶³è¾¹ç•Œçº¦æŸ$p_0 = p$å’Œ$p_1=q$ï¼Œ</strong>è¿™æ ·æ‰èƒ½æ„å»ºæºåˆ†å¸ƒå’Œç›®æ ‡åˆ†å¸ƒä¹‹é—´çš„å…³ç³»ã€‚</p> <h2 id="è¾¹ç¼˜åŒ–æŠ€å·§">è¾¹ç¼˜åŒ–æŠ€å·§</h2> <p>æˆ‘ä»¬åœ¨å…¬å¼1ä¸­å·²ç»ç»™å‡ºäº†è¾¹ç¼˜æ¦‚ç‡è·¯å¾„$p_t(x)$å’Œæ¡ä»¶æ¦‚ç‡è·¯å¾„$p_{t\mid Z}(x\mid z)$ä¹‹é—´çš„å…³ç³»ï¼Œç±»æ¯”åœ¨FMé‡Œé¢åšçš„äº‹æƒ…ï¼Œå¯¹DFMï¼Œæˆ‘ä»¬ä¹Ÿæƒ³çŸ¥é“æ¡ä»¶é€Ÿåº¦åœº$u_t(y,x\mid z)$å’Œè¾¹ç¼˜æ¡ä»¶é€Ÿåº¦åœº$u_t(y,x)$ä¹‹é—´çš„å…³ç³»ã€‚</p> <p>ä¸ºäº†ç ”ç©¶è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥ä»FMä¸­è·å¾—ç»éªŒã€‚FMä¸­ï¼Œå¦‚æœæ¡ä»¶å‘é‡åœº$u_t(\cdot\mid z)$èƒ½ç”Ÿæˆæ¡ä»¶æ¦‚ç‡è·¯å¾„$p_{t\mid Z}(\cdot\mid z)$ï¼Œé‚£è¾¹ç¼˜å‘é‡åœº$u_t(x)$æ»¡è¶³ï¼š</p> \[u_t(x) = \int u_t(x\mid z)\cfrac{p_{t\mid Z}(x\mid z)p_Z(z)}{p_t(x)}\mathrm{d} z =\int u_t(x\mid z) p_{Z\mid t}(z\mid x) \mathrm{d}z \tag{2}\] <p>å…¬å¼2å¯ä»¥å‚è€ƒFlow matching for generative modeling<sup id="fnref:2:2"><a href="#fn:2" class="footnote" rel="footnote" role="doc-noteref">2</a></sup>é‡Œé¢çš„å…¬å¼8ï¼Œæˆ–è€…Flow Matching Guide and Code<sup id="fnref:1:1"><a href="#fn:1" class="footnote" rel="footnote" role="doc-noteref">1</a></sup>é‡Œé¢çš„å…¬å¼4.12ã€‚</p> <p>ç±»æ¯”å…¬å¼2ï¼Œæ˜¯å¦DFMä¹Ÿå­˜åœ¨å¦‚ä¸‹å…³ç³»ï¼šå½“æ¡ä»¶é€Ÿåº¦åœº$u_t(\cdot,\cdot\mid z)$ç”Ÿæˆæ¡ä»¶æ¦‚ç‡è·¯å¾„$p_{t\mid Z}(\cdot\mid z)$æ—¶ï¼Œè¾¹ç¼˜é€Ÿåº¦åœº$u_t(y,x)$æ»¡è¶³</p> \[u_t(y,x) = \sum_z u_t(y,x \mid z) \cfrac{p_{t\mid Z}(x\mid z)p_Z(z)}{p_t(x)} =\sum_z u_t(y,x\mid z) p_{Z\mid t}(z\mid x) \tag{3}\] <p>ç­”æ¡ˆæ˜¯è‚¯å®šçš„ã€‚æ¥ä¸‹æ¥è¯¦ç»†è¡¨è¿°å’Œè¯æ˜è¿™ä¸ªé—®é¢˜ã€‚</p> <hr/> <p><strong>å‡è®¾</strong> $p_{t\mid Z}(x\mid z)\in C^{1}([0,1))$ã€‚$u_t(y,x\mid z)\in C([0,1))$ã€‚å¯¹æ‰€æœ‰$t\in[0,1)$å’Œ$x\in \mathcal{S}$ï¼Œ$p_t(x)&gt; 0$ã€‚</p> <p><strong>å®šç†</strong> ï¼ˆç¦»æ•£è¾¹ç¼˜åŒ–æŠ€å·§ï¼‰å½“ä¸Šè¿°å‡è®¾æ»¡è¶³æ—¶ï¼Œå¦‚æœ$u_t(y,x\mid z)$ç”Ÿæˆ$p_{t\mid Z}(x\mid z)$ï¼Œé‚£ä¹ˆå¯¹$t\in[0,1)$ï¼Œè¾¹ç¼˜å‘é‡åœº$u_t(y,x)$ï¼ˆå…¬å¼3ï¼‰ç”Ÿæˆè¾¹ç¼˜æ¦‚ç‡è·¯å¾„$p_t(x)$ï¼ˆå…¬å¼1ï¼‰ã€‚</p> <p><strong>è¯æ˜</strong></p> \[\begin{aligned} \cfrac{\mathrm{d}}{\mathrm{d}t}p_t(y) &amp;\overset{(1)}{=} \cfrac{\mathrm{d}}{\mathrm{d}t}\left[ \sum_z{ p_{t\mid Z}\left(y\mid z\right)p_{Z}(z) }\right]\\ &amp;\overset{(2)}{=} \sum_z{ \cfrac{\mathrm{d}}{\mathrm{d}t}\left[ p_{t\mid Z}\left(y\mid z\right)p_{Z}(z) \right] }\\ &amp;\overset{(3)}{=} \sum_z{ \cfrac{\mathrm{d}}{\mathrm{d}t}\left[ p_{t\mid Z}\left(y\mid z\right) \right]p_{Z}(z) }\\ &amp;\overset{(4)}{=} \sum_z {\sum_x \left[{ u_t(y,x \mid z) p_{t\mid Z}(x\mid z) } \right] p_Z(z)}\\ &amp;\overset{(5)}{=} \sum_x {\sum_z \left[{ u_t(y,x \mid z) \cfrac{p_{t\mid Z}(x\mid z)p_Z(z)}{p_t(x)} } \right] p_t(x)}\\ &amp;\overset{(6)}{=} \sum_x {\overbrace{\sum_z \left[{ u_t(y,x \mid z) p_{Z\mid t}(z\mid x) } \right]}^{u_t(y,x)} p_t(x)} \end{aligned} \tag{4}\] <p>ç¬¬ï¼ˆ4ï¼‰æ­¥æ˜¯å› ä¸ºæ ¹æ®æ¡ä»¶â€œ$u_t(y,x\mid z)$ç”Ÿæˆ$p_{t\mid Z}(x\mid z)$â€ï¼Œæˆ‘ä»¬åœ¨CTMCæ¨¡å‹ä¸­è®²åˆ°çš„ç¦»æ•£è´¨é‡å®ˆæ’Discrete Mass Conservationï¼ˆDiscrete Mass Conservationçš„å‡è®¾å·²ç»æ»¡è¶³äº†ï¼Œå°±æ˜¯ä¸Šæ–‡ç»™å‡ºçš„å‡è®¾ï¼‰ï¼Œå¯çŸ¥ï¼š</p> <ul> <li>$u_t(y,x\mid z)$ç”Ÿæˆ$p_{t\mid Z}(x\mid z)$</li> <li> <font color="red">$u_t(y,x\mid z)$å’Œ$p_{t\mid Z}$æ»¡è¶³Kolmogorovæ–¹ç¨‹</font> <p>ï¼Œä¸”<font color="blue"> $u_t(y,x\mid z)$æ»¡è¶³é€Ÿç‡æ¡ä»¶ï¼ˆrate conditionsï¼‰</font>ã€‚</p> </li> </ul> <p>äºŒè€…ç­‰ä»·ï¼Œæ•…ç›´æ¥å¸¦å…¥Kolmogorovæ–¹ç¨‹å¯å¾—ç¬¬ï¼ˆ4ï¼‰æ­¥ï¼Œåªæ˜¯åŠ äº†ä¸ªæ¡ä»¶$z$è€Œå·²ã€‚</p> <p>ç¬¬ï¼ˆ5ï¼‰æ˜¯å°†$p_Z(z)$æ‹¿åˆ°å†…å±‚æ±‚å’Œï¼Œå¹¶åœ¨å†…å±‚æ±‚å’Œçš„åˆ†æ¯ä¸Šæ·»åŠ ä¸€ä¸ª$p_t(x)$ï¼Œæ­¤æ—¶è¿˜éœ€è¦å†ä¹˜$p_t(x)$ï¼Œå¯ä»¥ç”¨åˆ†é…å¾‹æŠŠå®ƒæ‹¿å‡ºå†…å±‚æ±‚å’Œã€‚</p> <p>ç¬¬ï¼ˆ6ï¼‰æ­¥æ˜¯è´å¶æ–¯å…¬å¼ã€‚</p> <p>æœ€ç»ˆå¾—å‡ºçš„ç­‰å¼æ¯”å¯¹ä¸€ä¸‹Kolmogorovæ–¹ç¨‹ï¼Œå¯è§$u_t(y,x)=\sum_z u_t(y,x \mid z) p_{Z\mid t}(z\mid x)$å’Œ$p_t$æ»¡è¶³Kolmogorovæ–¹ç¨‹ã€‚</p> <p>ç„¶åï¼Œ$u_t(y,x)$æ»¡è¶³é€Ÿç‡æ¡ä»¶ï¼Œå› ä¸º$u_t(y,x \mid z)$æ»¡è¶³é€Ÿç‡æ¡ä»¶ï¼Œå³ä¸Šæ–‡è“è‰²å­—çš„éƒ¨åˆ†ã€‚</p> <blockquote> <p>å…³äºä¸ºä»€ä¹ˆ$u_t(y,x \mid z)$æ»¡è¶³é€Ÿç‡æ¡ä»¶ï¼Œ$u_t(y,x)$å°±æ»¡è¶³é€Ÿç‡æ¡ä»¶çš„è¯æ˜ï¼š</p> <p>å¦‚æœ$u_t(y,x \mid z)$æ»¡è¶³é€Ÿç‡æ¡ä»¶ï¼Œé‚£ä¹ˆ $\forall y\neq x , u_t(y,x\mid z) \ge 0$ä¸”$\sum_y u_t(y,x\mid z)=0$</p> <p>æ ¹æ®$u_t(y,x)=\sum_z u_t(y,x \mid z) p_{Z\mid t}(z\mid x)$ï¼Œå› ä¸º$p_{Z\mid t}(z\mid x)$æ˜¾ç„¶ä¸å°äº0ï¼Œæ•…$u_t(y,x) \ge 0$ã€‚</p> \[\begin{aligned} \sum_y u_t(y,x) &amp;=\sum_y\sum_z u_t(y,x \mid z) p_{Z\mid t}(z\mid x) \\ &amp;=\sum_z\sum_y u_t(y,x \mid z) p_{Z\mid t}(z\mid x) \\ &amp;= \sum_z 0p_{Z\mid t}(z\mid x) \\ &amp;= 0 \end{aligned} \tag{5}\] <p>æ‰€ä»¥$u_t(y,x)$ä¹Ÿæ»¡è¶³é€Ÿç‡æ¡ä»¶ã€‚</p> </blockquote> <p>åœ¨å†æ¬¡åº”ç”¨Discrete Mass Conservationä¹‹å‰ï¼Œè¿˜å¾—ç¡®å®šä¸€ä¸‹å‡è®¾æ˜¯å¦æ»¡è¶³ï¼Œå› ä¸º$u_t(y,x\mid z)\in C([0,1)$ä¸”$p_{t\mid Z}(x\mid z)\in C^{1}([0,1))$ï¼Œæ•…$u_t(y,x)\in C([0,1))$ï¼Œ$p_t(x)\in C^1([0,1))$ã€‚</p> <blockquote> <p>å…³äºä¸ºä»€ä¹ˆ\(u_t(y,x\mid z)\in C([0,1)\)ä¸”\(p_{t\mid Z}(x\mid z)\in C^{1}([0,1))\)ï¼Œå°±æœ‰\(u_t(y,x)\in C([0,1))\)ã€‚æˆ‘è‡ªå·±çš„ç†è§£å¦‚ä¸‹ï¼š</p> <p>å› ä¸º\(p_t(x) = \sum_{z}{p_{t\mid Z}(x\mid z)p_{Z}(z)}\)ï¼Œ\(p_{t\mid Z}(x\mid z)\)åœ¨\(t\in[0,1)\)ä¸Šè¿ç»­ï¼Œ\(p_Z(z)\)å’Œ\(t\)æ— å…³ï¼Œæ‰€ä»¥\(p_t(x)\)åœ¨\(t\in[0,1)\)è¿ç»­ã€‚\(p_{t\mid Z}(x\mid z)\)çš„ä¸€é˜¶å¯¼åœ¨\(t\in[0,1)\)ä¸Šè¿ç»­ï¼Œ\(p_Z(z)\)å’Œ\(t\)æ— å…³ï¼Œ\(\dot p_t(x) = \sum_{z}{\dot p_{t\mid Z}(x\mid z)p_{Z}(z)}\)ï¼Œæ•…\(\dot p_t(x)\)ä¹Ÿåœ¨\(t\in[0,1)\)ä¸Šè¿ç»­ã€‚</p> <p>å› ä¸º$u_t(y,x)=\sum_z u_t(y,x \mid z) p_{Z\mid t}(z\mid x)= \sum_z u_t(y,x \mid z) \cfrac{p_{t\mid Z}(x\mid z)p_Z(z)}{p_t(x)}$ï¼Œåœ¨$t\in[0,1)$æ—¶ï¼Œ$p_{t\mid Z}(x\mid z)$å’Œ$u_t(y,x\mid z)$éƒ½è¿ç»­ï¼Œ$p_Z(z)$å’Œ$t$æ— å…³ï¼Œæ ¹æ®å‡è®¾$p_t(x)&gt;0$ï¼ŒåŒæ—¶$p_t(x)$åœ¨$t\in[0,1)$è¿ç»­ï¼Œæ‰€ä»¥$u_t(y,x)$åœ¨$t\in[0,1)$è¿ç»­ã€‚ä»è¿™é‡Œèƒ½çœ‹åˆ°å‡è®¾ä¸ºä»€ä¹ˆä¸€å®šè¦$p_t(x)&gt;0$ã€‚</p> <p>ä»ä¸Šé¢è¿™äº›è§£é‡Šå°±çŸ¥é“$u_t(y,x)\in C([0,1))$ï¼Œ$p_t(x) \in C^1([0,1)$ã€‚</p> </blockquote> <p>æ‰€ä»¥å‡è®¾ä¹Ÿæ»¡è¶³ï¼Œå¯ä»¥åº”ç”¨Discrete Mass Conservationï¼Œå¾—åˆ°<strong>$u_t(y,x)$ç”Ÿæˆ$p_{t}(x)$</strong>ã€‚è¯æ˜å®Œæ¯•ã€‚</p> <p><strong>è¡¥å……</strong> å…³äº$t\in[0,1)$æ—¶ï¼Œ$p_t&gt;0$çš„å‡è®¾æ˜¯å¯ä»¥æ»¡è¶³çš„ã€‚å› ä¸ºæˆ‘ä»¬å¯ä»¥ä½¿ç”¨$(1-(1-t)\epsilon) \cdot p_{Z\mid t} + (1 - t)\epsilon \cdot p_{\text{uni}}$ï¼Œå…¶ä¸­$p_{\text{uni}}$æ˜¯å‡åŒ€åˆ†å¸ƒï¼Œ$\epsilon$æ˜¯å¤§äº0çš„å¾ˆå°çš„å€¼ã€‚æˆ‘çš„ç†è§£å°±æ˜¯é€šè¿‡ç¨å¾®åŠ å…¥ä¸€ç‚¹æœä»å‡åŒ€åˆ†å¸ƒçš„å™ªå£°ï¼Œè®©$[0,1)$ä¸Šï¼Œ$p_t$éƒ½æœ‰æ¦‚ç‡ã€‚</p> <hr/> <h2 id="dfmæŸå¤±">DFMæŸå¤±</h2> <p>åƒFMé‡Œé¢ä¸€æ ·ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ªç¥ç»ç½‘ç»œæ¥å­¦ä¹ é€Ÿåº¦åœº$u_{t}^{\theta}(y,x)$ï¼Œå…¶ä¸­$\theta$æ˜¯å¯å­¦ä¹ çš„å‚æ•°ã€‚ç±»æ¯”FMï¼Œå¯ä»¥æ„å»ºDFMçš„æŸå¤±ï¼š</p> \[L_{DFM}(\theta) = \mathbb{E}_{t,X_t\sim p_t}D_{X_t}\big(u_t(\cdot,X_t),u_t^{\theta}(\cdot,X_t)\big) \tag{6}\] <p>è¿™é‡Œï¼Œ$t\sim U[0,1]$ï¼Œ$u_t(\cdot,x)\in R^{\mathcal{S}}$æ»¡è¶³é€Ÿç‡æ¡ä»¶ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ$u_t(\cdot,x)\in \Omega_x$ï¼Œä¸”ï¼š</p> \[\Omega_x = \left\{ v \in R^{\mathcal{S}} \mid v(y) &gt; 0 \text{ }\forall y \neq x,\text{ and } v(x) = - \sum_{y\neq x} v(y) \right\} \in R^{\mathcal{S}} \tag{7}\] <p>$\Omega_x$æ˜¯å‡¸é›†åˆã€‚$D_{X_t}(u,v)$æ˜¯Bregmanæ•£åº¦ï¼Œå…¶ä½¿ç”¨å‡¸å‡½æ•°$\Phi_x : \Omega_x \to \mathbb{R}$å®šä¹‰ã€‚</p> <hr/> <p>Bregmançš„å…·ä½“è®¡ç®—æ–¹å¼å¦‚ä¸‹å›¾å’Œä¸‹å¼æ‰€ç¤ºï¼š</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/post/DFM1-480.webp 480w,/assets/img/post/DFM1-800.webp 800w,/assets/img/post/DFM1-1400.webp 1400w," type="image/webp" sizes="95vw"/> <img src="/assets/img/post/DFM1.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption"> Bregmançš„å…·ä½“è®¡ç®—æ–¹å¼å›¾ç¤º </div> \[\displaystyle D( u,v) \ :=\ \Phi ( u) \ -\ [ \Phi ( v) \ +\ \langle u-v,\nabla \Phi ( v) \rangle ] \tag{8}\] <p>Bregmanæ•£åº¦æœ‰ä¸€äº›å…³é”®çš„æ€§è´¨ï¼Œåœ¨FMå’ŒDFMé‡Œé¢æœ€å…³é”®çš„æ˜¯å®ƒå¯¹ç¬¬äºŒä¸ªå‚æ•°çš„æ¢¯åº¦æœ‰ä»¿å°„ä¸å˜æ€§ï¼ˆaffine invariantï¼‰<sup id="fnref:3"><a href="#fn:3" class="footnote" rel="footnote" role="doc-noteref">3</a></sup>ï¼š</p> \[\nabla_v D(au_1 + b_u2, v) = a\nabla_v D(u_1,v) +b\nabla_vD(u_2,v), \text{ for any } a+b=1 \tag{9}\] <p>å› ä¸ºä»¿å°„ä¸å˜æ€§ï¼Œå¯ä»¥å¾—åˆ°$\nabla_vD(\mathbb{E}[Y] ,v) =\mathbb{E}[\nabla_v D(Y,v)]$ã€‚</p> <p>å…³äºBregmanæ•£åº¦çš„è¯¦ç»†ä¿¡æ¯ï¼Œåœ¨çŸ¥ä¹ä¸Šå·²ç»æœ‰å¾ˆå¥½çš„å›ç­”äº†ï¼Œå¯ä»¥å‚è€ƒï¼šhttps://www.zhihu.com/question/22426561ã€‚</p> <hr/> <p>å°±åƒåœ¨FMé‡Œé¢ä¸€æ ·ï¼Œæˆ‘ä»¬æ›´å…³æ³¨æ¡ä»¶DFMï¼ˆConditional Discrete Flow Matchingï¼ŒCDFMï¼‰çš„æŸå¤±å‡½æ•°å½¢å¼ï¼Œå› ä¸ºæˆ‘ä»¬æƒ³ä»¿ç…§FMé‡Œé¢ä¸€æ ·ç”¨ç¥ç»ç½‘ç»œé¢„æµ‹æ¡ä»¶é€Ÿåº¦åœºï¼Œå¦‚Flow matching for generative modeling<sup id="fnref:2:3"><a href="#fn:2" class="footnote" rel="footnote" role="doc-noteref">2</a></sup>é‡Œé¢çš„å…¬å¼9æ‰€ç¤ºã€‚é‚£ä¹ˆCDFMçš„æŸå¤±å°±æ˜¯ï¼š</p> \[L_{CDFM}(\theta) = \mathbb{E}_{t,Z,X_t\sim p_{t\mid Z}}D_{X_t}\big(u_t(\cdot,X_t \mid Z),u_t^{\theta}(\cdot,X_t)\big) \tag{10}\] <p>$u_t(\cdot,X_t \mid Z)$æ˜¯ç›®æ ‡æ¡ä»¶é€Ÿåº¦åœºï¼Œ$u_t^{\theta}(\cdot,X_t)$æ˜¯æ¨¡å‹å­¦ä¹ çš„æ¡ä»¶é€Ÿåº¦åœºã€‚</p> <p>åƒFMé‡Œé¢ä¸€æ ·ï¼Œæˆ‘ä»¬ä¹Ÿèƒ½è¯´æ˜å…¬å¼6å’Œå…¬å¼10çš„æ¢¯åº¦ä¸€æ ·ï¼š</p> <p><strong>å®šç†</strong> DFMå’ŒCDFMæŸå¤±çš„æ¢¯åº¦ç›¸åŒï¼š</p> \[\nabla_\theta L_{DFM}(\theta) =\nabla_\theta L_{CDFM}(\theta) \tag{11}\] <p>ä½¿å¾—CDFMæŸå¤±æœ€å°çš„$u^{\theta}_t(y, X_t)$æ˜¯ï¼š</p> \[u^{\theta}_t(y,X_t) = \mathbb{E} \left[ u_t(y,X_t \mid Z) \mid X_t =x \right] \tag{12}\] <hr/> <p>æˆ‘å‚ç…§<sup id="fnref:1:2"><a href="#fn:1" class="footnote" rel="footnote" role="doc-noteref">1</a></sup>ä»¥åŠä¸€äº›è‡ªå·±çš„ç†è§£ç»™äº†<strong>è¯æ˜</strong>ã€‚</p> <p>å…ˆçœ‹å…¬å¼11çš„è¯æ˜ï¼š</p> \[\begin{aligned} \nabla_\theta L_{DFM}(\theta) &amp;= \nabla_\theta \mathbb{E}_{t,X_t\sim p_t}\left[D_{X_t}\big(u_t(y,X_t),u_t^{\theta}(y,X_t)\big)\right] \\ &amp;= \mathbb{E}_{t,X_t\sim p_t} \left[\nabla_\theta D_{X_t}\big(u_t(y,X_t),u_t^{\theta}(y,X_t)\big) \right]\\ &amp;= \mathbb{E}_{t,X_t\sim p_t} \left[\nabla_{u^{\theta}_t(y,X_t)} D_{X_t}\big(u_t(y,X_t),u_t^{\theta}(y,X_t)\big)\nabla_{\theta}u^{\theta}_t(y,X_t) \right]\\ &amp;=\mathbb{E}_{t,X_t\sim p_t} \left[\nabla_{u^{\theta}_t(y,X_t)} D_{X_t}\big( \sum_Z u_t(y,X_t \mid Z) p_{Z\mid t}(Z\mid X_t) ,u_t^{\theta}(y,X_t)\big) \nabla_{\theta}u^{\theta}_t(y,X_t) \right] \\ &amp;=\mathbb{E}_{t,X_t\sim p_t} \left[\nabla_{u^{\theta}_t(y,X_t)} D_{X_t}\left( \mathbb{E}_{Z\sim p_{Z\mid t}(Z\mid X_t)} \left[u_t(y,X_t \mid Z)\right] ,u_t^{\theta}(y,X_t) \right) \nabla_{\theta}u^{\theta}_t(y,X_t) \right] \\ &amp;=\mathbb{E}_{t,X_t\sim p_t} \left[\nabla_{u^{\theta}_t(y,X_t)} \mathbb{E}_{Z\sim p_{Z\mid t}(Z\mid X_t)} \left[ D_{X_t}\left( u_t(y,X_t \mid Z) ,u_t^{\theta}(y,X_t) \right) \nabla_{\theta}u^{\theta}_t(y,X_t)\right] \right] \\ &amp;=\mathbb{E}_{t,X_t\sim p_t} \left[ \mathbb{E}_{Z\sim p_{Z\mid t}(Z\mid X_t)} \left[ \nabla_{u^{\theta}_t(y,X_t)} D_{X_t}\left( u_t(y,X_t \mid Z) ,u_t^{\theta}(y,X_t) \right) \nabla_{\theta}u^{\theta}_t(y,X_t)\right] \right] \\ &amp;=\mathbb{E}_{t,X_t\sim p_t} \left[ \mathbb{E}_{Z\sim p_{Z\mid t}(Z\mid X_t)} \left[ \nabla_{\theta} D_{X_t}\left( u_t(y,X_t \mid Z) ,u_t^{\theta}(y,X_t) \right) \right] \right] \\ &amp;=\nabla_{\theta} \mathbb{E}_{t,X_t\sim p_t} \left[ \mathbb{E}_{Z\sim p_{Z\mid t}(Z\mid X_t)} \left[ D_{X_t}\left( u_t(y,X_t \mid Z) ,u_t^{\theta}(y,X_t) \right) \right] \right] \\ &amp;=\nabla_{\theta} \mathbb{E}_{t,X_t\sim p_{t\mid Z}(X_t \mid Z),Z\sim q(Z)} \left[ D_{X_t}\left( u_t(y,X_t \mid Z) ,u_t^{\theta}(y,X_t) \right) \right] \\ &amp;= \nabla_{\theta} L_{CDFM}(\theta) \end{aligned} \tag{13}\] <p>å†çœ‹å…¬å¼12çš„è¯æ˜ï¼š</p> <p>ä»£å…¥å…¬å¼12åˆ°$L_{CDFM}(\theta)$ä¸­ï¼Œå¾—åˆ°</p> \[L_{CDFM}(\theta) = \mathbb{E}_{t,Z,X_t\sim p_{t\mid Z}}D_{X_t}\Big(u_t(y,X_t \mid Z), \mathbb{E} \left[ u_t(y,X_t \mid Z) \mid X_t =x \right]\Big) \tag{14}\] <p>æŒ‰ç…§Bregmanæ•£åº¦çš„å®šä¹‰ï¼Œå¯çŸ¥$L_{CDFM}(\theta) =0$ï¼Œæ˜¯ä¸€ä¸ªå…¨å±€æœ€å°å€¼ã€‚æ‰€ä»¥ä½¿å¾—$L_{CDFM}(\theta)$æœ€å°çš„$u^{\theta}_t$æ»¡è¶³å…¬å¼12ã€‚</p> <p>åœ¨Flow Matching Guide and Code<sup id="fnref:1:3"><a href="#fn:1" class="footnote" rel="footnote" role="doc-noteref">1</a></sup>21é¡µæœ€ä¸Šé¢ï¼ˆå…¬å¼4.25å’Œ4.26ï¼‰è¿˜æœ‰ä¸€ä¸ªæ›´ä¸€èˆ¬åŒ–çš„è¯æ˜ã€‚</p> <hr/> <p>è¿™ä¸€èŠ‚å…ˆåˆ°è¿™é‡Œå§ã€‚</p> <hr/> <div class="footnotes" role="doc-endnotes"> <ol> <li id="fn:1"> <p>Lipman Y, Havasi M, Holderrieth P, et al. Flow Matching Guide and Code[J]. arXiv preprint arXiv:2412.06264, 2024.Â <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a>Â <a href="#fnref:1:1" class="reversefootnote" role="doc-backlink">&#8617;<sup>2</sup></a>Â <a href="#fnref:1:2" class="reversefootnote" role="doc-backlink">&#8617;<sup>3</sup></a>Â <a href="#fnref:1:3" class="reversefootnote" role="doc-backlink">&#8617;<sup>4</sup></a></p> </li> <li id="fn:2"> <p>Lipman Y, Chen R T Q, Ben-Hamu H, et al. Flow matching for generative modeling[J]. arXiv preprint arXiv:2210.02747, 2022.Â <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a>Â <a href="#fnref:2:1" class="reversefootnote" role="doc-backlink">&#8617;<sup>2</sup></a>Â <a href="#fnref:2:2" class="reversefootnote" role="doc-backlink">&#8617;<sup>3</sup></a>Â <a href="#fnref:2:3" class="reversefootnote" role="doc-backlink">&#8617;<sup>4</sup></a></p> </li> <li id="fn:3"> <p>Holderrieth P, Havasi M, Yim J, et al. Generator Matching: Generative modeling with arbitrary Markov processes[J]. arXiv preprint arXiv:2410.20587, 2024.Â <a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> </ol> </div>]]></content><author><name></name></author><category term="Flow_Matching"/><category term="Discrete_Flow_Matching"/><category term="formatting"/><category term="math"/><summary type="html"><![CDATA[æœ¬æ–‡æ˜¯æ¥ç€ä¸Šä¸€æ¬¡å­¦ä¹ çš„CTMCæ¨¡å‹ç»§ç»­å­¦ä¹ ç¦»æ•£å‹æµåŒ¹é…æ¨¡å‹ï¼Œä¸»è¦æ˜¯è¯»Flow Matching Guide and Code1ç¬¬7ç« çš„ç¬”è®°ã€‚å¹¶éå®Œå…¨Flow Matching Guide and Codeçš„ç¿»è¯‘ï¼ŒæŒ‘äº†ä¸€äº›é‡è¦çš„å†…å®¹å¹¶ä¸”åŠ å…¥äº†æˆ‘è‡ªå·±çš„çš„ç†è§£ã€‚ Lipman Y, Havasi M, Holderrieth P, et al. Flow Matching Guide and Code[J]. arXiv preprint arXiv:2412.06264, 2024.Â &#8617;]]></summary></entry><entry><title type="html">è¿ç»­æ—¶é—´çš„é©¬å¯å¤«é“¾</title><link href="https://ly403.github.io/blog/2025/%E8%BF%9E%E7%BB%AD%E6%97%B6%E9%97%B4%E7%9A%84%E9%A9%AC%E5%8F%AF%E5%A4%AB%E9%93%BE/" rel="alternate" type="text/html" title="è¿ç»­æ—¶é—´çš„é©¬å¯å¤«é“¾"/><published>2025-01-02T00:00:00+00:00</published><updated>2025-01-02T00:00:00+00:00</updated><id>https://ly403.github.io/blog/2025/%E8%BF%9E%E7%BB%AD%E6%97%B6%E9%97%B4%E7%9A%84%E9%A9%AC%E5%8F%AF%E5%A4%AB%E9%93%BE</id><content type="html" xml:base="https://ly403.github.io/blog/2025/%E8%BF%9E%E7%BB%AD%E6%97%B6%E9%97%B4%E7%9A%84%E9%A9%AC%E5%8F%AF%E5%A4%AB%E9%93%BE/"><![CDATA[<p>æœ¬æ–‡åŸºäºFlow Matching Guide and Code<sup id="fnref:1"><a href="#fn:1" class="footnote" rel="footnote" role="doc-noteref">1</a></sup> ï¼Œä¸»è¦æ˜¯è¯»è¿™ç¯‡æ–‡ç« æ—¶å€™çš„ç¬”è®°ã€‚</p> <p>è¿ç»­æ—¶é—´çš„é©¬å¯å¤«é“¾ï¼ˆContinuous Time Markov Chainsï¼ŒCTMCï¼‰æ˜¯Flowçš„æ›¿ä»£ï¼Œä¹Ÿæ˜¯ä¸€ç§ç”Ÿæˆå¼æ¨¡å‹ï¼Œç”¨æ¥ç”Ÿæˆç¦»æ•£çš„æ•°æ®ã€‚å®ƒæ˜¯ç¦»æ•£å‹Flow Matchingï¼ˆDiscrete Flow Matchingï¼Œ DFMï¼‰<sup id="fnref:2"><a href="#fn:2" class="footnote" rel="footnote" role="doc-noteref">2</a></sup>çš„åŸºç¡€ã€‚</p> <h2 id="ç¦»æ•£çŠ¶æ€ç©ºé—´å’Œéšæœºå˜é‡">ç¦»æ•£çŠ¶æ€ç©ºé—´å’Œéšæœºå˜é‡</h2> <p>è¿™ä¸€èŠ‚å°±æ˜¯è®²ä¸€äº›notationsã€‚</p> <p>ä»¥ç±»æ¯”çš„æ–¹æ³•å¯ä»¥è¡¨ç¤ºç¦»æ•£çŠ¶æ€ç©ºé—´ï¼š</p> <ul> <li> <p>è¿ç»­çŠ¶æ€ç©ºé—´ï¼š $\mathbb{R}^{d}$ï¼Œ$d$æ˜¯ç©ºé—´ç»´åº¦</p> </li> <li> <p>ç¦»æ•£çŠ¶æ€ç©ºé—´ï¼š$\mathcal{S} = \mathcal{T}^d$ï¼Œ$d$æ˜¯ç©ºé—´ç»´åº¦ï¼Œå…¶ä¸­$\mathcal{T}=[K]={1,2,\cdots, K}$ï¼Œ$\mathcal{T}$ä¹Ÿå°±æ˜¯vocabularyã€‚</p> </li> </ul> <p>ä»$\mathcal{S}$ä¸­é‡‡æ ·çš„æ ·æœ¬è®°ä¸º$x = (x^1,x^2,\cdots,x^d)\in\mathcal{S}$ï¼Œå…¶ä¸­$x^i$å°±æ˜¯ä¸€ä¸ªtokenã€‚</p> <p>ç”¨$X$è¡¨ç¤ºçŠ¶æ€ç©ºé—´$\mathcal{S}$ä¸­çš„éšæœºå˜é‡ï¼Œå…¶pmfï¼ˆprobability mass functionï¼Œæ¦‚ç‡è´¨é‡å‡½æ•°ï¼Œç¦»æ•£åˆ†å¸ƒå«æ¦‚ç‡è´¨é‡å‡½æ•°ï¼Œè¿ç»­åˆ†å¸ƒå«æ¦‚ç‡å¯†åº¦å‡½æ•°ï¼‰ä¸º\(p_X : \mathcal{S} \to \mathbb{R}_{\ge 0}\)ï¼Œå®é™…ä¸Špmfæ˜¯ä¸€ä¸ªä»çŠ¶æ€ç©ºé—´\(\mathcal{S}\)åˆ°æ­£å®æ•°é›†çš„æ˜ å°„ã€‚pmfæ»¡è¶³æ±‚å’Œä¸º1çš„çº¦æŸæ¡ä»¶ï¼š\(\sum_{x\in\mathcal{S}}p_X(x)=1\)ã€‚</p> <p>å¯¹äºäº‹ä»¶$A\in\mathcal{S}$ï¼Œå…¶å‘ç”Ÿæ¦‚ç‡å¯ä»¥å¦‚ä¸‹è®¡ç®—ï¼š</p> \[\mathbb{P}(X\in A)=\sum_{x\in A}p_X(x)\] <p>è¿˜éœ€è¦ä¸€ä¸ªdeltaåˆ†å¸ƒï¼ˆå¥½åƒä¹Ÿå«Diracåˆ†å¸ƒï¼‰çš„pmfè¡¨ç¤ºï¼Œå¦‚ä¸‹ï¼š</p> \[\delta(x,z)=\begin{cases} +\infty \quad x=z\\ 0\quad \text{else}. \end{cases}\] <p>è¿™ä¸ªåˆ†å¸ƒè¡¨ç¤ºåªæœ‰$x$å–ç‰¹å®šå€¼$z$çš„æ—¶å€™æ‰æœ‰æ¦‚ç‡ï¼Œæ²¡æœ‰æ¦‚ç‡å–å…¶ä»–å€¼ã€‚ä½†æ˜¯è¯¥åˆ†å¸ƒçš„pmfåœ¨xçš„å®šä¹‰åŸŸç§¯åˆ†ä¹Ÿæ˜¯1ã€‚</p> <p>æœ‰æ—¶å€™ä¹Ÿä¼šåœ¨tokenå±‚çº§ä¸Šå®šä¹‰deltaåˆ†å¸ƒï¼Œä¾‹å¦‚$\delta(x^i,y^i)\quad x^i,y^i \in \mathcal{T}$ã€‚</p> <p>å…³äºDiracåˆ†å¸ƒçš„æ›´å¤šä¿¡æ¯å¯ä»¥å‚è€ƒï¼š<a href="https://spaces.ac.cn/archives/1870">https://spaces.ac.cn/archives/1870</a></p> <h2 id="ctmcç”Ÿæˆå¼æ¨¡å‹">CTMCç”Ÿæˆå¼æ¨¡å‹</h2> <p>CTMCæ˜¯è¿ç»­æ—¶é—´çš„é©¬å¯å¤«é“¾ï¼Œé©¬å¯å¤«é“¾æ˜¯ç¦»æ•£çŠ¶æ€çš„é©¬å¯å¤«è¿‡ç¨‹ã€‚æ‰€ä»¥CTMCæ˜¯è¿ç»­æ—¶é—´ç¦»æ•£çŠ¶æ€çš„é©¬å¯å¤«è¿‡ç¨‹ï¼Œå¯ä»¥è¡¨ç¤ºä¸º$(X_t)_{0\le t\le 1}$ã€‚å› ä¸ºCTMCæ˜¯éšæœºè¿‡ç¨‹å˜›ï¼Œæ‰€ä»¥å®ƒæ˜¯ä¸€æ—éšæœºå˜é‡ã€‚å®ƒçš„é©¬å¯å¤«å‡è®¾å¯ä»¥è¡¨ç¤ºä¸ºå¦‚ä¸‹çš„å½¢å¼ï¼š</p> \[\mathbb{P}(X_{t+s}=z\mid X_s =x,X_u=y,0\le u\le s)=\mathbb{P}(X_{t+s}=z\mid X_s = x)\] <p>ç±»æ¯”ç¦»æ•£æ—¶é—´çš„é©¬å¯å¤«é“¾ï¼Œè¿™ä¸ªå…¬å¼è¯´çš„å°±æ˜¯åªè¦çŸ¥é“$X_s$çš„å€¼åï¼Œåœ¨$s$æ—¶åˆ»ä¹‹å‰çš„å€¼ï¼ˆä¾‹å¦‚å¼å­ä¸­çš„$X_u$ï¼‰ï¼Œå¯¹$s$æ—¶å€™ä¹‹åçš„å€¼æ²¡æœ‰å½±å“ï¼ˆå¼ä¸­$X_{t+s}$ï¼‰ã€‚å³â€œé—å¿˜è¿‡å»â€ã€‚å…³äºCTMCæ›´å¤šçš„ä»‹ç»å¯ä»¥å‚è€ƒï¼š<a href="https://www.math.pku.edu.cn/teachers/lidf/course/stochproc/stochprocnotes/html/_book/markovc.html#markovc-ctime">https://www.math.pku.edu.cn/teachers/lidf/course/stochproc/stochprocnotes/html/_book/markovc.html#markovc-ctime</a>ã€‚</p> <p>ç±»æ¯”æ‰©æ•£æ¨¡å‹å’ŒFlow Matchingï¼Œä¹Ÿå¯ä»¥å®šä¹‰CTMCçš„è½¬ç§»æ ¸ï¼ˆprobability transition kernelï¼‰ä¸º$p_{t+h\mid t}$ï¼Œå…¶å½¢å¼å¦‚ä¸‹ï¼š</p> <p>\begin{equation} p_{t+h\mid t}:= \mathbb{P}(X_{t+h}=y\mid X_t = x)=\delta(y,x)+hu_t(y,x)+o(h), \quad \mathbb{P}(X_0=x)=p(x)\label{eq:transition_kernel} \end{equation}</p> <p>$p_{t+h\mid t}$çš„å›¾ç¤ºå¦‚ä¸‹ï¼š</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/post/CTMC-480.webp 480w,/assets/img/post/CTMC-800.webp 800w,/assets/img/post/CTMC-1400.webp 1400w," type="image/webp" sizes="95vw"/> <img src="/assets/img/post/CTMC.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"/> </picture> </figure> </div> </div> <div class="caption"> CTMCæ¨¡å‹çš„çŠ¶æ€è½¬ç§»è¿‡ç¨‹å›¾ç¤º </div> <p>å…¬å¼$\eqref{eq:transition_kernel}$ä¸­ï¼Œ$p$è¡¨ç¤ºéšæœºè¿‡ç¨‹$(X_t)_{0\le t\le 1}$åœ¨$t=0$æ—¶å€™çš„åˆ†å¸ƒï¼ˆå–$t=0$éšæœºè¿‡ç¨‹é€€åŒ–æˆéšæœºå˜é‡ï¼‰ã€‚$o(h)$æ˜¯é«˜é˜¶æ— ç©·å°é‡</p> \[\lim_{h\to0} \cfrac{o(h)}{h} = 0\] <p>å…¶ä¸­ï¼Œ$u_t(y,x)$å«åšé€Ÿç‡ï¼ˆratesæˆ–è€…velocitiesï¼‰ï¼Œå®ƒå¯ä»¥ç±»æ¯”Flow Matchingé‡Œé¢è®²çš„å‘é‡åœºï¼Œåœ¨CTMCé‡Œé¢è¡¨ç¤ºçš„æ˜¯è¡¨ç¤ºçŠ¶æ€ä¹‹é—´æ¦‚ç‡è½¬æ¢çš„é€Ÿç‡ï¼ŒæŒ‰æˆ‘çš„ç†è§£ï¼Œå°±æ˜¯ä¸‹é¢çš„è¿™ä¸ªå½¢å¼ï¼š</p> <p>\begin{equation} u_t(y,x) =\lim_{h\to 0}\cfrac{\mathbb{P}(X_{t+h}=y\mid X_t = x)}{h} \label{eq:rate} \end{equation}</p> <p>å®ƒæ˜¯æ—¶é—´$t$çš„å‡½æ•°ã€‚ä»å…¬å¼$\eqref{eq:rate}$å’Œå…¬å¼$\eqref{eq:transition_kernel}$çš„è§’åº¦ç†è§£ï¼Œ$\delta(y,x)$å°±æ˜¯å‘ç”ŸçŠ¶æ€è½¬ç§»å‰ï¼ˆå³$t$æ—¶åˆ»ï¼‰çš„åˆå§‹çŠ¶æ€ã€‚å…·ä½“è®²ï¼Œç”±äºæˆ‘ä»¬ä»¥$X_t=x$ä¸ºæ¡ä»¶ï¼Œæ‰€ä»¥åˆå§‹çŠ¶æ€å°±æ˜¯ç¡®å®šçš„ï¼Œç”¨æ¦‚ç‡å½¢å¼è¡¨ç¤ºå°±æ˜¯$\delta(\cdot,x)$ï¼Œä¹Ÿå°±æ˜¯è¯´åˆå§‹çŠ¶æ€æ—¶ï¼ˆå³$t$æ—¶åˆ»ï¼‰ï¼Œåœ¨$x$å¤„æœ‰æ¦‚ç‡ï¼Œè€Œå…¶ä»–çŠ¶æ€ç©ºé—´ä¸­çš„ç‚¹æ¦‚ç‡éƒ½æ˜¯0ã€‚</p> <p>å…¬å¼$\eqref{eq:transition_kernel}$ä¸­ï¼Œ$u_t(y,x)$éœ€è¦æ»¡è¶³ä¸€å®šçš„æ¡ä»¶ï¼Œç§°ä¸ºé€Ÿç‡æ¡ä»¶ï¼ˆrate conditionsï¼‰ï¼š</p> <p>\begin{equation} u_t(y,x)\ge 0 \text{ for all } y\neq x \text{, and }\sum_{y}u_t(y,x) =0 \label{eq:rate_cond} \end{equation}</p> <p>è¿™æ ·å°±æ˜¯è¯´ï¼Œ$u_t(x,x)&lt; 0$ï¼Œä¸”$u_t(x,x)=-\sum_{y\neq x}u_t(y,x)$ã€‚é€Ÿåº¦æ¡ä»¶çš„å­˜åœ¨æ˜¯ä¸ºäº†ä¿è¯å…¬å¼$\eqref{eq:transition_kernel}$ç®—å‡ºçš„è½¬ç§»æ ¸$p_{t+h\mid t}(\cdot\mid x)\ge0$ä¸”$\sum p_{t+h\mid t}(\cdot\mid x)=1$ã€‚</p> <p>ç±»æ¯”Flow Matchingï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è¯´ï¼š<strong>å¦‚æœå­˜åœ¨$p_{t+h\mid t}$æ»¡è¶³å…¬å¼$\eqref{eq:transition_kernel}$ï¼Œ$p_{t+h\mid t}$çš„è¾¹ç¼˜åˆ†å¸ƒä¸º$p_t$ï¼Œåˆ™ç§°$u_t$ç”Ÿæˆäº†$p_t$</strong>ã€‚</p> <p>ç”¨å…¬å¼$\eqref{eq:transition_kernel}$ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨Euleræ³•ï¼ˆç±»æ¯”æ‰©æ•£æ¨¡å‹å’ŒFlow Matchingé‡Œé¢ODEçš„è§£æ³•ï¼‰æ¥é‡‡æ ·ï¼Œå¦‚ä¸‹ï¼š</p> \[\mathbb{P}(X_{t+h}=y\mid X_t)=\delta(y,X_t)+hu_t(y,X_t)\] <p>ä½†æ˜¯è¯¥å¼å¼•å…¥äº†ä¸€ä¸ªåå·®ï¼Œå°±æ˜¯$o(h)$ã€‚å› ä¸ºè¿™æ˜¯ä¸€ä¸ªé«˜é˜¶å°é‡ï¼Œæ‰€ä»¥åªè¦$h$è¶³å¤Ÿå°ï¼Œé‚£ä¹ˆ$o(h)$å°±ä¼šè¶‹äº0ï¼Œè¿™å°±æ˜¯å¸Œæœ›Euleræ³•é‡‡æ ·å‡†ç¡®çš„æ¡ä»¶ï¼Œä½†æ˜¯è¿™æ ·é‡‡æ ·æ­¥éª¤å°±ä¼šå¾ˆå¤šã€‚ä¸€ç§ç¼“è§£è¿™ä¸ªé—®é¢˜çš„æ–¹æ³•æ˜¯ç”¨å¦‚ä¸‹çš„Euleræ³•ï¼š</p> \[\mathbb{P}(X_{t+h}=y\mid X_t) =\begin{cases} \exp \left[hu_t(X_t,X_t)\right] \qquad \qquad\qquad\qquad\qquad y=X_t \\ \cfrac{u_t(y,X_t)}{\left|u_t(X_t,X_t) \right|}\left( 1 - \exp\left[hu_t(X_t,X_t)\right] \right) \qquad y\neq X_t \end{cases}\] <h2 id="æ¦‚ç‡è·¯å¾„å’Œkolmogorovæ–¹ç¨‹">æ¦‚ç‡è·¯å¾„å’ŒKolmogorovæ–¹ç¨‹</h2> <p>ç±»æ¯”è¿ç»­æƒ…å†µä¸‹çš„ä¸€è‡´æ€§æ–¹ç¨‹ï¼ˆContinuity Equationï¼‰ï¼ŒCTMCæ¨¡å‹çš„è¾¹ç¼˜æ¦‚ç‡$p_t$æ»¡è¶³Kolmogorovæ–¹ç¨‹ï¼š</p> <p>\begin{equation} \cfrac{\mathrm{d}}{\mathrm{d}t}p_t(y)=\sum_x u_t(y,x)p_t(x) \label{eq:Kolmogorov} \end{equation}</p> <p>ä¸‹é¢è¿™ä¸ªå®šç†æè¿°äº†ä¸Šå¼è¿™ç§çº¿æ€§ODEç³»ç»Ÿå”¯ä¸€è§£çš„å­˜åœ¨æ€§ï¼š</p> <p><strong>å®šç†</strong>ï¼ˆçº¿æ€§ODEçš„è§£çš„å­˜åœ¨æ€§å’Œå”¯ä¸€æ€§ï¼‰ï¼šå¦‚æœ$u_t(y,x)$åœ¨$C([0,1))$ä¸­ï¼ˆå³åœ¨æ—¶é—´$t$ä¸Šè¿ç»­ï¼‰ï¼Œé‚£ä¹ˆå­˜åœ¨å”¯ä¸€çš„è§£$p_t(x)$æ»¡è¶³Kolmogorovæ–¹ç¨‹$\eqref{eq:Kolmogorov}$ï¼Œå…¶ä¸­ï¼Œ$t\in[0,1)$ï¼Œåˆå§‹çŠ¶æ€$p_0(x) = p(x)$ã€‚</p> <p>å¯¹CTMCè€Œè¨€ï¼Œåœ¨$t\in[0,1)$åŒºé—´ï¼Œä¸éœ€è¦é¢å¤–çš„æ¡ä»¶ï¼Œå°±èƒ½å¤Ÿç¡®å®šè§£ä¸€å®šå­˜åœ¨ã€‚å…³äºè¯¥å®šç†çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯å¯ä»¥å‚è€ƒCoddington et al. (1956)<sup id="fnref:3"><a href="#fn:3" class="footnote" rel="footnote" role="doc-noteref">3</a></sup>ä¸­çš„å®šç†5.1å’Œ5.2ã€‚</p> <p>æ–¹ç¨‹$\eqref{eq:Kolmogorov}$å¯ä»¥åŒ–ä¸ºï¼š</p> \[\begin{equation} \begin{aligned} \sum_x u_t(y,x)p_t(x) &amp;=\underbrace{\sum_{x\neq y} u_t(y,x)p_t(x)}_{è¾“å…¥é€šé‡}-\underbrace{\sum_{x\neq y}u_t(x,y)p_t(y)}_{è¾“å‡ºé€šé‡} \\ &amp;=-\sum_{x\neq y}\left[j_t(x,y)-j_t(y,x)\right] \\ \end{aligned} \end{equation}\] <p>å…¶ä¸­ï¼Œ$j_t(y,x):=u_t(y,x)p_t(x)$ï¼Œç§°ä¸ºæ¦‚ç‡é€šé‡ï¼ˆprobability fluxï¼‰ã€‚ä¸Šå¼å¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯æŠŠä»$x$è¾“å…¥åˆ°$y$çš„é€šé‡åˆ†æˆäº†ä»$x$è¾“å…¥åˆ°$y$çš„éƒ¨åˆ†å’Œä»$y$è¾“å‡ºåˆ°$x$çš„éƒ¨åˆ†ã€‚</p> <p>å°†è¾“å‡ºé€šé‡è¶…å‡ºæ¥çš„éƒ¨åˆ†å®šä¹‰ä¸ºæ•£åº¦ï¼Œå³</p> \[\text{div}(u_t p_t)(y) =\sum_{x\neq y}\left[j_t(x,y)-j_t(y,x)\right]\] <p>é‚£ä¹ˆKolmogorovæ–¹ç¨‹å°±å¯ä»¥è¡¨ç¤ºä¸ºï¼š</p> \[\dot p_t(y)+\text{div}(u_t p_t)(y)=0\] <p>è¿™å’Œè¿ç»­å‹Flow Matchingçš„ä¸€è‡´æ€§æ–¹ç¨‹ç»Ÿä¸€èµ·æ¥äº†ã€‚</p> <p>ä»¥ä¸‹è¿˜æœ‰ä¸€ä¸ªç»“æœï¼Œæ˜¯åœ¨CTMC æ¡†æ¶ä¸­æ„å»ºæ¦‚ç‡è·¯å¾„å’Œé€Ÿåº¦çš„ä¸»è¦å·¥å…·ï¼š</p> <p><strong>å®šç†</strong> ï¼ˆç¦»æ•£è´¨é‡å®ˆæ’ï¼ŒDiscrete Mass Conservationï¼‰ï¼š$u_t(y,x)$åœ¨$C([0,1))$ä¸­ï¼Œ$p_t(x)$åœ¨$C^1([0,1))$ä¸­ï¼ˆæˆ‘çš„ç†è§£æ˜¯ä¸€é˜¶å¯¼æ•°åœ¨æ—¶é—´$t$ä¸Šè¿ç»­ï¼‰ï¼Œåˆ™å¦‚ä¸‹ä¸¤ä¸ªç»“è®ºæ˜¯ç­‰ä»·çš„ï¼š</p> <ul> <li>åœ¨$t\in[0,1)$æ—¶ï¼Œ $p_t,u_t$æ»¡è¶³Kolmogorovæ–¹ç¨‹$\eqref{eq:Kolmogorov}$ï¼Œ$u_t$æ»¡è¶³é€Ÿç‡æ¡ä»¶$\eqref{eq:rate_cond}$ã€‚</li> <li>åœ¨$t\in[0,1)$æ—¶ï¼Œ$u_t$ç”Ÿæˆï¼ˆç”¨å‰æ–‡çš„æœ¯è¯­ï¼‰äº†$p_t$ã€‚</li> </ul> <p>è¯¥å®šç†çš„è¯æ˜åœ¨<sup id="fnref:1:1"><a href="#fn:1" class="footnote" rel="footnote" role="doc-noteref">1</a></sup>çš„appendix A.1.ã€‚</p> <h3 id="ä¿æ¦‚ç‡é€Ÿç‡probability-preserving-velocities">ä¿æ¦‚ç‡é€Ÿç‡ï¼ˆProbability preserving velocitiesï¼‰</h3> <p>å¦‚æœ$u_t(y,x)$ç”Ÿæˆäº†æ¦‚ç‡è·¯å¾„$p_t(x)$ï¼Œæˆ‘ä»¬æ„é€ ä¸€ä¸ªæ–°çš„é€Ÿç‡ï¼š</p> \[\tilde u_t(y,x) = u_t(y,x) + v_t(y,x)\] <p>åªè¦$v_t(y,x)$æ»¡è¶³é€Ÿç‡æ¡ä»¶ä¸”</p> \[\sum_x v_t(y,x)p_t(x) = 0\] <p>é‚£ä¹ˆ$\tilde u_t(y,x)$è¿˜èƒ½Kolmogorovæ–¹ç¨‹ï¼š</p> \[\sum_x \tilde u_t(y,x)p_t(x) = \sum_x u_t(y,x)p_t(x) = \dot p_t(y)\] <p>é‚£ä¹ˆ$\tilde u_t(y,x)$è¿˜èƒ½ç”Ÿæˆ$p_t(x)$ã€‚è¿™ä¸ªç»“è®ºåœ¨ç¦»æ•£å‹Flow Matchingé‡Œé¢éå¸¸é‡è¦ã€‚</p> <hr/> <div class="footnotes" role="doc-endnotes"> <ol> <li id="fn:1"> <p>Lipman Y, Havasi M, Holderrieth P, et al. Flow Matching Guide and Code[J]. arXiv preprint arXiv:2412.06264, 2024.Â <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a>Â <a href="#fnref:1:1" class="reversefootnote" role="doc-backlink">&#8617;<sup>2</sup></a></p> </li> <li id="fn:2"> <p>Gat I, Remez T, Shaul N, et al. Discrete flow matching[J]. arXiv preprint arXiv:2407.15595, 2024.Â <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> <li id="fn:3"> <p>Coddington E A, Levinson N, Teichmann T. Theory of ordinary differential equations[J]. 1956.Â <a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p> </li> </ol> </div>]]></content><author><name></name></author><category term="Flow_Matching"/><category term="Discrete_Flow_Matching"/><category term="formatting"/><category term="math"/><summary type="html"><![CDATA[æœ¬æ–‡åŸºäºFlow Matching Guide and Code1 ï¼Œä¸»è¦æ˜¯è¯»è¿™ç¯‡æ–‡ç« æ—¶å€™çš„ç¬”è®°ã€‚ è¿ç»­æ—¶é—´çš„é©¬å¯å¤«é“¾ï¼ˆContinuous Time Markov Chainsï¼ŒCTMCï¼‰æ˜¯Flowçš„æ›¿ä»£ï¼Œä¹Ÿæ˜¯ä¸€ç§ç”Ÿæˆå¼æ¨¡å‹ï¼Œç”¨æ¥ç”Ÿæˆç¦»æ•£çš„æ•°æ®ã€‚å®ƒæ˜¯ç¦»æ•£å‹Flow Matchingï¼ˆDiscrete Flow Matchingï¼Œ DFMï¼‰2çš„åŸºç¡€ã€‚ ç¦»æ•£çŠ¶æ€ç©ºé—´å’Œéšæœºå˜é‡ è¿™ä¸€èŠ‚å°±æ˜¯è®²ä¸€äº›notationsã€‚ ä»¥ç±»æ¯”çš„æ–¹æ³•å¯ä»¥è¡¨ç¤ºç¦»æ•£çŠ¶æ€ç©ºé—´ï¼š è¿ç»­çŠ¶æ€ç©ºé—´ï¼š $\mathbb{R}^{d}$ï¼Œ$d$æ˜¯ç©ºé—´ç»´åº¦ ç¦»æ•£çŠ¶æ€ç©ºé—´ï¼š$\mathcal{S} = \mathcal{T}^d$ï¼Œ$d$æ˜¯ç©ºé—´ç»´åº¦ï¼Œå…¶ä¸­$\mathcal{T}=[K]={1,2,\cdots, K}$ï¼Œ$\mathcal{T}$ä¹Ÿå°±æ˜¯vocabularyã€‚ ä»$\mathcal{S}$ä¸­é‡‡æ ·çš„æ ·æœ¬è®°ä¸º$x = (x^1,x^2,\cdots,x^d)\in\mathcal{S}$ï¼Œå…¶ä¸­$x^i$å°±æ˜¯ä¸€ä¸ªtokenã€‚ ç”¨$X$è¡¨ç¤ºçŠ¶æ€ç©ºé—´$\mathcal{S}$ä¸­çš„éšæœºå˜é‡ï¼Œå…¶pmfï¼ˆprobability mass functionï¼Œæ¦‚ç‡è´¨é‡å‡½æ•°ï¼Œç¦»æ•£åˆ†å¸ƒå«æ¦‚ç‡è´¨é‡å‡½æ•°ï¼Œè¿ç»­åˆ†å¸ƒå«æ¦‚ç‡å¯†åº¦å‡½æ•°ï¼‰ä¸º\(p_X : \mathcal{S} \to \mathbb{R}_{\ge 0}\)ï¼Œå®é™…ä¸Špmfæ˜¯ä¸€ä¸ªä»çŠ¶æ€ç©ºé—´\(\mathcal{S}\)åˆ°æ­£å®æ•°é›†çš„æ˜ å°„ã€‚pmfæ»¡è¶³æ±‚å’Œä¸º1çš„çº¦æŸæ¡ä»¶ï¼š\(\sum_{x\in\mathcal{S}}p_X(x)=1\)ã€‚ å¯¹äºäº‹ä»¶$A\in\mathcal{S}$ï¼Œå…¶å‘ç”Ÿæ¦‚ç‡å¯ä»¥å¦‚ä¸‹è®¡ç®—ï¼š \[\mathbb{P}(X\in A)=\sum_{x\in A}p_X(x)\] è¿˜éœ€è¦ä¸€ä¸ªdeltaåˆ†å¸ƒï¼ˆå¥½åƒä¹Ÿå«Diracåˆ†å¸ƒï¼‰çš„pmfè¡¨ç¤ºï¼Œå¦‚ä¸‹ï¼š \[\delta(x,z)=\begin{cases} +\infty \quad x=z\\ 0\quad \text{else}. \end{cases}\] è¿™ä¸ªåˆ†å¸ƒè¡¨ç¤ºåªæœ‰$x$å–ç‰¹å®šå€¼$z$çš„æ—¶å€™æ‰æœ‰æ¦‚ç‡ï¼Œæ²¡æœ‰æ¦‚ç‡å–å…¶ä»–å€¼ã€‚ä½†æ˜¯è¯¥åˆ†å¸ƒçš„pmfåœ¨xçš„å®šä¹‰åŸŸç§¯åˆ†ä¹Ÿæ˜¯1ã€‚ æœ‰æ—¶å€™ä¹Ÿä¼šåœ¨tokenå±‚çº§ä¸Šå®šä¹‰deltaåˆ†å¸ƒï¼Œä¾‹å¦‚$\delta(x^i,y^i)\quad x^i,y^i \in \mathcal{T}$ã€‚ å…³äºDiracåˆ†å¸ƒçš„æ›´å¤šä¿¡æ¯å¯ä»¥å‚è€ƒï¼šhttps://spaces.ac.cn/archives/1870 CTMCç”Ÿæˆå¼æ¨¡å‹ CTMCæ˜¯è¿ç»­æ—¶é—´çš„é©¬å¯å¤«é“¾ï¼Œé©¬å¯å¤«é“¾æ˜¯ç¦»æ•£çŠ¶æ€çš„é©¬å¯å¤«è¿‡ç¨‹ã€‚æ‰€ä»¥CTMCæ˜¯è¿ç»­æ—¶é—´ç¦»æ•£çŠ¶æ€çš„é©¬å¯å¤«è¿‡ç¨‹ï¼Œå¯ä»¥è¡¨ç¤ºä¸º$(X_t)_{0\le t\le 1}$ã€‚å› ä¸ºCTMCæ˜¯éšæœºè¿‡ç¨‹å˜›ï¼Œæ‰€ä»¥å®ƒæ˜¯ä¸€æ—éšæœºå˜é‡ã€‚å®ƒçš„é©¬å¯å¤«å‡è®¾å¯ä»¥è¡¨ç¤ºä¸ºå¦‚ä¸‹çš„å½¢å¼ï¼š \[\mathbb{P}(X_{t+s}=z\mid X_s=x,X_u=y,0\le u\le s)=\mathbb{P}(X_{t+s}=z\mid X_s=x)\] ç±»æ¯”ç¦»æ•£æ—¶é—´çš„é©¬å¯å¤«é“¾ï¼Œè¿™ä¸ªå…¬å¼è¯´çš„å°±æ˜¯åªè¦çŸ¥é“$X_s$çš„å€¼åï¼Œåœ¨$s$æ—¶åˆ»ä¹‹å‰çš„å€¼ï¼ˆä¾‹å¦‚å¼å­ä¸­çš„$X_u$ï¼‰ï¼Œå¯¹$s$æ—¶å€™ä¹‹åçš„å€¼æ²¡æœ‰å½±å“ï¼ˆå¼ä¸­$X_{t+s}$ï¼‰ã€‚å³â€œé—å¿˜è¿‡å»â€ã€‚å…³äºCTMCæ›´å¤šçš„ä»‹ç»å¯ä»¥å‚è€ƒï¼šhttps://www.math.pku.edu.cn/teachers/lidf/course/stochproc/stochprocnotes/html/_book/markovc.html#markovc-ctimeã€‚ ç±»æ¯”æ‰©æ•£æ¨¡å‹å’ŒFlow Matchingï¼Œä¹Ÿå¯ä»¥å®šä¹‰CTMCçš„è½¬ç§»æ ¸ï¼ˆprobability transition kernelï¼‰ä¸º$p_{t+h\mid t}$ï¼Œå…¶å½¢å¼å¦‚ä¸‹ï¼š \begin{equation} p_{t+h\mid t}:= \mathbb{P}(X_{t+h}=y\mid X_t=x)=\delta(y,x)+hu_t(y,x)+o(h), \quad \mathbb{P}(X_0=x)=p(x)\label{eq:transition_kernel} \end{equation} $p_{t+h\mid t}$çš„å›¾ç¤ºå¦‚ä¸‹ï¼š CTMCæ¨¡å‹çš„çŠ¶æ€è½¬ç§»è¿‡ç¨‹å›¾ç¤º å…¬å¼$\eqref{eq:transition_kernel}$ä¸­ï¼Œ$p$è¡¨ç¤ºéšæœºè¿‡ç¨‹$(X_t)_{0\le t\le 1}$åœ¨$t=0$æ—¶å€™çš„åˆ†å¸ƒï¼ˆå–$t=0$éšæœºè¿‡ç¨‹é€€åŒ–æˆéšæœºå˜é‡ï¼‰ã€‚$o(h)$æ˜¯é«˜é˜¶æ— ç©·å°é‡ \[\lim_{h\to0} \cfrac{o(h)}{h} = 0\] å…¶ä¸­ï¼Œ$u_t(y,x)$å«åšé€Ÿç‡ï¼ˆratesæˆ–è€…velocitiesï¼‰ï¼Œå®ƒå¯ä»¥ç±»æ¯”Flow Matchingé‡Œé¢è®²çš„å‘é‡åœºï¼Œåœ¨CTMCé‡Œé¢è¡¨ç¤ºçš„æ˜¯è¡¨ç¤ºçŠ¶æ€ä¹‹é—´æ¦‚ç‡è½¬æ¢çš„é€Ÿç‡ï¼ŒæŒ‰æˆ‘çš„ç†è§£ï¼Œå°±æ˜¯ä¸‹é¢çš„è¿™ä¸ªå½¢å¼ï¼š \begin{equation} u_t(y,x) =\lim_{h\to 0}\cfrac{\mathbb{P}(X_{t+h}=y\mid X_t=x)}{h} \label{eq:rate} \end{equation} å®ƒæ˜¯æ—¶é—´$t$çš„å‡½æ•°ã€‚ä»å…¬å¼$\eqref{eq:rate}$å’Œå…¬å¼$\eqref{eq:transition_kernel}$çš„è§’åº¦ç†è§£ï¼Œ$\delta(y,x)$å°±æ˜¯å‘ç”ŸçŠ¶æ€è½¬ç§»å‰ï¼ˆå³$t$æ—¶åˆ»ï¼‰çš„åˆå§‹çŠ¶æ€ã€‚å…·ä½“è®²ï¼Œç”±äºæˆ‘ä»¬ä»¥$X_t=x$ä¸ºæ¡ä»¶ï¼Œæ‰€ä»¥åˆå§‹çŠ¶æ€å°±æ˜¯ç¡®å®šçš„ï¼Œç”¨æ¦‚ç‡å½¢å¼è¡¨ç¤ºå°±æ˜¯$\delta(\cdot,x)$ï¼Œä¹Ÿå°±æ˜¯è¯´åˆå§‹çŠ¶æ€æ—¶ï¼ˆå³$t$æ—¶åˆ»ï¼‰ï¼Œåœ¨$x$å¤„æœ‰æ¦‚ç‡ï¼Œè€Œå…¶ä»–çŠ¶æ€ç©ºé—´ä¸­çš„ç‚¹æ¦‚ç‡éƒ½æ˜¯0ã€‚ å…¬å¼$\eqref{eq:transition_kernel}$ä¸­ï¼Œ$u_t(y,x)$éœ€è¦æ»¡è¶³ä¸€å®šçš„æ¡ä»¶ï¼Œç§°ä¸ºé€Ÿç‡æ¡ä»¶ï¼ˆrate conditionsï¼‰ï¼š \begin{equation} u_t(y,x)\ge 0 \text{ for all } y\neq x \text{, and }\sum_{y}u_t(y,x) =0 \label{eq:rate_cond} \end{equation} è¿™æ ·å°±æ˜¯è¯´ï¼Œ$u_t(x,x)&lt; 0$ï¼Œä¸”$u_t(x,x)=-\sum_{y\neq x}u_t(y,x)$ã€‚é€Ÿåº¦æ¡ä»¶çš„å­˜åœ¨æ˜¯ä¸ºäº†ä¿è¯å…¬å¼$\eqref{eq:transition_kernel}$ç®—å‡ºçš„è½¬ç§»æ ¸$p_{t+h\mid t}(\cdot\mid x)\ge0$ä¸”$\sum p_{t+h\mid t}(\cdot\mid x)=1$ã€‚ ç±»æ¯”Flow Matchingï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è¯´ï¼šå¦‚æœå­˜åœ¨$p_{t+h\mid t}$æ»¡è¶³å…¬å¼$\eqref{eq:transition_kernel}$ï¼Œ$p_{t+h\mid t}$çš„è¾¹ç¼˜åˆ†å¸ƒä¸º$p_t$ï¼Œåˆ™ç§°$u_t$ç”Ÿæˆäº†$p_t$ã€‚ ç”¨å…¬å¼$\eqref{eq:transition_kernel}$ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨Euleræ³•ï¼ˆç±»æ¯”æ‰©æ•£æ¨¡å‹å’ŒFlow Matchingé‡Œé¢ODEçš„è§£æ³•ï¼‰æ¥é‡‡æ ·ï¼Œå¦‚ä¸‹ï¼š \[\mathbb{P}(X_{t+h}=y\mid X_t)=\delta(y,X_t)+hu_t(y,X_t)\] ä½†æ˜¯è¯¥å¼å¼•å…¥äº†ä¸€ä¸ªåå·®ï¼Œå°±æ˜¯$o(h)$ã€‚å› ä¸ºè¿™æ˜¯ä¸€ä¸ªé«˜é˜¶å°é‡ï¼Œæ‰€ä»¥åªè¦$h$è¶³å¤Ÿå°ï¼Œé‚£ä¹ˆ$o(h)$å°±ä¼šè¶‹äº0ï¼Œè¿™å°±æ˜¯å¸Œæœ›Euleræ³•é‡‡æ ·å‡†ç¡®çš„æ¡ä»¶ï¼Œä½†æ˜¯è¿™æ ·é‡‡æ ·æ­¥éª¤å°±ä¼šå¾ˆå¤šã€‚ä¸€ç§ç¼“è§£è¿™ä¸ªé—®é¢˜çš„æ–¹æ³•æ˜¯ç”¨å¦‚ä¸‹çš„Euleræ³•ï¼š \[\mathbb{P}(X_{t+h}=y\mid X_t) =\begin{cases} \exp \left[hu_t(X_t,X_t)\right] \qquad \qquad\qquad\qquad\qquad y=X_t \\ \cfrac{u_t(y,X_t)}{\left|u_t(X_t,X_t) \right|}\left( 1 - \exp\left[hu_t(X_t,X_t)\right] \right) \qquad y\neq X_t \end{cases}\] æ¦‚ç‡è·¯å¾„å’ŒKolmogorovæ–¹ç¨‹ ç±»æ¯”è¿ç»­æƒ…å†µä¸‹çš„ä¸€è‡´æ€§æ–¹ç¨‹ï¼ˆContinuity Equationï¼‰ï¼ŒCTMCæ¨¡å‹çš„è¾¹ç¼˜æ¦‚ç‡$p_t$æ»¡è¶³Kolmogorovæ–¹ç¨‹ï¼š \begin{equation} \cfrac{\mathrm{d}}{\mathrm{d}t}p_t(y)=\sum_x u_t(y,x)p_t(x) \label{eq:Kolmogorov} \end{equation} ä¸‹é¢è¿™ä¸ªå®šç†æè¿°äº†ä¸Šå¼è¿™ç§çº¿æ€§ODEç³»ç»Ÿå”¯ä¸€è§£çš„å­˜åœ¨æ€§ï¼š å®šç†ï¼ˆçº¿æ€§ODEçš„è§£çš„å­˜åœ¨æ€§å’Œå”¯ä¸€æ€§ï¼‰ï¼šå¦‚æœ$u_t(y,x)$åœ¨$C([0,1))$ä¸­ï¼ˆå³åœ¨æ—¶é—´$t$ä¸Šè¿ç»­ï¼‰ï¼Œé‚£ä¹ˆå­˜åœ¨å”¯ä¸€çš„è§£$p_t(x)$æ»¡è¶³Kolmogorovæ–¹ç¨‹$\eqref{eq:Kolmogorov}$ï¼Œå…¶ä¸­ï¼Œ$t\in[0,1)$ï¼Œåˆå§‹çŠ¶æ€$p_0(x) = p(x)$ã€‚ å¯¹CTMCè€Œè¨€ï¼Œåœ¨$t\in[0,1)$åŒºé—´ï¼Œä¸éœ€è¦é¢å¤–çš„æ¡ä»¶ï¼Œå°±èƒ½å¤Ÿç¡®å®šè§£ä¸€å®šå­˜åœ¨ã€‚å…³äºè¯¥å®šç†çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯å¯ä»¥å‚è€ƒCoddington et al. (1956)3ä¸­çš„å®šç†5.1å’Œ5.2ã€‚ æ–¹ç¨‹$\eqref{eq:Kolmogorov}$å¯ä»¥åŒ–ä¸ºï¼š \[\begin{equation} \begin{aligned} \sum_x u_t(y,x)p_t(x) &amp;=\underbrace{\sum_{x\neq y} u_t(y,x)p_t(x)}_{è¾“å…¥é€šé‡}-\underbrace{\sum_{x\neq y}u_t(x,y)p_t(y)}_{è¾“å‡ºé€šé‡} \\ &amp;=-\sum_{x\neq y}\left[j_t(x,y)-j_t(y,x)\right] \\ \end{aligned} \end{equation}\] å…¶ä¸­ï¼Œ$j_t(y,x):=u_t(y,x)p_t(x)$ï¼Œç§°ä¸ºæ¦‚ç‡é€šé‡ï¼ˆprobability fluxï¼‰ã€‚ä¸Šå¼å¾ˆå¥½ç†è§£ï¼Œå°±æ˜¯æŠŠä»$x$è¾“å…¥åˆ°$y$çš„é€šé‡åˆ†æˆäº†ä»$x$è¾“å…¥åˆ°$y$çš„éƒ¨åˆ†å’Œä»$y$è¾“å‡ºåˆ°$x$çš„éƒ¨åˆ†ã€‚ å°†è¾“å‡ºé€šé‡è¶…å‡ºæ¥çš„éƒ¨åˆ†å®šä¹‰ä¸ºæ•£åº¦ï¼Œå³ \[\text{div}(u_t p_t)(y) =\sum_{x\neq y}\left[j_t(x,y)-j_t(y,x)\right]\] é‚£ä¹ˆKolmogorovæ–¹ç¨‹å°±å¯ä»¥è¡¨ç¤ºä¸ºï¼š \[\dot p_t(y)+\text{div}(u_t p_t)(y)=0\] è¿™å’Œè¿ç»­å‹Flow Matchingçš„ä¸€è‡´æ€§æ–¹ç¨‹ç»Ÿä¸€èµ·æ¥äº†ã€‚ ä»¥ä¸‹è¿˜æœ‰ä¸€ä¸ªç»“æœï¼Œæ˜¯åœ¨CTMC æ¡†æ¶ä¸­æ„å»ºæ¦‚ç‡è·¯å¾„å’Œé€Ÿåº¦çš„ä¸»è¦å·¥å…·ï¼š å®šç† ï¼ˆç¦»æ•£è´¨é‡å®ˆæ’ï¼ŒDiscrete Mass Conservationï¼‰ï¼š$u_t(y,x)$åœ¨$C([0,1))$ä¸­ï¼Œ$p_t(x)$åœ¨$C^1([0,1))$ä¸­ï¼ˆæˆ‘çš„ç†è§£æ˜¯ä¸€é˜¶å¯¼æ•°åœ¨æ—¶é—´$t$ä¸Šè¿ç»­ï¼‰ï¼Œåˆ™å¦‚ä¸‹ä¸¤ä¸ªç»“è®ºæ˜¯ç­‰ä»·çš„ï¼š åœ¨$t\in[0,1)$æ—¶ï¼Œ $p_t,u_t$æ»¡è¶³Kolmogorovæ–¹ç¨‹$\eqref{eq:Kolmogorov}$ï¼Œ$u_t$æ»¡è¶³é€Ÿç‡æ¡ä»¶$\eqref{eq:rate_cond}$ã€‚ åœ¨$t\in[0,1)$æ—¶ï¼Œ$u_t$ç”Ÿæˆï¼ˆç”¨å‰æ–‡çš„æœ¯è¯­ï¼‰äº†$p_t$ã€‚ è¯¥å®šç†çš„è¯æ˜åœ¨1çš„appendix A.1.ã€‚ ä¿æ¦‚ç‡é€Ÿç‡ï¼ˆProbability preserving velocitiesï¼‰ å¦‚æœ$u_t(y,x)$ç”Ÿæˆäº†æ¦‚ç‡è·¯å¾„$p_t(x)$ï¼Œæˆ‘ä»¬æ„é€ ä¸€ä¸ªæ–°çš„é€Ÿç‡ï¼š \[\tilde u_t(y,x) = u_t(y,x) + v_t(y,x)\] åªè¦$v_t(y,x)$æ»¡è¶³é€Ÿç‡æ¡ä»¶ä¸” \[\sum_x v_t(y,x)p_t(x) = 0\] é‚£ä¹ˆ$\tilde u_t(y,x)$è¿˜èƒ½Kolmogorovæ–¹ç¨‹ï¼š \[\sum_x \tilde u_t(y,x)p_t(x) = \sum_x u_t(y,x)p_t(x) = \dot p_t(y)\] é‚£ä¹ˆ$\tilde u_t(y,x)$è¿˜èƒ½ç”Ÿæˆ$p_t(x)$ã€‚è¿™ä¸ªç»“è®ºåœ¨ç¦»æ•£å‹Flow Matchingé‡Œé¢éå¸¸é‡è¦ã€‚ Lipman Y, Havasi M, Holderrieth P, et al. Flow Matching Guide and Code[J]. arXiv preprint arXiv:2412.06264, 2024.Â &#8617;Â &#8617;2 Gat I, Remez T, Shaul N, et al. Discrete flow matching[J]. arXiv preprint arXiv:2407.15595, 2024.Â &#8617; Coddington E A, Levinson N, Teichmann T. Theory of ordinary differential equations[J]. 1956.Â &#8617;]]></summary></entry></feed>